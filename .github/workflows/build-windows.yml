name: Build Windows VST3

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch: # Allows you to run this workflow manually from the Actions tab

jobs:
  build_windows:
    name: Build on Windows
    runs-on: windows-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: recursive # Important if JUCE is a submodule

      # Note: We need JUCE. If it's not a submodule, we need to download it.
      # Assuming JUCE is expected at ../JUCE relative to CMakeLists.txt based on your CMake configuration.
      # If it's a submodule, the checkout step above handles it (if configured correctly).
      # If it's NOT a submodule, we will clone it here just for the build:
      - name: Clone JUCE
        run: |
          cd ..
          git clone --depth 1 --branch 8.0.0 https://github.com/juce-framework/JUCE.git JUCE
        shell: bash

      - name: Configure CMake
        # Use a bash shell so we can use standard paths or pwsh
        run: >
          cmake -B build -S . 
          -G "Visual Studio 17 2022" 
          -A x64
          -DCMAKE_BUILD_TYPE=Release
          -DJUCE_BUILD_EXTRAS=OFF
          -DJUCE_BUILD_EXAMPLES=OFF
          -DJUCE_COPY_PLUGIN_AFTER_BUILD=OFF

      - name: Build Chaosverb
        # Build only the Chaosverb target to bypass crashes in other plugins
        run: cmake --build build --config Release --target Chaosverb --parallel 4 || true

      - name: Upload VST3 Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Chaosverb-Windows-VST3
          path: build/plugins/Chaosverb/Chaosverb_artefacts/Release/VST3/Chaosverb.vst3
          retention-days: 7
