# Parameter Specification — NBS DynaDrive

**CRITICAL CONTRACT: This specification is immutable during implementation.**
All parameter IDs, types, and ranges must remain unchanged across Stages 2–5.
Changes require explicit user approval and version increment.

**Generated by:** UI mockup finalization (v8-ui.yaml)
**Generated date:** 2026-02-27

---

## Total Parameter Count

**Total:** 22 parameters
- Slider (Float): 20
- Toggle (Bool): 2

---

## Parameter Definitions

### Saturation Section

#### drive
- **Type:** Float
- **Range:** 0.0 to 100.0
- **Default:** 20.0
- **Unit:** %
- **Skew Factor:** linear
- **UI Control:** Large rotary knob (52px), 270° arc, red accent (#c0392b)
- **DSP Usage:** Primary saturation input drive level. Controls how hard the signal hits the ADAA waveshaper.

#### even
- **Type:** Float
- **Range:** 0.0 to 100.0
- **Default:** 0.0
- **Unit:** %
- **Skew Factor:** linear
- **UI Control:** Medium rotary knob (36px), 270° arc, red accent (#c0392b)
- **DSP Usage:** Even harmonic content (2nd/4th order). Adds tube-like warmth and fullness.

#### odd
- **Type:** Float
- **Range:** 0.0 to 100.0
- **Default:** 0.0
- **Unit:** %
- **Skew Factor:** linear
- **UI Control:** Medium rotary knob (36px), 270° arc, red accent (#c0392b)
- **DSP Usage:** Odd harmonic content (3rd/5th order). Adds presence, edge, and transistor grit.

#### h_curve
- **Type:** Float
- **Range:** 0.0 to 100.0
- **Default:** 50.0
- **Unit:** %
- **Skew Factor:** linear
- **UI Control:** Medium rotary knob (38px), 270° arc, red accent. Value display shows "Soft" (0–25%), "Medium" (25–75%), "Hard" (75–100%).
- **DSP Usage:** Continuously variable saturation curve shape. Morphs waveshaping polynomial coefficients from soft-knee to hard-clipping. Must produce analytically differentiable curves for ADAA compatibility.

---

### Center Section

#### pre_post
- **Type:** Bool
- **Range:** false / true
- **Default:** false (DYN→SAT)
- **UI Control:** Pill-shaped toggle button (120x28px). false = blue "DYN→SAT", true = red "SAT→DYN". Use `WebToggleButtonRelay` + `WebToggleButtonParameterAttachment`.
- **DSP Usage:** Signal routing order. false = dynamics processes before saturation. true = saturation processes before dynamics. Critical character difference.

#### input
- **Type:** Float
- **Range:** -48.0 to 10.0
- **Default:** 0.0
- **Unit:** dB
- **Skew Factor:** linear
- **UI Control:** Small rotary knob (33px), 360° full-circle fill indicator, gray accent (#777777). 0 dB maps to mid-range fill.
- **DSP Usage:** Input gain before the processing chain.

#### mix
- **Type:** Float
- **Range:** 0.0 to 100.0
- **Default:** 100.0
- **Unit:** %
- **Skew Factor:** linear
- **UI Control:** Small rotary knob (33px), 360° full-circle fill indicator, gray accent. At 100% (default) the ring is fully lit. At 0% the ring is empty.
- **DSP Usage:** Dry/wet parallel blend. 100% = fully processed signal.

#### output
- **Type:** Float
- **Range:** -48.0 to 10.0
- **Default:** 0.0
- **Unit:** dB
- **Skew Factor:** linear
- **UI Control:** Small rotary knob (33px), 360° full-circle fill indicator, gray accent. 0 dB maps to mid-range fill.
- **DSP Usage:** Output / makeup gain after the processing chain.

#### sat_tilt_freq
- **Type:** Float
- **Range:** 100.0 to 10000.0
- **Default:** 1000.0
- **Unit:** Hz
- **Skew Factor:** logarithmic recommended (frequency parameter)
- **UI Control:** Small rotary knob (30px), 270° arc, red accent (#c0392b). Grouped under "POST-SAT TILT" label. Value displays as Hz or kHz.
- **DSP Usage:** Post-saturation tilt filter pivot frequency. Placed immediately after saturation stage in signal chain.

#### sat_tilt_slope
- **Type:** Float
- **Range:** -6.0 to 6.0
- **Default:** 0.0
- **Unit:** dB/oct
- **Skew Factor:** linear (bipolar)
- **UI Control:** Small rotary knob (30px), 270° arc, red accent (#c0392b). Grouped with sat_tilt_freq. Value shows sign (+/-).
- **DSP Usage:** Post-saturation tilt slope. 0 = flat/bypassed. Positive = bright (boost highs, cut lows). Negative = dark.

---

### Dynamics Section

#### dynamics
- **Type:** Float
- **Range:** 0.0 to 100.0
- **Default:** 30.0
- **Unit:** %
- **Skew Factor:** linear
- **UI Control:** Large rotary knob (52px), 270° arc, blue accent (#4a90d9)
- **DSP Usage:** Macro dynamics amount. Controls overall upward + downward compression depth. Interacts with the UP and DOWN knobs.

#### up
- **Type:** Float
- **Range:** 0.0 to 100.0
- **Default:** 0.0
- **Unit:** %
- **Skew Factor:** linear
- **UI Control:** Small rotary knob (33px), 270° arc, blue accent (#4a90d9)
- **DSP Usage:** Upward compression amount. Raises the floor of quiet signals without touching peaks. Adds energy, sustain, and density.

#### down
- **Type:** Float
- **Range:** 0.0 to 100.0
- **Default:** 50.0
- **Unit:** %
- **Skew Factor:** linear
- **UI Control:** Small rotary knob (33px), 270° arc, blue accent (#4a90d9)
- **DSP Usage:** Downward compression amount. Controls peak attenuation for glue and consistency.

---

### Advanced Panel — Dynamics Detail

#### threshold
- **Type:** Float
- **Range:** -40.0 to 0.0
- **Default:** -18.0
- **Unit:** dB
- **Skew Factor:** linear
- **UI Control:** Medium rotary knob (38px), 270° arc, blue accent. In advanced panel, centered in left column. Threshold marker visible on compressor curve display.
- **DSP Usage:** Compressor threshold. Sets the level above which downward compression begins and below which upward compression acts.

#### ratio
- **Type:** Float
- **Range:** 1.0 to 10.0
- **Default:** 4.0
- **Unit:** :1
- **Skew Factor:** linear
- **UI Control:** Medium rotary knob (38px), 270° arc, blue accent. In advanced panel, value shows as "X.X:1".
- **DSP Usage:** Compression ratio. Applied proportionally based on the DOWN knob amount.

#### attack_time
- **Type:** Float
- **Range:** 0.1 to 100.0
- **Default:** 10.0
- **Unit:** ms
- **Skew Factor:** logarithmic recommended (time parameter)
- **UI Control:** Medium rotary knob (38px), 270° arc, blue accent. In advanced panel. Value displays as "X ms".
- **DSP Usage:** Compressor attack time. Manual override of program-dependent auto attack.

#### release_time
- **Type:** Float
- **Range:** 10.0 to 1000.0
- **Default:** 100.0
- **Unit:** ms
- **Skew Factor:** logarithmic recommended (time parameter)
- **UI Control:** Medium rotary knob (38px), 270° arc, blue accent. In advanced panel. Value displays as "X ms".
- **DSP Usage:** Compressor release time. Manual override of program-dependent auto release.

---

### Advanced Panel — Post-Dynamics Tilt

#### dyn_tilt_freq
- **Type:** Float
- **Range:** 100.0 to 10000.0
- **Default:** 1000.0
- **Unit:** Hz
- **Skew Factor:** logarithmic recommended
- **UI Control:** Small rotary knob (32px), 270° arc, blue accent (#4a90d9). In advanced panel, centered in middle column under "Post-Dyn Tilt".
- **DSP Usage:** Post-dynamics tilt filter pivot frequency. Placed after dynamics stage in signal chain (after post-sat tilt).

#### dyn_tilt_slope
- **Type:** Float
- **Range:** -6.0 to 6.0
- **Default:** 0.0
- **Unit:** dB/oct
- **Skew Factor:** linear (bipolar)
- **UI Control:** Small rotary knob (32px), 270° arc, blue accent. In advanced panel, grouped with dyn_tilt_freq. Value shows sign (+/-).
- **DSP Usage:** Post-dynamics tilt slope. 0 = flat/bypassed. Final tonal shaping before output.

---

### Advanced Panel — M/S Processing

#### ms_enable
- **Type:** Bool
- **Range:** false / true
- **Default:** false (STEREO mode)
- **UI Control:** Small toggle button (72x22px). false = "STEREO" (dark), true = "M/S" (gray accent). Use `WebToggleButtonRelay` + `WebToggleButtonParameterAttachment`. MID/SIDE knobs visible only when true.
- **DSP Usage:** Enables mid/side matrix encoding. When active, saturation and dynamics process Mid and Side channels independently.

#### mid_drive
- **Type:** Float
- **Range:** 0.0 to 100.0
- **Default:** 50.0
- **Unit:** %
- **Skew Factor:** linear
- **UI Control:** Small rotary knob (32px), 270° arc, gray accent (#888888). In advanced M/S column, visible only when ms_enable is true.
- **DSP Usage:** Mid channel saturation drive (independent from main drive). Used when M/S mode active.

#### side_drive
- **Type:** Float
- **Range:** 0.0 to 100.0
- **Default:** 50.0
- **Unit:** %
- **Skew Factor:** linear
- **UI Control:** Small rotary knob (32px), 270° arc, gray accent (#888888). In advanced M/S column, visible only when ms_enable is true.
- **DSP Usage:** Side channel saturation drive (independent from main drive). Allows controlling stereo width character independently.

---

## Signal Chain Order

```
Input
  └─ [Input Gain]
      └─ [if pre_post == false (DYN→SAT):  Dynamics Engine]
          └─ Saturation Engine (ADAA)
              └─ Post-Saturation Tilt (sat_tilt_freq, sat_tilt_slope)
                  └─ [if pre_post == true (SAT→DYN):  Dynamics Engine]
                      └─ Post-Dynamics Tilt (dyn_tilt_freq, dyn_tilt_slope)
                          └─ [Mix blend with dry signal]
                              └─ [Output Gain]
                                  └─ Output
```

**Dynamics Engine** uses: dynamics, up, down, threshold, ratio, attack_time, release_time
**Saturation Engine** uses: drive, even, odd, h_curve, mid_drive (M/S), side_drive (M/S)
**M/S routing:** ms_enable activates mid/side matrix around saturation and dynamics stages

---

## APVTS Layout Reference (for PluginProcessor.cpp)

```cpp
juce::AudioProcessorValueTreeState::ParameterLayout createParameterLayout()
{
    std::vector<std::unique_ptr<juce::RangedAudioParameter>> params;

    // Saturation
    params.push_back(std::make_unique<juce::AudioParameterFloat>("drive",          "Drive",          0.0f,   100.0f,  20.0f));
    params.push_back(std::make_unique<juce::AudioParameterFloat>("even",           "Even",           0.0f,   100.0f,  0.0f));
    params.push_back(std::make_unique<juce::AudioParameterFloat>("odd",            "Odd",            0.0f,   100.0f,  0.0f));
    params.push_back(std::make_unique<juce::AudioParameterFloat>("h_curve",        "Shape",          0.0f,   100.0f,  50.0f));

    // Center
    params.push_back(std::make_unique<juce::AudioParameterBool> ("pre_post",       "Signal Flow",    false));
    params.push_back(std::make_unique<juce::AudioParameterFloat>("input",          "Input",          -48.0f, 10.0f,   0.0f));
    params.push_back(std::make_unique<juce::AudioParameterFloat>("mix",            "Mix",            0.0f,   100.0f,  100.0f));
    params.push_back(std::make_unique<juce::AudioParameterFloat>("output",         "Output",         -48.0f, 10.0f,   0.0f));
    params.push_back(std::make_unique<juce::AudioParameterFloat>("sat_tilt_freq",  "Sat Tilt Freq",  100.0f, 10000.0f,1000.0f));
    params.push_back(std::make_unique<juce::AudioParameterFloat>("sat_tilt_slope", "Sat Tilt Slope", -6.0f,  6.0f,    0.0f));

    // Dynamics
    params.push_back(std::make_unique<juce::AudioParameterFloat>("dynamics",       "Dynamics",       0.0f,   100.0f,  30.0f));
    params.push_back(std::make_unique<juce::AudioParameterFloat>("up",             "Up",             0.0f,   100.0f,  0.0f));
    params.push_back(std::make_unique<juce::AudioParameterFloat>("down",           "Down",           0.0f,   100.0f,  50.0f));

    // Advanced — Dynamics Detail
    params.push_back(std::make_unique<juce::AudioParameterFloat>("threshold",      "Threshold",      -40.0f, 0.0f,    -18.0f));
    params.push_back(std::make_unique<juce::AudioParameterFloat>("ratio",          "Ratio",          1.0f,   10.0f,   4.0f));
    params.push_back(std::make_unique<juce::AudioParameterFloat>("attack_time",    "Attack",         0.1f,   100.0f,  10.0f));
    params.push_back(std::make_unique<juce::AudioParameterFloat>("release_time",   "Release",        10.0f,  1000.0f, 100.0f));

    // Advanced — Post-Dyn Tilt
    params.push_back(std::make_unique<juce::AudioParameterFloat>("dyn_tilt_freq",  "Dyn Tilt Freq",  100.0f, 10000.0f,1000.0f));
    params.push_back(std::make_unique<juce::AudioParameterFloat>("dyn_tilt_slope", "Dyn Tilt Slope", -6.0f,  6.0f,    0.0f));

    // Advanced — M/S
    params.push_back(std::make_unique<juce::AudioParameterBool> ("ms_enable",      "M/S Enable",     false));
    params.push_back(std::make_unique<juce::AudioParameterFloat>("mid_drive",      "Mid Drive",      0.0f,   100.0f,  50.0f));
    params.push_back(std::make_unique<juce::AudioParameterFloat>("side_drive",     "Side Drive",     0.0f,   100.0f,  50.0f));

    return { params.begin(), params.end() };
}
```

---

## Notes

- Parameter IDs with underscores (`h_curve`, `sat_tilt_freq`, `attack_time`, etc.) must match EXACTLY in HTML `data-param` attributes, relay constructors, and APVTS layout.
- `pre_post` and `ms_enable` are `AudioParameterBool` — use `WebToggleButtonRelay` and `WebToggleButtonParameterAttachment`, NOT slider variants.
- `sat_tilt_freq` and `dyn_tilt_freq` benefit from logarithmic skew factor for perceptually linear knob feel.
- `attack_time` and `release_time` benefit from logarithmic skew factor for perceptually linear knob feel.
- `mid_drive` and `side_drive` are visible in UI only when `ms_enable == true` (controlled via CSS opacity in the WebView).
