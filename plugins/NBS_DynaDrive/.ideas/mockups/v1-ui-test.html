<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NBS DynaDrive — UI Mockup v1</title>
  <style>
    /* ══════════════════════════════════════════════════
       WEBVIEW CRITICAL CONSTRAINTS
       ══════════════════════════════════════════════════ */
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    *, *::before, *::after {
      box-sizing: border-box;
    }

    body {
      user-select: none;
      -webkit-user-select: none;
      cursor: default;
      overflow: hidden;
      background: #141414;
      color: #e8e8e8;
      font-family: 'Inter', 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      font-size: 12px;
    }

    /* ══════════════════════════════════════════════════
       PLUGIN SHELL
       ══════════════════════════════════════════════════ */
    #plugin-shell {
      width: 740px;
      background: #141414;
      position: relative;
      overflow: hidden;
      border: 1px solid #2a2a2a;
    }

    /* ══════════════════════════════════════════════════
       MAIN PANEL
       ══════════════════════════════════════════════════ */
    #main-panel {
      width: 740px;
      height: 370px;
      position: relative;
      display: flex;
      flex-direction: row;
      align-items: stretch;
    }

    /* Subtle top-edge highlight line (hardware feel) */
    #main-panel::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent 0%, #3a3a3a 20%, #444 50%, #3a3a3a 80%, transparent 100%);
      z-index: 10;
    }

    /* ══════════════════════════════════════════════════
       SECTIONS
       ══════════════════════════════════════════════════ */
    .section {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 22px;
    }

    .section-label {
      position: absolute;
      top: 14px;
      left: 18px;
      font-size: 9.5px;
      font-weight: 700;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      opacity: 0.9;
    }

    /* Vertical divider between sections */
    .section-divider {
      width: 1px;
      background: linear-gradient(180deg, transparent 0%, #2a2a2a 15%, #2a2a2a 85%, transparent 100%);
      margin: 0;
      flex-shrink: 0;
      align-self: stretch;
    }

    /* ── SATURATION (left) ───────────────────────── */
    #section-sat {
      width: 218px;
      background: linear-gradient(180deg, #1a1212 0%, #161414 40%, #141414 100%);
    }

    /* ── CENTER ──────────────────────────────────── */
    #section-center {
      width: 246px;
      background: #141414;
      justify-content: flex-start;
    }

    /* ── DYNAMICS (right) ────────────────────────── */
    #section-dyn {
      width: 178px;
      background: linear-gradient(180deg, #121218 0%, #141416 40%, #141414 100%);
    }

    /* ── METERS (far right) ──────────────────────── */
    #section-meters {
      width: 97px;
      background: #141414;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 16px;
      padding-bottom: 16px;
      border-left: 1px solid #222;
    }

    /* ══════════════════════════════════════════════════
       KNOB SYSTEM
       ══════════════════════════════════════════════════ */
    .knob-group {
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      cursor: ns-resize;
    }

    .knob-group:hover .knob-arc-ring {
      filter: drop-shadow(0 0 4px var(--arc-color, #888));
    }

    .knob-svg {
      display: block;
      pointer-events: none;
    }

    .knob-label {
      font-size: 10.5px;
      font-weight: 600;
      letter-spacing: 0.13em;
      text-transform: uppercase;
      color: #777;
      margin-top: 5px;
      text-align: center;
    }

    .knob-value {
      font-size: 9.5px;
      font-weight: 400;
      color: #4a4a4a;
      margin-top: 2px;
      text-align: center;
      min-height: 13px;
      font-variant-numeric: tabular-nums;
    }

    /* ══════════════════════════════════════════════════
       SATURATION SECTION LAYOUT
       ══════════════════════════════════════════════════ */
    #sat-drive-row {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 14px;
      width: 100%;
    }

    #sat-sub-row {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin-top: 20px;
      width: 100%;
    }

    /* ══════════════════════════════════════════════════
       CENTER SECTION LAYOUT
       ══════════════════════════════════════════════════ */
    #center-name {
      font-size: 17px;
      font-weight: 600;
      letter-spacing: 0.07em;
      color: #e0e0e0;
      text-align: center;
      margin-top: 18px;
      margin-bottom: 4px;
      width: 100%;
      text-shadow: 0 0 12px rgba(255,255,255,0.06);
    }

    #center-tagline {
      font-size: 9px;
      color: #3a3a3a;
      letter-spacing: 0.12em;
      text-align: center;
      text-transform: uppercase;
      margin-bottom: 18px;
    }

    #pre-post-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 10px;
      margin-bottom: 4px;
    }

    #pre-post-label {
      font-size: 9px;
      color: #444;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      margin-bottom: 7px;
    }

    #pre-post-toggle {
      width: 120px;
      height: 34px;
      border-radius: 4px;
      border: 1px solid #2e2e2e;
      background: #111;
      display: flex;
      align-items: center;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      transition: border-color 0.2s;
    }

    #pre-post-toggle:hover {
      border-color: #3a3a3a;
    }

    .ppt-half {
      flex: 1;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 9.5px;
      font-weight: 700;
      letter-spacing: 0.08em;
      color: #333;
      transition: color 0.2s, background 0.2s;
      z-index: 1;
    }

    .ppt-half.active {
      color: #4a90d9;
      background: rgba(74, 144, 217, 0.12);
    }

    #ppt-slider {
      position: absolute;
      top: 3px;
      bottom: 3px;
      width: calc(50% - 3px);
      left: 3px;
      border-radius: 3px;
      background: rgba(74, 144, 217, 0.15);
      border: 1px solid rgba(74, 144, 217, 0.3);
      transition: left 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }

    #center-knobs-row {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin-top: 22px;
      width: 100%;
    }

    #adaa-badge {
      margin-top: auto;
      margin-bottom: 18px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .adaa-pill {
      background: #1a1a1a;
      border: 1px solid #2a2a2a;
      border-radius: 3px;
      padding: 3px 10px;
      font-size: 8.5px;
      color: #3a3a3a;
      letter-spacing: 0.18em;
      text-transform: uppercase;
    }

    /* ══════════════════════════════════════════════════
       DYNAMICS SECTION LAYOUT
       ══════════════════════════════════════════════════ */
    #dyn-drive-row {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 14px;
      width: 100%;
    }

    #dyn-sub-row {
      display: flex;
      justify-content: center;
      gap: 26px;
      margin-top: 20px;
      width: 100%;
    }

    /* ══════════════════════════════════════════════════
       LED METER SYSTEM
       ══════════════════════════════════════════════════ */
    .meter-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      flex: 1;
    }

    .meter-pair {
      display: flex;
      gap: 10px;
      flex: 1;
      align-items: flex-start;
      padding-top: 8px;
    }

    .led-column {
      display: flex;
      flex-direction: column-reverse;
      gap: 2px;
    }

    .led-column.gr-column {
      flex-direction: column;
    }

    .led-seg {
      width: 14px;
      height: 11px;
      border-radius: 2px;
      background: #202020;
      box-shadow: inset 0 1px 0 rgba(0,0,0,0.5);
      transition: background 0.06s, box-shadow 0.06s;
    }

    .led-seg.active-green {
      background: #1a8a3a;
      box-shadow: 0 0 4px rgba(34,197,94,0.7), inset 0 1px 0 rgba(255,255,255,0.15);
    }

    .led-seg.active-green-hi {
      background: #22c55e;
      box-shadow: 0 0 6px rgba(34,197,94,0.9), inset 0 1px 0 rgba(255,255,255,0.2);
    }

    .led-seg.active-amber {
      background: #d97706;
      box-shadow: 0 0 6px rgba(245,158,11,0.85), inset 0 1px 0 rgba(255,255,255,0.15);
    }

    .led-seg.active-red {
      background: #dc2626;
      box-shadow: 0 0 6px rgba(239,68,68,0.9), inset 0 1px 0 rgba(255,255,255,0.1);
    }

    .led-seg.active-orange {
      background: #ea580c;
      box-shadow: 0 0 5px rgba(249,115,22,0.8), inset 0 1px 0 rgba(255,255,255,0.1);
    }

    .meter-labels-row {
      display: flex;
      gap: 10px;
    }

    .meter-label {
      width: 14px;
      text-align: center;
      font-size: 9.5px;
      font-weight: 700;
      letter-spacing: 0.08em;
      color: #555;
      text-transform: uppercase;
    }

    /* ══════════════════════════════════════════════════
       ADVANCED TOGGLE BAR
       ══════════════════════════════════════════════════ */
    #advanced-bar {
      width: 740px;
      height: 30px;
      background: #141414;
      border-top: 1px solid #232323;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      gap: 8px;
      transition: background 0.15s;
    }

    #advanced-bar:hover {
      background: #191919;
    }

    #advanced-bar-text {
      font-size: 9px;
      font-weight: 700;
      letter-spacing: 0.2em;
      color: #3d3d3d;
      text-transform: uppercase;
      transition: color 0.15s;
    }

    #advanced-bar:hover #advanced-bar-text {
      color: #555;
    }

    #advanced-chevron {
      font-size: 10px;
      color: #3d3d3d;
      transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94), color 0.15s;
    }

    #advanced-bar:hover #advanced-chevron {
      color: #555;
    }

    .advanced-expanded #advanced-chevron {
      transform: rotate(180deg);
    }

    /* ══════════════════════════════════════════════════
       ADVANCED PANEL
       ══════════════════════════════════════════════════ */
    #advanced-panel {
      width: 740px;
      height: 0;
      overflow: hidden;
      background: #131313;
      border-top: 1px solid #222;
      transition: height 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }

    #advanced-panel.open {
      height: 220px;
    }

    #advanced-inner {
      width: 740px;
      height: 220px;
      display: flex;
      flex-direction: row;
      padding: 0;
    }

    /* ── ADVANCED LEFT — Dynamics detail ─────── */
    #adv-dynamics {
      width: 380px;
      padding: 20px 24px 20px 28px;
      border-right: 1px solid #222;
    }

    .adv-section-label {
      font-size: 9px;
      font-weight: 700;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      margin-bottom: 16px;
    }

    .adv-knobs-row {
      display: flex;
      gap: 18px;
      align-items: flex-start;
    }

    .adv-note {
      font-size: 9px;
      color: #3a3a3a;
      font-style: italic;
      margin-top: 14px;
      letter-spacing: 0.04em;
    }

    /* ── ADVANCED RIGHT — Saturation + M/S ─── */
    #adv-sat-ms {
      flex: 1;
      padding: 20px 24px 20px 28px;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .adv-sub-label {
      font-size: 8.5px;
      font-weight: 700;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      margin-bottom: 10px;
    }

    /* H-Curve button group */
    #h-curve-group {
      display: flex;
      gap: 0;
      border: 1px solid #2a2a2a;
      border-radius: 4px;
      overflow: hidden;
      width: fit-content;
    }

    .hcurve-btn {
      padding: 5px 14px;
      font-size: 10px;
      font-weight: 600;
      letter-spacing: 0.06em;
      color: #444;
      background: #181818;
      cursor: pointer;
      border-right: 1px solid #2a2a2a;
      transition: color 0.15s, background 0.15s;
    }

    .hcurve-btn:last-child {
      border-right: none;
    }

    .hcurve-btn.active {
      color: #c0392b;
      background: rgba(192,57,43,0.12);
    }

    .hcurve-btn:hover:not(.active) {
      color: #666;
      background: #1e1e1e;
    }

    /* M/S Toggle */
    #ms-toggle-btn {
      padding: 5px 16px;
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 0.1em;
      color: #444;
      background: #181818;
      border: 1px solid #2a2a2a;
      border-radius: 4px;
      cursor: pointer;
      transition: color 0.15s, background 0.15s, border-color 0.15s;
      width: fit-content;
    }

    #ms-toggle-btn.active {
      color: #888;
      background: rgba(136,136,136,0.12);
      border-color: #555;
    }

    /* M/S knobs (hidden until enabled) */
    #ms-knobs-row {
      display: flex;
      gap: 20px;
      margin-top: 8px;
      opacity: 0;
      transition: opacity 0.25s;
      pointer-events: none;
    }

    #ms-knobs-row.visible {
      opacity: 1;
      pointer-events: all;
    }

    /* ══════════════════════════════════════════════════
       SECTION ACCENT LINES
       ══════════════════════════════════════════════════ */
    .section-accent-line {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      border-radius: 0 0 1px 1px;
    }

    #section-sat .section-accent-line {
      background: linear-gradient(90deg, transparent 0%, #c0392b 40%, #c0392b 60%, transparent 100%);
      opacity: 0.5;
    }

    #section-dyn .section-accent-line {
      background: linear-gradient(90deg, transparent 0%, #4a90d9 40%, #4a90d9 60%, transparent 100%);
      opacity: 0.5;
    }

    /* ══════════════════════════════════════════════════
       DEMO / METER ANIMATION
       ══════════════════════════════════════════════════ */
    @keyframes meterPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
  </style>
</head>
<body>

<div id="plugin-shell">

  <!-- ══════════════════════════════════════════
       MAIN PANEL
       ══════════════════════════════════════════ -->
  <div id="main-panel">

    <!-- SATURATION SECTION -->
    <div class="section" id="section-sat">
      <div class="section-accent-line"></div>
      <span class="section-label" style="color: #c0392b;">Saturation</span>

      <div id="sat-drive-row">
        <div class="knob-group" data-id="drive" data-min="0" data-max="100" data-default="20" data-unit="%" style="--arc-color: #c0392b;">
          <!-- SVG knob rendered by JS -->
        </div>
      </div>

      <div id="sat-sub-row">
        <div class="knob-group" data-id="even" data-min="0" data-max="100" data-default="0" data-unit="%" style="--arc-color: #c0392b;">
        </div>
        <div class="knob-group" data-id="odd" data-min="0" data-max="100" data-default="0" data-unit="%" style="--arc-color: #c0392b;">
        </div>
      </div>
    </div>

    <div class="section-divider"></div>

    <!-- CENTER SECTION -->
    <div class="section" id="section-center">
      <div id="center-name">NBS DynaDrive</div>
      <div id="center-tagline">ADAA Anti-Aliasing</div>

      <!-- Pre/Post Toggle -->
      <div id="pre-post-container">
        <div id="pre-post-label">Signal Flow</div>
        <div id="pre-post-toggle" onclick="togglePrePost()" title="Click to switch signal flow">
          <div id="ppt-slider"></div>
          <div class="ppt-half active" id="ppt-left">DYN→SAT</div>
          <div class="ppt-half" id="ppt-right">SAT→DYN</div>
        </div>
      </div>

      <!-- Mix + Output knobs -->
      <div id="center-knobs-row">
        <div class="knob-group" data-id="mix" data-min="0" data-max="100" data-default="100" data-unit="%" data-size="35" style="--arc-color: #666;">
        </div>
        <div class="knob-group" data-id="output" data-min="-12" data-max="12" data-default="0" data-unit="dB" data-size="35" style="--arc-color: #666;">
        </div>
      </div>

      <div id="adaa-badge">
        <div class="adaa-pill">Zero Aliasing · No Oversampling</div>
      </div>
    </div>

    <div class="section-divider"></div>

    <!-- DYNAMICS SECTION -->
    <div class="section" id="section-dyn">
      <div class="section-accent-line"></div>
      <span class="section-label" style="color: #4a90d9;">Dynamics</span>

      <div id="dyn-drive-row">
        <div class="knob-group" data-id="dynamics" data-min="0" data-max="100" data-default="30" data-unit="%" style="--arc-color: #4a90d9;">
        </div>
      </div>

      <div id="dyn-sub-row">
        <div class="knob-group" data-id="up" data-min="0" data-max="100" data-default="0" data-unit="%" data-size="35" style="--arc-color: #4a90d9;">
        </div>
        <div class="knob-group" data-id="down" data-min="0" data-max="100" data-default="50" data-unit="%" data-size="35" style="--arc-color: #4a90d9;">
        </div>
      </div>
    </div>

    <div class="section-divider"></div>

    <!-- METERS -->
    <div id="section-meters">
      <div class="meter-pair">
        <div class="meter-wrapper">
          <div class="led-column" id="meter-in"></div>
        </div>
        <div class="meter-wrapper">
          <div class="led-column gr-column" id="meter-gr"></div>
        </div>
      </div>
      <div class="meter-labels-row" style="margin-top: 8px;">
        <div class="meter-label">IN</div>
        <div class="meter-label">GR</div>
      </div>
    </div>

  </div><!-- /#main-panel -->

  <!-- ══════════════════════════════════════════
       ADVANCED TOGGLE BAR
       ══════════════════════════════════════════ -->
  <div id="advanced-bar" onclick="toggleAdvanced()">
    <span id="advanced-bar-text">Advanced</span>
    <span id="advanced-chevron">▾</span>
  </div>

  <!-- ══════════════════════════════════════════
       ADVANCED PANEL
       ══════════════════════════════════════════ -->
  <div id="advanced-panel">
    <div id="advanced-inner">

      <!-- LEFT: Dynamics Detail -->
      <div id="adv-dynamics">
        <div class="adv-section-label" style="color: #4a90d9;">Dynamics Detail</div>
        <div class="adv-knobs-row">
          <div class="knob-group" data-id="threshold" data-min="-40" data-max="0" data-default="-18" data-unit="dB" data-size="38" style="--arc-color: #4a90d9;"></div>
          <div class="knob-group" data-id="ratio" data-min="1" data-max="10" data-default="4" data-unit=":1" data-size="38" style="--arc-color: #4a90d9;"></div>
          <div class="knob-group" data-id="attack_time" data-min="0.1" data-max="100" data-default="-1" data-unit="ms" data-size="38" data-auto="true" style="--arc-color: #4a90d9;"></div>
          <div class="knob-group" data-id="release_time" data-min="10" data-max="1000" data-default="-1" data-unit="ms" data-size="38" data-auto="true" style="--arc-color: #4a90d9;"></div>
        </div>
        <div class="adv-note">* Auto: program-dependent time constants</div>
      </div>

      <!-- RIGHT: Saturation + M/S -->
      <div id="adv-sat-ms">

        <div>
          <div class="adv-sub-label" style="color: #c0392b;">Harmonic Curve</div>
          <div id="h-curve-group">
            <div class="hcurve-btn" onclick="setHCurve(0)">Soft</div>
            <div class="hcurve-btn active" onclick="setHCurve(1)">Medium</div>
            <div class="hcurve-btn" onclick="setHCurve(2)">Hard</div>
          </div>
        </div>

        <div>
          <div class="adv-sub-label" style="color: #888;">M/S Routing</div>
          <div id="ms-toggle-btn" onclick="toggleMS()">STEREO</div>
          <div id="ms-knobs-row">
            <div class="knob-group" data-id="mid_drive" data-min="0" data-max="100" data-default="50" data-unit="%" data-size="32" style="--arc-color: #888;"></div>
            <div class="knob-group" data-id="side_drive" data-min="0" data-max="100" data-default="50" data-unit="%" data-size="32" style="--arc-color: #888;"></div>
          </div>
        </div>

      </div>

    </div>
  </div>

</div><!-- /#plugin-shell -->

<script>
  "use strict";

  // ══════════════════════════════════════════════
  // MOCK JUCE BACKEND
  // ══════════════════════════════════════════════
  const paramValues = {};
  const paramListeners = {};

  window.Juce = {
    getSliderState: (id) => {
      const norm = id in paramValues ? paramValues[id] : 0.5;
      return {
        normalisedValue: norm,
        valueChangedEvent: {
          addListener: (fn) => {
            paramListeners[id] = paramListeners[id] || [];
            paramListeners[id].push(fn);
          }
        },
        setNormalisedValue: (v) => {
          paramValues[id] = Math.max(0, Math.min(1, v));
          if (paramListeners[id]) paramListeners[id].forEach(fn => fn(paramValues[id]));
          console.log(`[JUCE] ${id} = ${paramValues[id].toFixed(4)} (normalised)`);
        }
      };
    },
    getToggleState: (id) => {
      return {
        value: false,
        valueChangedEvent: { addListener: (fn) => {} }
      };
    },
    getComboBoxState: (id) => {
      return {
        selectedId: 0,
        valueChangedEvent: { addListener: (fn) => {} }
      };
    }
  };

  // Disable context menu
  document.addEventListener("contextmenu", (e) => {
    e.preventDefault();
    return false;
  });

  // ══════════════════════════════════════════════
  // KNOB SYSTEM
  // ══════════════════════════════════════════════
  const KNOB_LABELS = {
    drive: "DRIVE",
    even: "EVEN",
    odd: "ODD",
    mix: "MIX",
    output: "OUTPUT",
    dynamics: "DYNAMICS",
    up: "UP",
    down: "DOWN",
    threshold: "THRESH",
    ratio: "RATIO",
    attack_time: "ATTACK",
    release_time: "RELEASE",
    mid_drive: "MID",
    side_drive: "SIDE"
  };

  // Large knobs for drive and dynamics
  const LARGE_KNOBS = new Set(["drive", "dynamics"]);
  const MEDIUM_KNOBS = new Set(["even", "odd", "threshold", "ratio", "attack_time", "release_time"]);

  function getKnobSize(el) {
    const explicit = el.dataset.size;
    if (explicit) return parseInt(explicit);
    const id = el.dataset.id;
    if (LARGE_KNOBS.has(id)) return 56;
    if (MEDIUM_KNOBS.has(id)) return 42;
    return 36;
  }

  function buildKnobSVG(size, normalised, arcColor) {
    const cx = size / 2;
    const cy = size / 2;
    const outerR = size / 2 - 2;
    const innerR = size / 2 - 7;
    const arcR = outerR - 1;

    // Arc sweep: 270 degrees, start at 135deg (bottom-left), end at 45deg (bottom-right)
    const startAngleDeg = 135;
    const sweepDeg = 270;
    const angleDeg = startAngleDeg + sweepDeg * normalised;

    function polarToXY(angleDeg, r) {
      const rad = (angleDeg - 90) * Math.PI / 180;
      return {
        x: cx + r * Math.cos(rad),
        y: cy + r * Math.sin(rad)
      };
    }

    // Background arc track
    const trackStart = polarToXY(startAngleDeg, arcR);
    const trackEnd = polarToXY(startAngleDeg + sweepDeg, arcR);

    // Active arc
    const arcStart = polarToXY(startAngleDeg, arcR);
    const arcEnd = polarToXY(angleDeg, arcR);
    const largeArc = sweepDeg * normalised > 180 ? 1 : 0;

    // Dot indicator at knob face center, pointing toward value angle
    const dotAngleDeg = angleDeg;
    const dotR = innerR * 0.52;
    const dot = polarToXY(dotAngleDeg, dotR);

    // Tick marker at value position (small outer pip)
    const tickOuter = polarToXY(angleDeg, outerR + 3);
    const tickInner = polarToXY(angleDeg, outerR - 1);

    const svg = `<svg class="knob-svg" width="${size}" height="${size}" viewBox="0 0 ${size} ${size}">
      <!-- Outer rim -->
      <circle cx="${cx}" cy="${cy}" r="${outerR}" fill="none" stroke="#222" stroke-width="1.5"/>

      <!-- Background arc track -->
      <path d="M ${trackStart.x} ${trackStart.y} A ${arcR} ${arcR} 0 1 1 ${trackEnd.x} ${trackEnd.y}"
            fill="none" stroke="#252525" stroke-width="2.5" stroke-linecap="round"/>

      <!-- Active arc -->
      ${normalised > 0.001 ? `<path d="M ${arcStart.x} ${arcStart.y} A ${arcR} ${arcR} 0 ${largeArc} 1 ${arcEnd.x} ${arcEnd.y}"
            fill="none" stroke="${arcColor}" stroke-width="2.5" stroke-linecap="round"
            class="knob-arc-ring"
            filter="url(#glow-${arcColor.replace('#','')})" />` : ''}

      <!-- Defs for glow -->
      <defs>
        <filter id="glow-${arcColor.replace('#','')}" x="-50%" y="-50%" width="200%" height="200%">
          <feGaussianBlur stdDeviation="1.5" result="coloredBlur"/>
          <feMerge>
            <feMergeNode in="coloredBlur"/>
            <feMergeNode in="SourceGraphic"/>
          </feMerge>
        </filter>
      </defs>

      <!-- Knob body -->
      <circle cx="${cx}" cy="${cy}" r="${innerR}" fill="url(#knob-grad-${size})"
              stroke="#1c1c1c" stroke-width="1"/>
      <defs>
        <radialGradient id="knob-grad-${size}" cx="45%" cy="35%" r="65%">
          <stop offset="0%" stop-color="#282828"/>
          <stop offset="100%" stop-color="#101010"/>
        </radialGradient>
      </defs>

      <!-- Knob indicator line -->
      <line x1="${cx}" y1="${cy}" x2="${dot.x}" y2="${dot.y}"
            stroke="#e8e8e8" stroke-width="1.5" stroke-linecap="round" opacity="0.7"/>

      <!-- Tick pip on outer ring -->
      <line x1="${tickInner.x}" y1="${tickInner.y}" x2="${tickOuter.x}" y2="${tickOuter.y}"
            stroke="${arcColor}" stroke-width="1.5" stroke-linecap="round" opacity="0.6"/>
    </svg>`;

    return svg;
  }

  function formatValue(el, v) {
    const id = el.dataset.id;
    const unit = el.dataset.unit || "";
    const isAuto = el.dataset.auto === "true";

    // Show "Auto" for attack/release at default
    if (isAuto && (id === "attack_time" || id === "release_time")) {
      const min = parseFloat(el.dataset.min);
      const max = parseFloat(el.dataset.max);
      const raw = min + (max - min) * v;
      if (v < 0.01) return "Auto";
      return raw.toFixed(1) + " " + unit;
    }

    const min = parseFloat(el.dataset.min);
    const max = parseFloat(el.dataset.max);
    const raw = min + (max - min) * v;

    if (unit === "%") return Math.round(raw) + "%";
    if (unit === "dB") return (raw >= 0 ? "+" : "") + raw.toFixed(1) + " dB";
    if (unit === ":1") return raw.toFixed(1) + ":1";
    if (unit === "ms") {
      if (raw < 10) return raw.toFixed(1) + " ms";
      return Math.round(raw) + " ms";
    }
    return raw.toFixed(1) + " " + unit;
  }

  function getNormalised(el) {
    const id = el.dataset.id;
    return id in paramValues ? paramValues[id] : getDefaultNorm(el);
  }

  function getDefaultNorm(el) {
    const defaultVal = parseFloat(el.dataset.default);
    const min = parseFloat(el.dataset.min);
    const max = parseFloat(el.dataset.max);
    if (defaultVal < min) return 0; // "Auto" sentinel
    return (defaultVal - min) / (max - min);
  }

  function getArcColor(el) {
    return getComputedStyle(el).getPropertyValue('--arc-color').trim() || '#888';
  }

  function renderKnob(el) {
    const size = getKnobSize(el);
    const norm = getNormalised(el);
    const arcColor = getArcColor(el);
    const id = el.dataset.id;
    const label = KNOB_LABELS[id] || id.toUpperCase();
    const valueStr = formatValue(el, norm);

    el.innerHTML = buildKnobSVG(size, norm, arcColor) +
      `<div class="knob-label">${label}</div>` +
      `<div class="knob-value" id="val-${id}">${valueStr}</div>`;
  }

  // ── Knob Drag Interaction ────────────────────
  let activeKnob = null;
  let dragStartY = 0;
  let dragStartNorm = 0;

  document.addEventListener("mousedown", (e) => {
    const knob = e.target.closest(".knob-group");
    if (!knob) return;
    activeKnob = knob;
    dragStartY = e.clientY;
    dragStartNorm = getNormalised(knob);
    document.body.style.cursor = "ns-resize";
    e.preventDefault();
  });

  document.addEventListener("mousemove", (e) => {
    if (!activeKnob) return;
    const deltaY = dragStartY - e.clientY;
    const sensitivity = e.shiftKey ? 0.002 : 0.008;
    const newNorm = Math.max(0, Math.min(1, dragStartNorm + deltaY * sensitivity));
    const id = activeKnob.dataset.id;
    paramValues[id] = newNorm;
    renderKnob(activeKnob);
    console.log(`[DRAG] ${id} = ${formatValue(activeKnob, newNorm)}`);
  });

  document.addEventListener("mouseup", () => {
    activeKnob = null;
    document.body.style.cursor = "default";
  });

  // Double-click to reset
  document.addEventListener("dblclick", (e) => {
    const knob = e.target.closest(".knob-group");
    if (!knob) return;
    const id = knob.dataset.id;
    delete paramValues[id];
    renderKnob(knob);
    console.log(`[RESET] ${id} → default`);
  });

  // ══════════════════════════════════════════════
  // PRE/POST TOGGLE
  // ══════════════════════════════════════════════
  let prePostState = 0; // 0 = DYN→SAT, 1 = SAT→DYN

  function togglePrePost() {
    prePostState = prePostState === 0 ? 1 : 0;
    const slider = document.getElementById("ppt-slider");
    const left = document.getElementById("ppt-left");
    const right = document.getElementById("ppt-right");

    if (prePostState === 0) {
      slider.style.left = "3px";
      left.classList.add("active");
      right.classList.remove("active");
    } else {
      slider.style.left = "calc(50% + 0px)";
      left.classList.remove("active");
      right.classList.add("active");
    }
    console.log(`[TOGGLE] pre_post = ${prePostState === 0 ? "DYN→SAT" : "SAT→DYN"}`);
  }

  // Fix ppt-slider right half position on init
  document.addEventListener("DOMContentLoaded", () => {
    const toggle = document.getElementById("pre-post-toggle");
    const slider = document.getElementById("ppt-slider");
    slider.style.width = "calc(50% - 6px)";
  });

  // ══════════════════════════════════════════════
  // ADVANCED PANEL
  // ══════════════════════════════════════════════
  let advancedOpen = false;

  function toggleAdvanced() {
    advancedOpen = !advancedOpen;
    const panel = document.getElementById("advanced-panel");
    const bar = document.getElementById("advanced-bar");

    if (advancedOpen) {
      panel.classList.add("open");
      bar.classList.add("advanced-expanded");
      document.getElementById("plugin-shell").style.height = "620px";
    } else {
      panel.classList.remove("open");
      bar.classList.remove("advanced-expanded");
      document.getElementById("plugin-shell").style.height = "";
    }
    console.log(`[ADVANCED] panel ${advancedOpen ? "opened" : "closed"}`);
  }

  // ══════════════════════════════════════════════
  // H-CURVE SELECTOR
  // ══════════════════════════════════════════════
  const hCurveLabels = ["Soft", "Medium", "Hard"];
  let hCurveState = 1;

  function setHCurve(idx) {
    hCurveState = idx;
    document.querySelectorAll(".hcurve-btn").forEach((btn, i) => {
      btn.classList.toggle("active", i === idx);
    });
    console.log(`[H-CURVE] ${hCurveLabels[idx]}`);
  }

  // ══════════════════════════════════════════════
  // M/S TOGGLE
  // ══════════════════════════════════════════════
  let msEnabled = false;

  function toggleMS() {
    msEnabled = !msEnabled;
    const btn = document.getElementById("ms-toggle-btn");
    const row = document.getElementById("ms-knobs-row");

    btn.textContent = msEnabled ? "M/S" : "STEREO";
    btn.classList.toggle("active", msEnabled);
    row.classList.toggle("visible", msEnabled);
    console.log(`[M/S] ${msEnabled ? "enabled" : "disabled"}`);
  }

  // ══════════════════════════════════════════════
  // LED METER SYSTEM
  // ══════════════════════════════════════════════
  const SEG_COUNT = 20;

  function buildMeterColumn(id, isGR) {
    const col = document.getElementById(id);
    col.innerHTML = "";
    for (let i = 0; i < SEG_COUNT; i++) {
      const seg = document.createElement("div");
      seg.className = "led-seg";
      seg.dataset.index = i;
      col.appendChild(seg);
    }
  }

  function updateInputMeter(level) {
    // level: 0.0 = -60dB, 1.0 = 0dB (clipping)
    const col = document.getElementById("meter-in");
    const segs = col.querySelectorAll(".led-seg");
    const lit = Math.round(level * SEG_COUNT);

    segs.forEach((seg, i) => {
      seg.className = "led-seg";
      if (i < lit) {
        if (i >= 18) seg.classList.add("active-red");
        else if (i >= 14) seg.classList.add("active-amber");
        else if (i >= 7) seg.classList.add("active-green-hi");
        else seg.classList.add("active-green");
      }
    });
  }

  function updateGRMeter(reduction) {
    // reduction: 0.0 = no GR, 1.0 = max GR
    const col = document.getElementById("meter-gr");
    const segs = col.querySelectorAll(".led-seg");
    const lit = Math.round(reduction * SEG_COUNT);

    segs.forEach((seg, i) => {
      seg.className = "led-seg";
      if (i < lit) seg.classList.add("active-orange");
    });
  }

  // Demo animation: simulated signal
  let meterPhase = 0;
  function animateMeters() {
    meterPhase += 0.04;
    const baseLevel = 0.55 + 0.18 * Math.sin(meterPhase * 0.7);
    const transient = Math.max(0, Math.sin(meterPhase * 3.1)) * 0.22;
    const inputLevel = Math.min(1, baseLevel + transient);

    const dynNorm = getNormalised(document.querySelector('[data-id="down"]')) || 0.5;
    const grAmount = dynNorm * 0.35 * (0.5 + 0.5 * Math.abs(Math.sin(meterPhase * 0.9)));

    updateInputMeter(inputLevel);
    updateGRMeter(grAmount);
    requestAnimationFrame(animateMeters);
  }

  // ══════════════════════════════════════════════
  // INITIALISATION
  // ══════════════════════════════════════════════
  document.addEventListener("DOMContentLoaded", () => {
    // Build all knobs
    document.querySelectorAll(".knob-group").forEach(renderKnob);

    // Build meter columns
    buildMeterColumn("meter-in", false);
    buildMeterColumn("meter-gr", true);

    // Start meter animation
    animateMeters();

    console.log("[NBS DynaDrive] UI mockup v1 initialized");
    console.log("[Params] drive=20% | even=0% | odd=0% | dynamics=30% | mix=100% | output=0dB");
  });
</script>

</body>
</html>
