# DSP Architecture: TapeAge

**CRITICAL CONTRACT:** This specification is immutable during Stages 2-5 implementation. Stage 1 Planning cannot proceed without this file. Stage 4 (DSP) implements this exact architecture.

**Generated by:** Stage 0 Research
**Referenced by:** Stage 1 (Planning), Stage 4 (DSP Implementation)
**Purpose:** DSP specification defining processing components, signal flow, and JUCE module usage

## Core Components

### Oversampling Engine
- **JUCE Class:** `juce::dsp::Oversampling<float>`
- **Purpose:** 2x oversampling to reduce aliasing from nonlinear saturation
- **Parameters Affected:** drive (indirectly—enables clean saturation)
- **Configuration:** Factor of 2, using FIR filters for linear phase, maximum quality

### Saturation Waveshaper
- **JUCE Class:** `juce::dsp::WaveShaper<float>` with custom transfer function
- **Purpose:** Warm harmonic distortion—tape saturation character
- **Parameters Affected:** drive
- **Configuration:** Custom tanh-based transfer function with progressive curve (subtle at low drive, heavy at high drive)

### Wow/Flutter Modulator
- **JUCE Class:** Custom implementation using `juce::DelayLine<float>` with variable read position
- **Purpose:** Pitch modulation simulating tape speed variations
- **Parameters Affected:** age
- **Configuration:**
  - Delay line: 200ms buffer for pitch shifting
  - Primary LFO (wow): 1-2Hz for slow smooth drift
  - Secondary LFO (flutter): 6Hz at 20% depth for texture (v1.1.0)
  - Modulation depth scaled by age parameter
  - Smooth interpolation for artifact-free pitch shifts

### Dropout Generator
- **JUCE Class:** Custom implementation using random number generator
- **Purpose:** Occasional brief signal loss simulating tape damage
- **Parameters Affected:** age
- **Configuration:**
  - Probability: Scaled by age (0% = never, 100% = rare events every 5-10 seconds)
  - Duration: Random 50-150ms
  - Depth: Partial attenuation (multiply by 0.1-0.3), not complete muting
  - Smooth envelope to avoid clicks

### Tape Noise Generator
- **JUCE Class:** `juce::Random` for white noise generation with filtering
- **Purpose:** Subtle tape hiss texture
- **Parameters Affected:** age
- **Configuration:**
  - White noise source with lowpass filtering (simulates tape frequency response)
  - Level scaled by age parameter: -60dB at max (v1.1.0, was -80dB)
  - More present but still subtle vintage character

### High-Frequency Rolloff Filter (v1.1.0)
- **JUCE Class:** `juce::dsp::IIR::Filter<float>` (one-pole lowpass)
- **Purpose:** Simulates tape aging and head wear
- **Parameters Affected:** age
- **Configuration:**
  - Age 0%: 20kHz cutoff (transparent)
  - Age 100%: 8kHz cutoff (vintage tape character)
  - Exponential frequency mapping for musical response

### Dry/Wet Mixer
- **JUCE Class:** `juce::dsp::DryWetMixer<float>`
- **Purpose:** Equal-power crossfade between dry and processed signal
- **Parameters Affected:** mix
- **Configuration:** Equal-power curve to avoid center-dip volume loss

## Processing Chain

```
Input (Stereo)
  ↓
Dry/Wet Split (store dry signal)
  ↓
Oversampling Upsample (2x)
  ↓
Saturation Waveshaper ← drive parameter (0-100%)
  ↓
Oversampling Downsample
  ↓
Wow/Flutter Modulator ← age parameter (pitch modulation depth)
  ↓
High-Frequency Rolloff ← age parameter (cutoff frequency 20kHz→8kHz, v1.1.0)
  ↓
Dropout Generator ← age parameter (probability)
  ↓
Tape Noise Addition ← age parameter (subtle amplitude)
  ↓
Dry/Wet Mixer ← mix parameter (equal-power blend)
  ↓
Output (Stereo)
```

## Parameter Mapping

| Parameter ID | DSP Component | Usage Description |
|--------------|---------------|-------------------|
| drive | Saturation Waveshaper | Controls transfer function intensity: 0% = minimal saturation, 100% = heavy harmonic distortion |
| age | Wow/Flutter Modulator | Controls pitch modulation depth: 0% = no wobble, 100% = noticeable but musical warble |
| age | Dropout Generator | Controls dropout probability: 0% = no dropouts, 100% = rare occasional events |
| age | Tape Noise Generator | Controls noise amplitude: 0% = silent, 100% = subtle texture (never overwhelming) |
| mix | Dry/Wet Mixer | Crossfade ratio: 0% = fully dry, 100% = fully wet |

## Algorithm Details

**Saturation Transfer Function:**
- Implementation approach: Custom tanh-based waveshaper with progressive curve
- Drive mapping:
  - 0-30%: Very subtle (multiply by 1-2 before tanh, gentle harmonics)
  - 30-70%: Moderate warmth (multiply by 2-8 before tanh)
  - 70-100%: Heavy saturation (multiply by 8-20 before tanh)
- Key considerations: Smooth parameter transitions, no discontinuities, maintain DC offset at zero
- JUCE helpers available: `juce::dsp::WaveShaper::functionToUse = [](float x) { return tanh(gain * x); }`

**Wow/Flutter Modulation:**
- Implementation approach: Variable delay line with dual LFO-modulated read position
- Delay line size: 200ms at 96kHz (19200 samples) to allow pitch shifts
- LFO configuration:
  - Primary wow: 1-2Hz sine wave (slow smooth drift)
  - Secondary flutter: 6Hz sine wave at 20% depth for texture (v1.1.0)
  - Random phase offset per channel for stereo width
- Pitch shift range: ±25 cents at max age (v1.1.0, was ±10 cents - more noticeable warble)
- Key considerations: Use cubic/lagrange interpolation for smooth pitch shifts, avoid clicks
- JUCE helpers available: `juce::DelayLine<float, juce::DelayLineInterpolationTypes::Lagrange3rd>`

**Dropout Generation:**
- Implementation approach: Random event generation with probability based on age
- Event probability: Check every 100ms, probability = age * baseRate (tuned for 5-10 second intervals at max)
- Duration: Random between 50-150ms
- Envelope: Short attack/release (5-10ms) to avoid clicks
- Depth: Random attenuation factor 0.1-0.3 (70-90% reduction, not complete silence)
- Key considerations: Ensure stereo coherence (same dropout on L/R), smooth envelope, rare enough to not annoy

**Tape Noise:**
- Implementation approach: Filtered white noise mixed at subtle level
- Noise generation: `juce::Random::nextFloat() * 2.0f - 1.0f` for white noise
- Filtering: Simple one-pole lowpass ~8kHz (simulates tape frequency response)
- Amplitude scaling:
  - age = 0%: noise gain = 0 (silent)
  - age = 100%: noise gain = 0.001 (-60dB, v1.1.0 was -80dB)
- Key considerations: More present vintage character but still subtle

**High-Frequency Rolloff (v1.1.0):**
- Implementation approach: Age-dependent one-pole IIR lowpass filter
- Filter type: `juce::dsp::IIR::Filter<float>::makeFirstOrderLowPass()`
- Cutoff frequency mapping:
  - age = 0%: 20kHz (transparent, no effect)
  - age = 100%: 8kHz (vintage tape character, noticeable treble loss)
  - Exponential mapping: `cutoff = 20000 * pow(0.4, age)`
- Key considerations: Simulates tape head wear and high-frequency degradation, classic "old tape" sound

**Dry/Wet Mixing:**
- Implementation approach: Equal-power crossfade using `juce::dsp::DryWetMixer`
- Curve: sqrt() law for constant perceived loudness
- Key considerations: Latency compensation if needed (oversampling adds latency)
- JUCE helpers available: `juce::dsp::DryWetMixer<float>` handles equal-power automatically

## Special Considerations

**Thread Safety:**
- Parameter updates via APVTS atomic value tree state
- Saturation parameters read once per buffer in processBlock
- Wow/Flutter LFO phase state updated per sample (no thread hazards)
- Dropout generator uses per-buffer random check (safe)

**Performance:**
- Oversampling is CPU intensive—2x oversampling is acceptable for modern systems
- Delay line interpolation uses efficient Lagrange 3rd order (good quality/speed balance)
- Noise generation per-sample is cheap (single random call + filter)
- Overall: Moderate CPU usage, should run easily on modern systems

**Denormal Protection:**
- Use `juce::dsp::ScopedNoDenormals()` in processBlock
- Flush delay line to zero on parameter reset
- Add DC blocker if tanh generates offset (unlikely but check)

**Sample Rate Handling:**
- Oversampling adapts automatically to input sample rate
- Delay line size calculated as: `(int)(sampleRate * 0.2)` for 200ms buffer
- Wow/Flutter LFO frequencies are sample-rate independent (phase increment scaled)
- Dropout timing scaled by sample rate (100ms check interval)
- Tape noise filter coefficient recalculated on sample rate change

## Research References

**Context7 JUCE Documentation:**
- juce::dsp::Oversampling class (FIR/IIR options, latency compensation)
- juce::dsp::WaveShaper struct (custom transfer functions)
- juce::dsp::DryWetMixer (equal-power crossfading)
- juce::DelayLine with Lagrange3rd interpolation (pitch modulation)

**Professional Examples:**
- **Waves J37**: Tape speed options, saturation/wow/flutter controls, tape echo—benchmark for control layout
- **UAD Studer A800**: Gold standard tape emulation, cumulative analog character, tape formula options
- **UAD Ampex ATR-102**: Mastering-grade tape emulation, clean topology
- **FabFilter Saturn 2**: Multiband saturation with 28 distortion styles—reference for saturation character range
- **Valhalla Delay**: Tape mode modulation techniques—variable sample rate approach for natural wow/flutter

**Technical Resources:**
- Baby Audio blog: "Wow and Flutter: How Tape Modulation Can Elevate Your Sound" (2025)
  - Key insight: Wow <6Hz (slow drift), Flutter >6Hz (rapid variation)
  - Modulation via variable delay line with speed changes (not position changes)
- Signal Processing Stack Exchange: "Emulate tape delay"
  - Key insight: Fixed delay line with variable sampling rate (smooths transitions naturally)
- Music DSP Archive: "wow/flutter tape delay" discussion
  - Key insight: Random modulation with stereo offset for width
- Chow Tape Model (Stanford Music 420 project, 2019 DAFx paper)
  - Physical modeling approach for tape saturation (reference for algorithm complexity)

**Key Findings:**
- Saturation must be progressive—tanh is good base, scale input gain by drive parameter
- Oversampling essential to avoid aliasing from nonlinear saturation (2x minimum)
- Wow/flutter via delay line modulation (not real-time pitch shifting)—more authentic sound
- Dropout implementation: Simple random attenuation events with smooth envelope
- **Noise must be VERY subtle**—primary character comes from wow/flutter and saturation, not hiss
- Equal-power mixing prevents center-dip volume loss (JUCE's DryWetMixer handles this)
- Trade-offs: 2x oversampling adds latency but essential for clean saturation; delay line adds memory but enables authentic pitch modulation

