<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AngelGrain</title>

  <style>
    /* CRITICAL: WebView constraints */
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    *, *::before, *::after {
      box-sizing: border-box;
    }

    body {
      /* Native application feel */
      user-select: none;
      -webkit-user-select: none;
      cursor: default;
      overflow: hidden;

      /* Plugin container */
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(145deg, #d8e0e8, #c8d0d8);
      font-family: system-ui, -apple-system, sans-serif;
    }

    /* Plugin container */
    .container {
      width: 540px;
      height: 480px;
      position: relative;
    }

    /* Plugin surface */
    .plugin-surface {
      position: absolute;
      top: 20px;
      left: 20px;
      right: 20px;
      bottom: 20px;
      background: linear-gradient(145deg, #e8eef4, #dce4ec);
      border-radius: 16px;
      box-shadow:
        8px 8px 16px rgba(150, 160, 175, 0.5),
        -8px -8px 16px rgba(255, 255, 255, 0.8);
    }

    /* Plugin title */
    .plugin-title {
      position: absolute;
      top: 30px;
      left: 0;
      right: 0;
      text-align: center;
      font-size: 20px;
      font-weight: 300;
      letter-spacing: 4px;
      color: #5a6a7a;
      text-transform: uppercase;
    }

    /* Knob container */
    .knob-group {
      position: absolute;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }

    /* Top row positioning */
    .knob-delay { left: 50px; top: 80px; }
    .knob-grain { left: 210px; top: 80px; }
    .knob-feedback { left: 370px; top: 80px; }

    /* Bottom row positioning */
    .knob-chaos { left: 50px; top: 240px; }
    .knob-character { left: 210px; top: 240px; }
    .knob-mix { left: 370px; top: 240px; }

    /* Knob styles */
    .knob {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: linear-gradient(145deg, #e8eef4, #d0dce8);
      box-shadow:
        6px 6px 12px rgba(150, 160, 175, 0.5),
        -6px -6px 12px rgba(255, 255, 255, 0.8);
      position: relative;
      cursor: grab;
      transition: transform 50ms ease;
    }

    .knob:active {
      cursor: grabbing;
      transform: scale(0.95);
    }

    /* Knob inner circle */
    .knob-inner {
      position: absolute;
      top: 10px;
      left: 10px;
      right: 10px;
      bottom: 10px;
      border-radius: 50%;
      background: linear-gradient(145deg, #dce4ec, #d0dce8);
      box-shadow:
        inset 2px 2px 4px rgba(150, 160, 175, 0.3),
        inset -2px -2px 4px rgba(255, 255, 255, 0.5);
    }

    /* Knob indicator */
    .knob-indicator {
      position: absolute;
      top: 8px;
      left: 50%;
      width: 3px;
      height: 12px;
      background: #5a6a7a;
      border-radius: 2px;
      transform: translateX(-50%);
      transform-origin: center center;
    }

    /* Character knob glow effect */
    .knob-character .knob {
      box-shadow:
        6px 6px 12px rgba(150, 160, 175, 0.5),
        -6px -6px 12px rgba(255, 255, 255, 0.8),
        0 0 20px rgba(136, 176, 216, 0.4),
        0 0 40px rgba(136, 176, 216, 0.2);
    }

    /* Knob label */
    .knob-label {
      font-size: 11px;
      font-weight: 300;
      letter-spacing: 1px;
      color: #5a6a7a;
      text-transform: uppercase;
      margin-top: 4px;
    }

    /* Knob value display */
    .knob-value {
      font-size: 10px;
      font-weight: 400;
      color: #6a7a8a;
    }

    /* Toggle container */
    .toggle-group {
      position: absolute;
      left: 225px;
      top: 395px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }

    /* Toggle switch */
    .toggle {
      width: 50px;
      height: 26px;
      border-radius: 13px;
      background: linear-gradient(145deg, #d0dce8, #c0ccd8);
      box-shadow:
        inset 3px 3px 6px rgba(150, 160, 175, 0.4),
        inset -3px -3px 6px rgba(255, 255, 255, 0.6);
      position: relative;
      cursor: pointer;
      transition: background 200ms ease;
    }

    .toggle.active {
      background: linear-gradient(145deg, #a8c8e8, #88b0d8);
    }

    /* Toggle thumb */
    .toggle-thumb {
      position: absolute;
      top: 3px;
      left: 3px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #ffffff;
      box-shadow:
        2px 2px 4px rgba(150, 160, 175, 0.4),
        -1px -1px 2px rgba(255, 255, 255, 0.8);
      transition: transform 200ms ease;
    }

    .toggle.active .toggle-thumb {
      transform: translateX(24px);
    }

    /* Toggle label */
    .toggle-label {
      font-size: 11px;
      font-weight: 300;
      letter-spacing: 1px;
      color: #5a6a7a;
      text-transform: uppercase;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="plugin-surface">
      <div class="plugin-title">AngelGrain</div>

      <!-- Top Row -->
      <div class="knob-group knob-delay">
        <div class="knob" id="delayTimeKnob" data-param="delayTime">
          <div class="knob-inner">
            <div class="knob-indicator"></div>
          </div>
        </div>
        <div class="knob-label">DELAY</div>
        <div class="knob-value" id="delayTimeValue">500.0 ms</div>
      </div>

      <div class="knob-group knob-grain">
        <div class="knob" id="grainSizeKnob" data-param="grainSize">
          <div class="knob-inner">
            <div class="knob-indicator"></div>
          </div>
        </div>
        <div class="knob-label">GRAIN</div>
        <div class="knob-value" id="grainSizeValue">100.0 ms</div>
      </div>

      <div class="knob-group knob-feedback">
        <div class="knob" id="feedbackKnob" data-param="feedback">
          <div class="knob-inner">
            <div class="knob-indicator"></div>
          </div>
        </div>
        <div class="knob-label">FEEDBACK</div>
        <div class="knob-value" id="feedbackValue">30%</div>
      </div>

      <!-- Bottom Row -->
      <div class="knob-group knob-chaos">
        <div class="knob" id="chaosKnob" data-param="chaos">
          <div class="knob-inner">
            <div class="knob-indicator"></div>
          </div>
        </div>
        <div class="knob-label">CHAOS</div>
        <div class="knob-value" id="chaosValue">25%</div>
      </div>

      <div class="knob-group knob-character">
        <div class="knob" id="characterKnob" data-param="character">
          <div class="knob-inner">
            <div class="knob-indicator"></div>
          </div>
        </div>
        <div class="knob-label">CHARACTER</div>
        <div class="knob-value" id="characterValue">50%</div>
      </div>

      <div class="knob-group knob-mix">
        <div class="knob" id="mixKnob" data-param="mix">
          <div class="knob-inner">
            <div class="knob-indicator"></div>
          </div>
        </div>
        <div class="knob-label">MIX</div>
        <div class="knob-value" id="mixValue">50%</div>
      </div>

      <!-- Toggle -->
      <div class="toggle-group">
        <div class="toggle" id="tempoSyncToggle">
          <div class="toggle-thumb"></div>
        </div>
        <div class="toggle-label">SYNC</div>
      </div>
    </div>
  </div>

  <!-- JUCE Frontend Library (ES6 Module) -->
  <script type="module" src="./js/juce/index.js"></script>

  <script type="module">
    import { getSliderState, getToggleState } from './js/juce/index.js';

    // Disable context menu (REQUIRED for WebView)
    document.addEventListener("contextmenu", (e) => {
      e.preventDefault();
      return false;
    });

    // Disable drag (REQUIRED for WebView)
    document.addEventListener("dragstart", (e) => {
      e.preventDefault();
    });

    // Parameter configurations
    const paramConfigs = {
      delayTime: { min: 50, max: 2000, unit: ' ms', decimals: 1 },
      grainSize: { min: 5, max: 500, unit: ' ms', decimals: 1 },
      feedback: { min: 0, max: 100, unit: '%', decimals: 0 },
      chaos: { min: 0, max: 100, unit: '%', decimals: 0 },
      character: { min: 0, max: 100, unit: '%', decimals: 0 },
      mix: { min: 0, max: 100, unit: '%', decimals: 0 }
    };

    // Initialize knob bindings
    document.addEventListener("DOMContentLoaded", () => {
      const knobs = document.querySelectorAll('.knob');

      knobs.forEach(knob => {
        const paramId = knob.dataset.param;
        const config = paramConfigs[paramId];

        if (!config) {
          console.error(`No config for parameter: ${paramId}`);
          return;
        }

        // Get JUCE slider state
        const sliderState = getSliderState(paramId);
        if (!sliderState) {
          console.error(`Failed to get slider state for ${paramId}`);
          return;
        }

        const valueDisplay = document.getElementById(`${paramId}Value`);
        let isDragging = false;
        let lastY = 0;

        // Update knob visual from normalized value
        function updateKnobVisual() {
          const normalized = sliderState.getNormalisedValue();
          const degrees = -135 + (normalized * 270);
          knob.style.transform = `rotate(${degrees}deg)`;

          // Update value display
          if (valueDisplay) {
            const scaled = sliderState.getScaledValue();
            const displayValue = config.decimals === 0
              ? Math.round(scaled)
              : scaled.toFixed(config.decimals);
            valueDisplay.textContent = displayValue + config.unit;
          }
        }

        // PATTERN 15: valueChangedEvent receives NO parameters
        // Must call getNormalisedValue() inside callback
        sliderState.valueChangedEvent.addListener(() => {
          updateKnobVisual();
        });

        // Initial update
        updateKnobVisual();

        // PATTERN 16: Relative drag (lastY pattern)
        knob.addEventListener('mousedown', (e) => {
          isDragging = true;
          lastY = e.clientY;
          sliderState.sliderDragStarted();
          e.preventDefault();
        });

        document.addEventListener('mousemove', (e) => {
          if (!isDragging) return;

          // Calculate delta since LAST frame (not start)
          const deltaY = lastY - e.clientY;
          lastY = e.clientY;

          // Convert to normalized change
          const sensitivity = 0.005; // Adjust for feel
          const currentNorm = sliderState.getNormalisedValue();
          const newNorm = Math.max(0, Math.min(1, currentNorm + deltaY * sensitivity));

          sliderState.setNormalisedValue(newNorm);
        });

        document.addEventListener('mouseup', () => {
          if (isDragging) {
            isDragging = false;
            sliderState.sliderDragEnded();
          }
        });

        // Scroll wheel support
        knob.addEventListener('wheel', (e) => {
          e.preventDefault();
          const delta = e.deltaY > 0 ? -0.02 : 0.02;
          const currentNorm = sliderState.getNormalisedValue();
          const newNorm = Math.max(0, Math.min(1, currentNorm + delta));
          sliderState.setNormalisedValue(newNorm);
        });
      });

      // Toggle binding (tempoSync)
      const toggle = document.getElementById('tempoSyncToggle');

      // PATTERN 19: Use getToggleState for boolean parameters
      const toggleState = getToggleState('tempoSync');
      if (!toggleState) {
        console.error('Failed to get toggle state for tempoSync');
        return;
      }

      function updateToggleVisual() {
        const isActive = toggleState.getValue();
        toggle.classList.toggle('active', isActive);
      }

      // PATTERN 15: valueChangedEvent receives NO parameters
      toggleState.valueChangedEvent.addListener(() => {
        updateToggleVisual();
      });

      // Initial update
      updateToggleVisual();

      toggle.addEventListener('click', () => {
        const currentValue = toggleState.getValue();
        toggleState.setValue(!currentValue);
      });
    });
  </script>
</body>
</html>
