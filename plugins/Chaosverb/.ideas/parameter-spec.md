# Parameter Specification: Chaosverb

**CRITICAL CONTRACT:** This specification is immutable during implementation.
Changing parameter IDs, types, or counts after Stage 2 (Shell) will break APVTS
state and require a full rebuild. Do not modify without explicit user approval.

**Generated by:** UI mockup finalization (ui-mockup skill, v1)
**Generated date:** 2026-02-27
**Source mockup:** v1-ui.yaml (finalized: true)
**Draft validated:** Yes — parameter-spec-draft.md matched mockup exactly (22/22 parameters)

---

## Total Parameter Count

**Total: 22 parameters**
- 12 Float parameters (audio controls)
- 10 Bool parameters (mutation locks)

---

## Parameter Definitions

### Float Parameters (Audio Controls)

#### topology
- **JUCE ID:** `topology`
- **Type:** Float
- **Range:** 0.0 to 100.0
- **Default:** 50.0
- **Unit:** (none — continuous abstract value)
- **Skew Factor:** linear (no skew — full range is uniformly meaningful)
- **UI Control:** Rotary knob, SPACE section, top-left position
- **Section:** SPACE — accent color #00d4ff (electric cyan)
- **Lockable:** Yes — lock ID: `topologyLock`
- **DSP Usage:** Controls the FDN feedback matrix structure. Continuously morphs between physically impossible topological configurations of delay path cross-coupling. No discrete presets — every value is a unique topology state.

#### decay
- **JUCE ID:** `decay`
- **Type:** Float
- **Range:** 0.1 to 60.0 seconds
- **Default:** 4.0
- **Unit:** s
- **Skew Factor:** Logarithmic recommended (0.3–0.4) — most useful range is 0.5–10s
- **UI Control:** Rotary knob, SPACE section, top-right position
- **Section:** SPACE — accent color #00d4ff (electric cyan)
- **Lockable:** Yes — lock ID: `decayLock`
- **DSP Usage:** Controls FDN feedback gain coefficient. Governs length of reverb tail. At 30–60s produces near-infinite sustain. Maps to per-delay-line feedback scalar in the FDN matrix.

#### preDelay
- **JUCE ID:** `preDelay`
- **Type:** Float
- **Range:** 0.0 to 250.0 milliseconds
- **Default:** 10.0
- **Unit:** ms
- **Skew Factor:** linear (0–250ms is uniformly useful)
- **UI Control:** Rotary knob, SPACE section, bottom-left position
- **Section:** SPACE — accent color #00d4ff (electric cyan)
- **Lockable:** Yes — lock ID: `preDelayLock`
- **DSP Usage:** Simple delay line inserted before FDN input. Delays reverb onset. At 0ms: immediate onset. At 250ms: noticeable separation between dry signal and reverb tail.

#### density
- **JUCE ID:** `density`
- **Type:** Float
- **Range:** 0.0 to 100.0
- **Default:** 60.0
- **Unit:** %
- **Skew Factor:** linear
- **UI Control:** Rotary knob, SPACE section, bottom-right position
- **Section:** SPACE — accent color #00d4ff (electric cyan)
- **Lockable:** Yes — lock ID: `densityLock`
- **DSP Usage:** Controls diffusion and echo density in the reverb tail. Low values (0–20%) = sparse, discrete reflections with audible individual echoes. High values (80–100%) = infinite wash with no discrete reflections. Implemented via allpass diffuser chains before the FDN input stage.

#### spectralTilt
- **JUCE ID:** `spectralTilt`
- **Type:** Float
- **Range:** -100.0 to 100.0
- **Default:** 0.0
- **Unit:** (none — bipolar abstract value)
- **Skew Factor:** linear (bipolar, center = neutral)
- **UI Control:** Rotary knob, SPECTRAL section, top position
- **Section:** SPECTRAL — accent color #00d4ff (electric cyan)
- **Lockable:** Yes — lock ID: `spectralTiltLock`
- **DSP Usage:** Controls per-band independent decay scaling. Center (0) = neutral, all frequencies decay at same rate. Negative values = lows outlast highs (physically plausible). Positive values = highs outlast lows (physically impossible, the defining feature). Implemented as frequency-dependent feedback gain modifiers on individual FDN delay lines.

#### resonance
- **JUCE ID:** `resonance`
- **Type:** Float
- **Range:** 0.0 to 100.0
- **Default:** 0.0
- **Unit:** %
- **Skew Factor:** linear
- **UI Control:** Rotary knob, SPECTRAL section, bottom position
- **Section:** SPECTRAL — accent color #00d4ff (electric cyan)
- **Lockable:** Yes — lock ID: `resonanceLock`
- **DSP Usage:** Injects narrow resonant feedback peaks into the reverb tail. Certain frequencies accumulate energy and sustain impossibly long — beyond what any physical space allows. Implemented as narrow bandpass feedback loops within the FDN. CRITICAL: requires hard stability limiting (max resonance gain clamp) to prevent runaway feedback.

#### modRate
- **JUCE ID:** `modRate`
- **Type:** Float
- **Range:** 0.01 to 10.0 Hz
- **Default:** 0.3
- **Unit:** Hz
- **Skew Factor:** Logarithmic recommended (0.3) — 0.01–1Hz is primary range, up to 10Hz is extreme
- **UI Control:** Rotary knob, MOTION section, top position
- **Section:** MOTION — accent color #9b59b6 (void purple)
- **Lockable:** Yes — lock ID: `modRateLock`
- **DSP Usage:** Controls LFO speed applied independently to individual FDN delay line lengths. Creates pitch warping and time distortion in the reverb tail. Unlike standard chorus modulation, each delay line is modulated at a different phase offset of the same rate LFO.

#### modDepth
- **JUCE ID:** `modDepth`
- **Type:** Float
- **Range:** 0.0 to 100.0
- **Default:** 20.0
- **Unit:** %
- **Skew Factor:** linear
- **UI Control:** Rotary knob, MOTION section, bottom position
- **Section:** MOTION — accent color #9b59b6 (void purple)
- **Lockable:** Yes — lock ID: `modDepthLock`
- **DSP Usage:** Amount of delay line length modulation. At low values (0–20%): subtle shimmer. At high values (80–100%): pronounced pitch instability, flanging, and time-stretching artifacts in the reflection tail.

#### mutationInterval
- **JUCE ID:** `mutationInterval`
- **Type:** Float
- **Range:** 5.0 to 600.0 seconds
- **Default:** 30.0
- **Unit:** s
- **Skew Factor:** linear (user wants direct second/minute control)
- **UI Control:** Horizontal slider, MUTATION section, top position
- **Section:** MUTATION — accent color #888888 (neutral gray)
- **Lockable:** No (mutation timing is always user-controlled, never randomized)
- **DSP Usage:** Timer interval between mutation events. Controls internal timer thread that fires the global chaos randomization event. At 5s: rapid continuous evolution. At 600s (10 min): slow, contemplative mutation cycle. Display format: seconds below 60s, "Xm Ys" above 60s.

#### crossfadeSpeed
- **JUCE ID:** `crossfadeSpeed`
- **Type:** Float
- **Range:** 0.0 to 500.0 milliseconds
- **Default:** 100.0
- **Unit:** ms
- **Skew Factor:** linear
- **UI Control:** Horizontal slider, MUTATION section, bottom position
- **Section:** MUTATION — accent color #888888 (neutral gray)
- **Lockable:** No (crossfade timing is always user-controlled, never randomized)
- **DSP Usage:** Duration of wet signal crossfade between current FDN state (FDN-A) and new randomized FDN state (FDN-B) at each mutation event. At 0ms: instant cut — glitchy, harsh (intentional feature). At 500ms: half-second dissolve. Requires two parallel FDN instances running simultaneously during crossfade, with complementary wet gain ramps (A fades out, B fades in).

#### width
- **JUCE ID:** `width`
- **Type:** Float
- **Range:** 0.0 to 200.0
- **Default:** 100.0
- **Unit:** %
- **Skew Factor:** linear
- **UI Control:** Rotary knob, OUTPUT section, left position
- **Section:** OUTPUT — accent color #888888 (neutral gray)
- **Lockable:** Yes — lock ID: `widthLock`
- **DSP Usage:** Stereo spread of the wet reverb signal. 0% = mono wet (M only, no S). 100% = normal stereo output from FDN. 200% = exaggerated mid/side expansion. Implemented via M/S processing on the FDN wet output before dry/wet mixing.

#### mix
- **JUCE ID:** `mix`
- **Type:** Float
- **Range:** 0.0 to 100.0
- **Default:** 50.0
- **Unit:** %
- **Skew Factor:** linear
- **UI Control:** Rotary knob, OUTPUT section, right position
- **Section:** OUTPUT — accent color #888888 (neutral gray)
- **Lockable:** Yes — lock ID: `mixLock`
- **DSP Usage:** Dry/wet balance between unprocessed input signal and FDN reverb output. 0% = fully dry. 100% = fully wet. Mixed via complementary gain: dry = cos(mix * PI/2), wet = sin(mix * PI/2) for equal-power crossfade. Applied after width processing.

---

### Bool Parameters (Mutation Lock Controls)

All lock parameters share these properties:
- **Type:** Bool
- **Default:** false (unlocked — parameter participates in mutation)
- **UI Control:** Knob overlay toggle (double-click or right-click on parent knob)
- **Visual when locked:** Solid 360-degree glowing ring in section accent color
- **Visual when unlocked:** Standard 270-degree arc track (no ring)
- **DSP Usage:** When true, the corresponding audio parameter is excluded from the
  chaos randomization event at each mutation cycle. Value is preserved exactly as
  the user set it. The mutation system reads all lock states before generating
  new random values.

#### topologyLock
- **JUCE ID:** `topologyLock`
- **Locks parameter:** `topology`

#### decayLock
- **JUCE ID:** `decayLock`
- **Locks parameter:** `decay`

#### preDelayLock
- **JUCE ID:** `preDelayLock`
- **Locks parameter:** `preDelay`

#### densityLock
- **JUCE ID:** `densityLock`
- **Locks parameter:** `density`

#### spectralTiltLock
- **JUCE ID:** `spectralTiltLock`
- **Locks parameter:** `spectralTilt`

#### resonanceLock
- **JUCE ID:** `resonanceLock`
- **Locks parameter:** `resonance`

#### modRateLock
- **JUCE ID:** `modRateLock`
- **Locks parameter:** `modRate`

#### modDepthLock
- **JUCE ID:** `modDepthLock`
- **Locks parameter:** `modDepth`

#### widthLock
- **JUCE ID:** `widthLock`
- **Locks parameter:** `width`

#### mixLock
- **JUCE ID:** `mixLock`
- **Locks parameter:** `mix`

---

## APVTS Parameter Layout (Implementation Order)

Parameters MUST be added to APVTS in this exact order during Stage 2 (Shell):

```cpp
// Stage 2 Shell — PluginProcessor.cpp
// APVTS layout — 22 parameters in declaration order

// Float parameters (12)
layout.add(std::make_unique<juce::AudioParameterFloat>(
    "topology", "Topology",
    juce::NormalisableRange<float>(0.0f, 100.0f, 0.0f, 1.0f), 50.0f));

layout.add(std::make_unique<juce::AudioParameterFloat>(
    "decay", "Decay",
    juce::NormalisableRange<float>(0.1f, 60.0f, 0.0f, 0.35f), 4.0f));

layout.add(std::make_unique<juce::AudioParameterFloat>(
    "preDelay", "Pre-Delay",
    juce::NormalisableRange<float>(0.0f, 250.0f, 0.0f, 1.0f), 10.0f));

layout.add(std::make_unique<juce::AudioParameterFloat>(
    "density", "Density",
    juce::NormalisableRange<float>(0.0f, 100.0f, 0.0f, 1.0f), 60.0f));

layout.add(std::make_unique<juce::AudioParameterFloat>(
    "spectralTilt", "Spectral Tilt",
    juce::NormalisableRange<float>(-100.0f, 100.0f, 0.0f, 1.0f), 0.0f));

layout.add(std::make_unique<juce::AudioParameterFloat>(
    "resonance", "Resonance",
    juce::NormalisableRange<float>(0.0f, 100.0f, 0.0f, 1.0f), 0.0f));

layout.add(std::make_unique<juce::AudioParameterFloat>(
    "modRate", "Mod Rate",
    juce::NormalisableRange<float>(0.01f, 10.0f, 0.0f, 0.35f), 0.3f));

layout.add(std::make_unique<juce::AudioParameterFloat>(
    "modDepth", "Mod Depth",
    juce::NormalisableRange<float>(0.0f, 100.0f, 0.0f, 1.0f), 20.0f));

layout.add(std::make_unique<juce::AudioParameterFloat>(
    "mutationInterval", "Mutation Interval",
    juce::NormalisableRange<float>(5.0f, 600.0f, 0.0f, 1.0f), 30.0f));

layout.add(std::make_unique<juce::AudioParameterFloat>(
    "crossfadeSpeed", "Crossfade Speed",
    juce::NormalisableRange<float>(0.0f, 500.0f, 0.0f, 1.0f), 100.0f));

layout.add(std::make_unique<juce::AudioParameterFloat>(
    "width", "Width",
    juce::NormalisableRange<float>(0.0f, 200.0f, 0.0f, 1.0f), 100.0f));

layout.add(std::make_unique<juce::AudioParameterFloat>(
    "mix", "Mix",
    juce::NormalisableRange<float>(0.0f, 100.0f, 0.0f, 1.0f), 50.0f));

// Bool parameters — mutation locks (10)
layout.add(std::make_unique<juce::AudioParameterBool>("topologyLock",    "Topology Lock",    false));
layout.add(std::make_unique<juce::AudioParameterBool>("decayLock",       "Decay Lock",       false));
layout.add(std::make_unique<juce::AudioParameterBool>("preDelayLock",    "Pre-Delay Lock",   false));
layout.add(std::make_unique<juce::AudioParameterBool>("densityLock",     "Density Lock",     false));
layout.add(std::make_unique<juce::AudioParameterBool>("spectralTiltLock","Spectral Tilt Lock",false));
layout.add(std::make_unique<juce::AudioParameterBool>("resonanceLock",   "Resonance Lock",   false));
layout.add(std::make_unique<juce::AudioParameterBool>("modRateLock",     "Mod Rate Lock",    false));
layout.add(std::make_unique<juce::AudioParameterBool>("modDepthLock",    "Mod Depth Lock",   false));
layout.add(std::make_unique<juce::AudioParameterBool>("widthLock",       "Width Lock",       false));
layout.add(std::make_unique<juce::AudioParameterBool>("mixLock",         "Mix Lock",         false));
```

---

## WebView Relay Types (Stage 3 Reference)

| JUCE ID | Parameter Type | Relay Type | Attachment Type |
|---|---|---|---|
| topology | Float | WebSliderRelay | WebSliderParameterAttachment |
| decay | Float | WebSliderRelay | WebSliderParameterAttachment |
| preDelay | Float | WebSliderRelay | WebSliderParameterAttachment |
| density | Float | WebSliderRelay | WebSliderParameterAttachment |
| spectralTilt | Float | WebSliderRelay | WebSliderParameterAttachment |
| resonance | Float | WebSliderRelay | WebSliderParameterAttachment |
| modRate | Float | WebSliderRelay | WebSliderParameterAttachment |
| modDepth | Float | WebSliderRelay | WebSliderParameterAttachment |
| mutationInterval | Float | WebSliderRelay | WebSliderParameterAttachment |
| crossfadeSpeed | Float | WebSliderRelay | WebSliderParameterAttachment |
| width | Float | WebSliderRelay | WebSliderParameterAttachment |
| mix | Float | WebSliderRelay | WebSliderParameterAttachment |
| topologyLock | Bool | WebToggleButtonRelay | WebToggleButtonParameterAttachment |
| decayLock | Bool | WebToggleButtonRelay | WebToggleButtonParameterAttachment |
| preDelayLock | Bool | WebToggleButtonRelay | WebToggleButtonParameterAttachment |
| densityLock | Bool | WebToggleButtonRelay | WebToggleButtonParameterAttachment |
| spectralTiltLock | Bool | WebToggleButtonRelay | WebToggleButtonParameterAttachment |
| resonanceLock | Bool | WebToggleButtonRelay | WebToggleButtonParameterAttachment |
| modRateLock | Bool | WebToggleButtonRelay | WebToggleButtonParameterAttachment |
| modDepthLock | Bool | WebToggleButtonRelay | WebToggleButtonParameterAttachment |
| widthLock | Bool | WebToggleButtonRelay | WebToggleButtonParameterAttachment |
| mixLock | Bool | WebToggleButtonRelay | WebToggleButtonParameterAttachment |

**Note:** mutationInterval and crossfadeSpeed use WebSliderRelay even though displayed as
horizontal sliders in the UI. The relay type maps to APVTS parameter type (Float), not to
the visual control type (hslider vs knob).

---

## JavaScript API Mapping (Stage 3 Reference)

```javascript
// Float parameters — use getSliderState()
import { getSliderState, getToggleState } from './js/juce/index.js';

const topologyState       = getSliderState("topology");
const decayState          = getSliderState("decay");
const preDelayState       = getSliderState("preDelay");
const densityState        = getSliderState("density");
const spectralTiltState   = getSliderState("spectralTilt");
const resonanceState      = getSliderState("resonance");
const modRateState        = getSliderState("modRate");
const modDepthState       = getSliderState("modDepth");
const mutationIntervalState = getSliderState("mutationInterval");
const crossfadeSpeedState = getSliderState("crossfadeSpeed");
const widthState          = getSliderState("width");
const mixState            = getSliderState("mix");

// Bool parameters — use getToggleState() (Pattern 19)
const topologyLockState     = getToggleState("topologyLock");
const decayLockState        = getToggleState("decayLock");
const preDelayLockState     = getToggleState("preDelayLock");
const densityLockState      = getToggleState("densityLock");
const spectralTiltLockState = getToggleState("spectralTiltLock");
const resonanceLockState    = getToggleState("resonanceLock");
const modRateLockState      = getToggleState("modRateLock");
const modDepthLockState     = getToggleState("modDepthLock");
const widthLockState        = getToggleState("widthLock");
const mixLockState          = getToggleState("mixLock");
```

---

## Implementation Notes

### Mutation System Architecture

The mutation system reads lock states from APVTS on the audio thread (or a timer thread),
then randomizes all unlocked float parameters simultaneously. Key implementation points:

1. **mutationInterval and crossfadeSpeed are NOT lockable** — they are excluded from the
   randomization list entirely (not just locked by default).
2. **Lock read order** must match parameter declaration order for consistency.
3. **Randomization** uses uniform distribution: `min + random * (max - min)`. No musical
   weighting, no bias — true chaos.
4. **Dual FDN requirement:** Two independent FDN instances (FDN-A and FDN-B) must be
   maintained. At mutation: FDN-B receives new parameters, crossfade ramp begins
   (A fades out over crossfadeSpeed ms, B fades in). After crossfade: FDN-A becomes
   idle until next mutation.

### Parameter Skew Factors

- `decay`: Logarithmic skew (0.35) — places more visual resolution in the 0.5–10s range
- `modRate`: Logarithmic skew (0.35) — places more visual resolution in 0.01–1Hz range
- All other float parameters: Linear skew (1.0)

### Spectral Tilt Bipolar Knob

The `spectralTilt` parameter has range -100 to +100 with default 0. In the WebView UI,
the knob should display center position (0) when at default. The normalized value from
JUCE will be 0.5 at center. The JavaScript display should map 0.5 normalized = "0" and
show negative numbers when below center, positive above.

### Resonance Stability

The `resonance` parameter requires a hard gain clamp in the DSP implementation to prevent
runaway feedback. At resonance=100%, the maximum internal feedback gain must be strictly
bounded. The UI spec and parameter spec do not constrain this — it is a DSP implementation
responsibility during Stage 2 (DSP).

---

*Specification generated: 2026-02-27*
*Status: Finalized — immutable contract for all implementation stages*
