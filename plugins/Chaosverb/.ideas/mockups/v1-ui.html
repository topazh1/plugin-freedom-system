<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Chaosverb</title>
  <script type="module" src="js/juce/index.js"></script>
  <style>
    /* ─── WEBVIEW FOUNDATION ─── */
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    *, *::before, *::after {
      box-sizing: border-box;
    }

    body {
      user-select: none;
      -webkit-user-select: none;
      cursor: default;
      overflow: hidden;
      background: #141414;
      color: #e0e0e0;
      font-family: 'Inter', 'Helvetica Neue', Arial, sans-serif;
      font-size: 11px;
    }

    /* ─── PLUGIN SHELL ─── */
    .plugin-shell {
      width: 780px;
      height: 360px;
      background: #141414;
      position: relative;
      display: flex;
      flex-direction: column;
    }

    /* ─── HEADER ─── */
    .header {
      width: 100%;
      height: 54px;
      background: #0e0e0e;
      border-bottom: 1px solid #2a2a2a;
      display: flex;
      align-items: center;
      padding: 0 20px;
      flex-shrink: 0;
      position: relative;
    }

    .header-left {
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 2px;
    }

    .plugin-title {
      font-size: 13px;
      font-weight: 700;
      letter-spacing: 0.25em;
      text-transform: uppercase;
      color: #e0e0e0;
      line-height: 1;
    }

    .plugin-tagline {
      font-size: 8px;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: #555555;
      line-height: 1;
    }

    .header-center {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      align-items: center;
    }

    .mutate-btn {
      background: transparent;
      border: 1px solid #333333;
      color: #888888;
      font-family: inherit;
      font-size: 9px;
      font-weight: 600;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      padding: 6px 16px;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.15s ease;
      position: relative;
      overflow: hidden;
    }

    .mutate-btn:hover {
      border-color: #00d4ff;
      color: #00d4ff;
      box-shadow: 0 0 10px rgba(0, 212, 255, 0.2);
    }

    .mutate-btn:active {
      background: rgba(0, 212, 255, 0.08);
    }

    .mutate-btn.firing {
      border-color: #ffffff;
      color: #ffffff;
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.4);
    }

    .header-right {
      margin-left: auto;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 1px;
    }

    .countdown-label {
      font-size: 7px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: #444444;
      line-height: 1;
    }

    .countdown {
      font-family: 'JetBrains Mono', 'Courier New', monospace;
      font-size: 28px;
      font-weight: 700;
      letter-spacing: 0.05em;
      color: #00d4ff;
      line-height: 1;
      transition: color 0.3s ease;
      text-shadow: 0 0 12px rgba(0, 212, 255, 0.6);
    }

    .countdown.warning {
      color: #ff3333;
      text-shadow: 0 0 12px rgba(255, 51, 51, 0.7);
      animation: pulse-warning 0.8s ease-in-out infinite alternate;
    }

    @keyframes pulse-warning {
      from { opacity: 1; }
      to   { opacity: 0.65; }
    }

    /* ─── BODY ─── */
    .body {
      flex: 1;
      display: flex;
      flex-direction: row;
      padding: 0;
      position: relative;
    }

    /* ─── SECTION COLUMNS ─── */
    .section-col {
      display: flex;
      flex-direction: column;
      padding: 10px 0 10px 0;
      position: relative;
    }

    .section-label {
      font-size: 7.5px;
      font-weight: 700;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: #444444;
      padding: 6px 0 8px 0;
      text-align: center;
      width: 100%;
    }

    /* ─── SECTIONS ─── */
    .section-space {
      width: 194px;
      padding: 10px 20px 10px 20px;
      border-right: 1px solid #222222;
    }

    .section-spectral {
      width: 96px;
      padding: 10px 14px 10px 14px;
      border-right: 1px solid #222222;
    }

    .section-motion {
      width: 96px;
      padding: 10px 14px 10px 14px;
      border-right: 1px solid #222222;
    }

    .section-mutation {
      width: 178px;
      padding: 10px 18px 10px 18px;
      border-right: 1px solid #222222;
    }

    .section-output {
      flex: 1;
      padding: 10px 20px 10px 20px;
    }

    /* ─── KNOB GRID ─── */
    .knob-grid-2x2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 18px 14px;
      margin-top: 2px;
    }

    .knob-col {
      display: flex;
      flex-direction: column;
      gap: 18px;
      margin-top: 2px;
    }

    .output-knob-row {
      display: flex;
      flex-direction: row;
      gap: 20px;
      justify-content: center;
      margin-top: 2px;
    }

    /* ─── KNOB COMPONENT ─── */
    .knob-wrap {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
      cursor: ns-resize;
    }

    .knob-body {
      width: 56px;
      height: 56px;
      position: relative;
      flex-shrink: 0;
    }

    .knob-body canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 56px;
      height: 56px;
    }

    .knob-face {
      position: absolute;
      top: 8px;
      left: 8px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: radial-gradient(circle at 35% 35%, #2e2e2e, #181818);
      border: 1px solid #333333;
      z-index: 2;
    }

    .knob-indicator {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 2px;
      height: 12px;
      margin-left: -1px;
      margin-top: -18px;
      border-radius: 1px;
      transform-origin: 50% 100%;
      z-index: 3;
      transition: background 0.2s;
    }

    .knob-label {
      font-size: 8px;
      font-weight: 600;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: #666666;
      text-align: center;
      line-height: 1;
    }

    .knob-value {
      font-size: 8px;
      letter-spacing: 0.04em;
      color: #888888;
      text-align: center;
      line-height: 1;
      font-variant-numeric: tabular-nums;
    }

    .knob-body.locked .knob-face {
      border-color: transparent;
    }

    /* ─── HORIZONTAL SLIDER ─── */
    .hslider-wrap {
      display: flex;
      flex-direction: column;
      gap: 5px;
      width: 100%;
    }

    .hslider-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
    }

    .hslider-label {
      font-size: 8px;
      font-weight: 600;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: #666666;
    }

    .hslider-value {
      font-size: 8px;
      color: #888888;
      font-variant-numeric: tabular-nums;
    }

    .hslider-track {
      width: 100%;
      height: 28px;
      background: #0e0e0e;
      border: 1px solid #2a2a2a;
      border-radius: 4px;
      position: relative;
      cursor: ew-resize;
      overflow: hidden;
    }

    .hslider-fill {
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      background: linear-gradient(90deg, #2a2a2a, #3a3a3a);
      border-radius: 4px 0 0 4px;
      transition: width 0.05s;
    }

    .hslider-thumb {
      position: absolute;
      top: 50%;
      width: 2px;
      height: 16px;
      background: #888888;
      border-radius: 1px;
      transform: translateY(-50%) translateX(-1px);
      transition: background 0.2s;
    }

    .hslider-track:hover .hslider-thumb {
      background: #aaaaaa;
    }

    /* ─── MUTATION FLASH OVERLAY ─── */
    .mutation-flash {
      position: absolute;
      inset: 0;
      background: rgba(255, 255, 255, 0.12);
      pointer-events: none;
      opacity: 0;
      z-index: 100;
    }

    .mutation-flash.active {
      animation: flash-burst 0.4s ease-out forwards;
    }

    @keyframes flash-burst {
      0%   { opacity: 0.15; }
      20%  { opacity: 0.08; }
      100% { opacity: 0; }
    }

    /* ─── SECTION LABEL COLORS ─── */
    .section-space .section-label     { color: #1a5f6a; }
    .section-spectral .section-label  { color: #1a5f6a; }
    .section-motion .section-label    { color: #5a3070; }
    .section-mutation .section-label  { color: #555555; }
    .section-output .section-label    { color: #555555; }
  </style>
</head>
<body>
<div class="plugin-shell" id="pluginShell">

  <!-- MUTATION FLASH OVERLAY -->
  <div class="mutation-flash" id="mutationFlash"></div>

  <!-- HEADER -->
  <div class="header">
    <div class="header-left">
      <div class="plugin-title">Chaosverb</div>
      <div class="plugin-tagline">impossible space reverb</div>
    </div>

    <div class="header-center">
      <button class="mutate-btn" id="mutateBtn">Mutate Now</button>
    </div>

    <div class="header-right">
      <div class="countdown-label">Next Mutation</div>
      <div class="countdown" id="countdown">00:30</div>
    </div>
  </div>

  <!-- BODY -->
  <div class="body">

    <!-- SPACE SECTION -->
    <div class="section-col section-space">
      <div class="section-label">Space</div>
      <div class="knob-grid-2x2">
        <div id="knob_topology"></div>
        <div id="knob_decay"></div>
        <div id="knob_preDelay"></div>
        <div id="knob_density"></div>
      </div>
    </div>

    <!-- SPECTRAL SECTION -->
    <div class="section-col section-spectral">
      <div class="section-label">Spectral</div>
      <div class="knob-col">
        <div id="knob_spectralTilt"></div>
        <div id="knob_resonance"></div>
      </div>
    </div>

    <!-- MOTION SECTION -->
    <div class="section-col section-motion">
      <div class="section-label">Motion</div>
      <div class="knob-col">
        <div id="knob_modRate"></div>
        <div id="knob_modDepth"></div>
      </div>
    </div>

    <!-- MUTATION SECTION -->
    <div class="section-col section-mutation">
      <div class="section-label">Mutation</div>
      <div style="display:flex; flex-direction:column; gap:20px; margin-top:4px;">
        <div id="hslider_mutationInterval"></div>
        <div id="hslider_crossfadeSpeed"></div>
      </div>
    </div>

    <!-- OUTPUT SECTION -->
    <div class="section-col section-output">
      <div class="section-label">Output</div>
      <div class="output-knob-row">
        <div id="knob_width"></div>
        <div id="knob_mix"></div>
      </div>
    </div>

  </div>
</div>

<script type="module">
"use strict";

import { getSliderState, getToggleState } from './js/juce/index.js';

// ─── DISABLE CONTEXT MENU ─────────────────────────────────────────────────────
document.addEventListener("contextmenu", (e) => {
  e.preventDefault();
  return false;
});

// ─── JUCE PARAMETER STATES ────────────────────────────────────────────────────
// Float parameters — getSliderState (Pattern 21 + Pattern 19)
const topologyState         = getSliderState("topology");
const decayState            = getSliderState("decay");
const preDelayState         = getSliderState("preDelay");
const densityState          = getSliderState("density");
const spectralTiltState     = getSliderState("spectralTilt");
const resonanceState        = getSliderState("resonance");
const modRateState          = getSliderState("modRate");
const modDepthState         = getSliderState("modDepth");
const mutationIntervalState = getSliderState("mutationInterval");
const crossfadeSpeedState   = getSliderState("crossfadeSpeed");
const widthState            = getSliderState("width");
const mixState              = getSliderState("mix");

// Bool parameters — getToggleState (Pattern 19)
const topologyLockState     = getToggleState("topologyLock");
const decayLockState        = getToggleState("decayLock");
const preDelayLockState     = getToggleState("preDelayLock");
const densityLockState      = getToggleState("densityLock");
const spectralTiltLockState = getToggleState("spectralTiltLock");
const resonanceLockState    = getToggleState("resonanceLock");
const modRateLockState      = getToggleState("modRateLock");
const modDepthLockState     = getToggleState("modDepthLock");
const widthLockState        = getToggleState("widthLock");
const mixLockState          = getToggleState("mixLock");

// ─── PARAMETER META TABLE ─────────────────────────────────────────────────────
// Used by knob/slider builders for formatting and rendering
const KNOB_PARAMS = {
  topology:       { label: "Topology",   unit: "",    min: 0,    max: 100,  section: "space",    state: topologyState,     lockState: topologyLockState },
  decay:          { label: "Decay",      unit: "s",   min: 0.1,  max: 60,   section: "space",    state: decayState,        lockState: decayLockState },
  preDelay:       { label: "Pre-Delay",  unit: "ms",  min: 0,    max: 250,  section: "space",    state: preDelayState,     lockState: preDelayLockState },
  density:        { label: "Density",    unit: "%",   min: 0,    max: 100,  section: "space",    state: densityState,      lockState: densityLockState },
  spectralTilt:   { label: "Sp.Tilt",   unit: "",    min: -100, max: 100,  section: "spectral", state: spectralTiltState, lockState: spectralTiltLockState },
  resonance:      { label: "Resonance",  unit: "%",   min: 0,    max: 100,  section: "spectral", state: resonanceState,    lockState: resonanceLockState },
  modRate:        { label: "Mod Rate",   unit: "Hz",  min: 0.01, max: 10,   section: "motion",   state: modRateState,      lockState: modRateLockState },
  modDepth:       { label: "Mod Depth",  unit: "%",   min: 0,    max: 100,  section: "motion",   state: modDepthState,     lockState: modDepthLockState },
  width:          { label: "Width",      unit: "%",   min: 0,    max: 200,  section: "output",   state: widthState,        lockState: widthLockState },
  mix:            { label: "Mix",        unit: "%",   min: 0,    max: 100,  section: "output",   state: mixState,          lockState: mixLockState },
};

const HSLIDER_PARAMS = {
  mutationInterval: { label: "Interval",  min: 5,   max: 600, state: mutationIntervalState, formatFn: (n) => {
    const secs = Math.round(5 + n * 595);
    if (secs >= 60) return Math.floor(secs / 60) + "m " + (secs % 60) + "s";
    return secs + "s";
  }},
  crossfadeSpeed:   { label: "Crossfade", min: 0,   max: 500, state: crossfadeSpeedState, formatFn: (n) => {
    return Math.round(n * 500) + "ms";
  }},
};

const SECTION_COLORS = {
  space:    "#00d4ff",
  spectral: "#00d4ff",
  motion:   "#9b59b6",
  output:   "#888888",
};

// ─── COUNTDOWN STATE (driven by mutationInterval parameter) ───────────────────
let countdownRemaining = 30; // seconds
let lastTimestamp = null;

// ─── KNOB RENDERING ──────────────────────────────────────────────────────────
const KNOB_SIZE = 56;
const ARC_RADIUS = 24;
const ARC_START = 135;   // degrees
const ARC_END   = 405;   // 135 + 270

function degToRad(d) { return d * Math.PI / 180; }

function drawKnob(canvas, normValue, accentColor, locked) {
  const ctx = canvas.getContext("2d");
  const cx = KNOB_SIZE / 2;
  const cy = KNOB_SIZE / 2;
  const r = ARC_RADIUS;

  ctx.clearRect(0, 0, canvas.width, canvas.height);

  if (locked) {
    // Outer glow
    const glowGrad = ctx.createRadialGradient(cx, cy, r - 6, cx, cy, r + 8);
    glowGrad.addColorStop(0, accentColor + "80");
    glowGrad.addColorStop(0.5, accentColor + "40");
    glowGrad.addColorStop(1, "transparent");
    ctx.beginPath();
    ctx.arc(cx, cy, r + 2, 0, Math.PI * 2);
    ctx.strokeStyle = glowGrad;
    ctx.lineWidth = 10;
    ctx.stroke();

    // Solid lock ring
    ctx.beginPath();
    ctx.arc(cx, cy, r, 0, Math.PI * 2);
    ctx.strokeStyle = accentColor;
    ctx.lineWidth = 3;
    ctx.stroke();
  } else {
    const startRad = degToRad(ARC_START);
    const endRad   = degToRad(ARC_END);

    // Arc track (dim)
    ctx.beginPath();
    ctx.arc(cx, cy, r, startRad, endRad);
    ctx.strokeStyle = "#2a2a2a";
    ctx.lineWidth = 3;
    ctx.lineCap = "round";
    ctx.stroke();

    // Arc fill
    if (normValue > 0.001) {
      const fillEnd = degToRad(ARC_START + normValue * 270);

      // Glow
      ctx.beginPath();
      ctx.arc(cx, cy, r, startRad, fillEnd);
      ctx.strokeStyle = accentColor + "50";
      ctx.lineWidth = 6;
      ctx.lineCap = "round";
      ctx.stroke();

      // Sharp arc
      ctx.beginPath();
      ctx.arc(cx, cy, r, startRad, fillEnd);
      ctx.strokeStyle = accentColor;
      ctx.lineWidth = 3;
      ctx.lineCap = "round";
      ctx.stroke();
    }
  }
}

// ─── KNOB VALUE FORMATTING ────────────────────────────────────────────────────
function formatKnobValue(paramId, normValue) {
  const p = KNOB_PARAMS[paramId];
  const v = p.min + normValue * (p.max - p.min);
  if (p.unit === "s") return v.toFixed(1) + "s";
  if (p.unit === "ms") return Math.round(v) + "ms";
  if (p.unit === "Hz") return v < 1 ? v.toFixed(2) + "Hz" : v.toFixed(1) + "Hz";
  if (p.unit === "%") return Math.round(v) + "%";
  // For bipolar (spectralTilt) or unitless
  const rounded = Math.round(v);
  return rounded > 0 ? "+" + rounded : String(rounded);
}

// ─── KNOB COMPONENT FACTORY ───────────────────────────────────────────────────
function buildKnob(containerId, paramId) {
  const p = KNOB_PARAMS[paramId];
  const accentColor = SECTION_COLORS[p.section] || "#888888";
  const container = document.getElementById(containerId);
  if (!container) return;

  const wrap = document.createElement("div");
  wrap.className = "knob-wrap";
  wrap.setAttribute("data-param", paramId);

  const bodyEl = document.createElement("div");
  bodyEl.className = "knob-body";
  bodyEl.id = "knobBody_" + paramId;

  const canvas = document.createElement("canvas");
  canvas.width = KNOB_SIZE;
  canvas.height = KNOB_SIZE;
  canvas.style.cssText = "position:absolute;top:0;left:0;width:56px;height:56px;";
  bodyEl.appendChild(canvas);

  const face = document.createElement("div");
  face.className = "knob-face";

  const indicator = document.createElement("div");
  indicator.className = "knob-indicator";
  indicator.id = "knobInd_" + paramId;
  indicator.style.background = accentColor;
  face.appendChild(indicator);
  bodyEl.appendChild(face);

  const labelEl = document.createElement("div");
  labelEl.className = "knob-label";
  labelEl.textContent = p.label;

  const valueEl = document.createElement("div");
  valueEl.className = "knob-value";
  valueEl.id = "knobVal_" + paramId;

  wrap.appendChild(bodyEl);
  wrap.appendChild(labelEl);
  wrap.appendChild(valueEl);
  container.appendChild(wrap);

  // Refresh from JUCE state
  function refresh() {
    const norm = p.state.getNormalisedValue();
    const locked = p.lockState.getValue();
    const canvas = bodyEl.querySelector("canvas");

    drawKnob(canvas, norm, accentColor, locked);

    const rot = -135 + norm * 270;
    indicator.style.transform = `rotate(${rot}deg)`;
    indicator.style.opacity = locked ? "0.5" : "1";

    if (locked) bodyEl.classList.add("locked");
    else bodyEl.classList.remove("locked");

    valueEl.textContent = formatKnobValue(paramId, norm);
    valueEl.style.color = locked ? accentColor + "cc" : "#666666";
  }

  // JUCE value change listeners (Pattern 15: no callback params)
  p.state.valueChangedEvent.addListener(() => refresh());
  p.lockState.valueChangedEvent.addListener(() => refresh());

  // Initial render
  refresh();

  // Drag interaction (Pattern 16: relative drag)
  let lastY = null;
  let currentNorm = () => p.state.getNormalisedValue();

  wrap.addEventListener("mousedown", (e) => {
    e.preventDefault();
    lastY = e.clientY;
    document.body.style.cursor = "ns-resize";

    const onMove = (me) => {
      const deltaY = lastY - me.clientY;
      lastY = me.clientY;
      const sensitivity = 0.005; // normalized per pixel
      const newNorm = Math.max(0, Math.min(1, currentNorm() + deltaY * sensitivity));
      p.state.setNormalisedValue(newNorm);
    };

    const onUp = () => {
      document.body.style.cursor = "default";
      lastY = null;
      document.removeEventListener("mousemove", onMove);
      document.removeEventListener("mouseup", onUp);
    };

    document.addEventListener("mousemove", onMove);
    document.addEventListener("mouseup", onUp);
  });

  // Lock toggle: double-click or right-click
  wrap.addEventListener("dblclick", (e) => {
    e.preventDefault();
    p.lockState.setValue(!p.lockState.getValue());
  });

  wrap.addEventListener("contextmenu", (e) => {
    e.preventDefault();
    p.lockState.setValue(!p.lockState.getValue());
    return false;
  });
}

// ─── HORIZONTAL SLIDER FACTORY ────────────────────────────────────────────────
function buildHSlider(containerId, paramId) {
  const p = HSLIDER_PARAMS[paramId];
  const container = document.getElementById(containerId);
  if (!container) return;

  const wrap = document.createElement("div");
  wrap.className = "hslider-wrap";

  const header = document.createElement("div");
  header.className = "hslider-header";

  const labelEl = document.createElement("span");
  labelEl.className = "hslider-label";
  labelEl.textContent = p.label;

  const valEl = document.createElement("span");
  valEl.className = "hslider-value";
  valEl.id = "hsliderVal_" + paramId;

  header.appendChild(labelEl);
  header.appendChild(valEl);

  const track = document.createElement("div");
  track.className = "hslider-track";
  track.id = "hsliderTrack_" + paramId;

  const fill = document.createElement("div");
  fill.className = "hslider-fill";
  fill.id = "hsliderFill_" + paramId;

  const thumb = document.createElement("div");
  thumb.className = "hslider-thumb";
  thumb.id = "hsliderThumb_" + paramId;

  track.appendChild(fill);
  track.appendChild(thumb);
  wrap.appendChild(header);
  wrap.appendChild(track);
  container.appendChild(wrap);

  function refresh() {
    const norm = p.state.getNormalisedValue();
    const trackW = track.offsetWidth || 140;
    fill.style.width = (norm * 100) + "%";
    thumb.style.left = (norm * trackW) + "px";
    valEl.textContent = p.formatFn(norm);

    // Keep countdown in sync with mutationInterval
    if (paramId === "mutationInterval") {
      countdownRemaining = 5 + norm * 595;
      updateCountdownDisplay();
    }
  }

  p.state.valueChangedEvent.addListener(() => refresh());
  refresh();

  // Drag
  let startX = null;
  let startNorm = null;

  track.addEventListener("mousedown", (e) => {
    e.preventDefault();
    startX = e.clientX;
    startNorm = p.state.getNormalisedValue();
    document.body.style.cursor = "ew-resize";

    const onMove = (me) => {
      const trackW = track.offsetWidth || 140;
      const delta = (me.clientX - startX) / trackW;
      const newNorm = Math.max(0, Math.min(1, startNorm + delta));
      p.state.setNormalisedValue(newNorm);
    };

    const onUp = () => {
      document.body.style.cursor = "default";
      document.removeEventListener("mousemove", onMove);
      document.removeEventListener("mouseup", onUp);
    };

    document.addEventListener("mousemove", onMove);
    document.addEventListener("mouseup", onUp);
  });
}

// ─── COUNTDOWN DISPLAY ────────────────────────────────────────────────────────
const countdownEl = document.getElementById("countdown");

function updateCountdownDisplay() {
  const secs = Math.max(0, Math.ceil(countdownRemaining));
  const m = Math.floor(secs / 60);
  const s = secs % 60;
  countdownEl.textContent = String(m).padStart(2, "0") + ":" + String(s).padStart(2, "0");

  if (secs <= 5) {
    countdownEl.classList.add("warning");
  } else {
    countdownEl.classList.remove("warning");
  }
}

function tickCountdown(timestamp) {
  if (lastTimestamp !== null) {
    const delta = (timestamp - lastTimestamp) / 1000;
    countdownRemaining -= delta;

    if (countdownRemaining <= 0) {
      // Mutation is driven by C++ timer — just reset the display
      const norm = mutationIntervalState.getNormalisedValue();
      countdownRemaining = 5 + norm * 595;
    }

    updateCountdownDisplay();
  }
  lastTimestamp = timestamp;
  requestAnimationFrame(tickCountdown);
}

// ─── MUTATE NOW BUTTON ────────────────────────────────────────────────────────
// Triggers mutation via a native function call to C++
document.getElementById("mutateBtn").addEventListener("click", () => {
  const btn = document.getElementById("mutateBtn");
  btn.classList.add("firing");
  setTimeout(() => btn.classList.remove("firing"), 350);

  // Flash overlay
  const flash = document.getElementById("mutationFlash");
  flash.classList.remove("active");
  void flash.offsetWidth;
  flash.classList.add("active");

  // Reset countdown display
  const norm = mutationIntervalState.getNormalisedValue();
  countdownRemaining = 5 + norm * 595;
  updateCountdownDisplay();

  // Notify C++ backend via NativeFunction (gui-agent wires this in Stage 3)
  if (typeof window.__JUCE__ !== "undefined" && window.__JUCE__.backend) {
    // C++ registers "mutateNow" native function in PluginEditor constructor
    try { window.__JUCE__.backend.emitEvent("mutateNow", {}); } catch(e) {}
  }
});

// ─── INITIALISE ──────────────────────────────────────────────────────────────
function init() {
  // SPACE
  buildKnob("knob_topology",  "topology");
  buildKnob("knob_decay",     "decay");
  buildKnob("knob_preDelay",  "preDelay");
  buildKnob("knob_density",   "density");

  // SPECTRAL
  buildKnob("knob_spectralTilt", "spectralTilt");
  buildKnob("knob_resonance",    "resonance");

  // MOTION
  buildKnob("knob_modRate",  "modRate");
  buildKnob("knob_modDepth", "modDepth");

  // MUTATION
  buildHSlider("hslider_mutationInterval", "mutationInterval");
  buildHSlider("hslider_crossfadeSpeed",   "crossfadeSpeed");

  // OUTPUT
  buildKnob("knob_width", "width");
  buildKnob("knob_mix",   "mix");

  // Start countdown timer (display only — real timer is in C++)
  updateCountdownDisplay();
  requestAnimationFrame(tickCountdown);
}

document.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>
