<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chaosverb — UI Mockup v1</title>
  <style>
    /* ─── WEBVIEW FOUNDATION ─── */
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    *, *::before, *::after {
      box-sizing: border-box;
    }

    body {
      user-select: none;
      -webkit-user-select: none;
      cursor: default;
      overflow: hidden;
      background: #141414;
      color: #e0e0e0;
      font-family: 'Inter', 'Helvetica Neue', Arial, sans-serif;
      font-size: 11px;
    }

    /* ─── PLUGIN SHELL ─── */
    .plugin-shell {
      width: 780px;
      height: 360px;
      background: #141414;
      position: relative;
      display: flex;
      flex-direction: column;
      border: 1px solid #2e2e2e;
    }

    /* ─── HEADER ─── */
    .header {
      width: 100%;
      height: 54px;
      background: #0e0e0e;
      border-bottom: 1px solid #2a2a2a;
      display: flex;
      align-items: center;
      padding: 0 20px;
      flex-shrink: 0;
      position: relative;
    }

    .header-left {
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 2px;
    }

    .plugin-title {
      font-size: 13px;
      font-weight: 700;
      letter-spacing: 0.25em;
      text-transform: uppercase;
      color: #e0e0e0;
      line-height: 1;
    }

    .plugin-tagline {
      font-size: 8px;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: #555555;
      line-height: 1;
    }

    .header-center {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      align-items: center;
    }

    .mutate-btn {
      background: transparent;
      border: 1px solid #333333;
      color: #888888;
      font-family: inherit;
      font-size: 9px;
      font-weight: 600;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      padding: 6px 16px;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.15s ease;
      position: relative;
      overflow: hidden;
    }

    .mutate-btn:hover {
      border-color: #00d4ff;
      color: #00d4ff;
      box-shadow: 0 0 10px rgba(0, 212, 255, 0.2);
    }

    .mutate-btn:active {
      background: rgba(0, 212, 255, 0.08);
    }

    .mutate-btn.firing {
      border-color: #ffffff;
      color: #ffffff;
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.4);
    }

    .header-right {
      margin-left: auto;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 1px;
    }

    .countdown-label {
      font-size: 7px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: #444444;
      line-height: 1;
    }

    .countdown {
      font-family: 'JetBrains Mono', 'Courier New', monospace;
      font-size: 28px;
      font-weight: 700;
      letter-spacing: 0.05em;
      color: #00d4ff;
      line-height: 1;
      transition: color 0.3s ease;
      text-shadow: 0 0 12px rgba(0, 212, 255, 0.6);
    }

    .countdown.warning {
      color: #ff3333;
      text-shadow: 0 0 12px rgba(255, 51, 51, 0.7);
      animation: pulse-warning 0.8s ease-in-out infinite alternate;
    }

    @keyframes pulse-warning {
      from { opacity: 1; }
      to   { opacity: 0.65; }
    }

    /* ─── BODY ─── */
    .body {
      flex: 1;
      display: flex;
      flex-direction: row;
      padding: 0;
      position: relative;
    }

    /* ─── SECTION COLUMN ─── */
    .section-col {
      display: flex;
      flex-direction: column;
      padding: 10px 0 10px 0;
      position: relative;
    }

    .section-divider {
      width: 1px;
      background: #222222;
      margin: 10px 0;
    }

    .section-label {
      font-size: 7.5px;
      font-weight: 700;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: #444444;
      padding: 6px 0 8px 0;
      text-align: center;
      width: 100%;
    }

    .section-label.cyan  { color: #1a7a8a; }
    .section-label.purple { color: #6a3980; }
    .section-label.gray  { color: #444444; }

    /* ─── SECTIONS ─── */
    .section-space {
      width: 194px;
      padding: 10px 20px 10px 20px;
      border-right: 1px solid #222222;
    }

    .section-spectral {
      width: 96px;
      padding: 10px 14px 10px 14px;
      border-right: 1px solid #222222;
    }

    .section-motion {
      width: 96px;
      padding: 10px 14px 10px 14px;
      border-right: 1px solid #222222;
    }

    .section-mutation {
      width: 178px;
      padding: 10px 18px 10px 18px;
      border-right: 1px solid #222222;
    }

    .section-output {
      flex: 1;
      padding: 10px 20px 10px 20px;
    }

    /* Total: 194 + 96 + 96 + 178 + (780-194-96-96-178) = 194+96+96+178+216 = 780. Output = 216. */

    /* ─── KNOB GRID ─── */
    .knob-grid-2x2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 18px 14px;
      margin-top: 2px;
    }

    .knob-col {
      display: flex;
      flex-direction: column;
      gap: 18px;
      margin-top: 2px;
    }

    .knob-row {
      display: flex;
      flex-direction: row;
      gap: 14px;
      margin-top: 2px;
    }

    .output-knob-row {
      display: flex;
      flex-direction: row;
      gap: 20px;
      justify-content: center;
      margin-top: 2px;
    }

    /* ─── KNOB COMPONENT ─── */
    .knob-wrap {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
      cursor: ns-resize;
    }

    .knob-body {
      width: 56px;
      height: 56px;
      position: relative;
      flex-shrink: 0;
    }

    /* SVG canvas for arc */
    .knob-body canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 56px;
      height: 56px;
    }

    .knob-face {
      position: absolute;
      top: 8px;
      left: 8px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: radial-gradient(circle at 35% 35%, #2e2e2e, #181818);
      border: 1px solid #333333;
      z-index: 2;
    }

    .knob-indicator {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 2px;
      height: 12px;
      margin-left: -1px;
      margin-top: -18px;
      border-radius: 1px;
      transform-origin: 50% 100%;
      z-index: 3;
      transition: background 0.2s;
    }

    .knob-label {
      font-size: 8px;
      font-weight: 600;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: #666666;
      text-align: center;
      line-height: 1;
    }

    .knob-value {
      font-size: 8px;
      letter-spacing: 0.04em;
      color: #888888;
      text-align: center;
      line-height: 1;
      font-variant-numeric: tabular-nums;
    }

    /* ─── LOCK RING STATES ─── */
    /* When locked, canvas renders a solid 360deg glowing ring */
    .knob-body.locked .knob-face {
      border-color: transparent;
    }

    /* ─── HORIZONTAL SLIDER ─── */
    .hslider-wrap {
      display: flex;
      flex-direction: column;
      gap: 5px;
      width: 100%;
    }

    .hslider-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
    }

    .hslider-label {
      font-size: 8px;
      font-weight: 600;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: #666666;
    }

    .hslider-value {
      font-size: 8px;
      color: #888888;
      font-variant-numeric: tabular-nums;
    }

    .hslider-track {
      width: 100%;
      height: 28px;
      background: #0e0e0e;
      border: 1px solid #2a2a2a;
      border-radius: 4px;
      position: relative;
      cursor: ew-resize;
      overflow: hidden;
    }

    .hslider-fill {
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      background: linear-gradient(90deg, #2a2a2a, #3a3a3a);
      border-radius: 4px 0 0 4px;
      transition: width 0.05s;
    }

    .hslider-thumb {
      position: absolute;
      top: 50%;
      width: 2px;
      height: 16px;
      background: #888888;
      border-radius: 1px;
      transform: translateY(-50%) translateX(-1px);
      transition: background 0.2s;
    }

    .hslider-track:hover .hslider-thumb {
      background: #aaaaaa;
    }

    /* ─── MUTATION FLASH OVERLAY ─── */
    .mutation-flash {
      position: absolute;
      inset: 0;
      background: rgba(255, 255, 255, 0.12);
      pointer-events: none;
      opacity: 0;
      z-index: 100;
      border-radius: 0;
    }

    .mutation-flash.active {
      animation: flash-burst 0.4s ease-out forwards;
    }

    @keyframes flash-burst {
      0%   { opacity: 0.15; }
      20%  { opacity: 0.08; }
      100% { opacity: 0; }
    }

    /* ─── SECTION ACCENT RULES ─── */
    .section-space .section-label     { color: #1a5f6a; }
    .section-spectral .section-label  { color: #1a5f6a; }
    .section-motion .section-label    { color: #5a3070; }
    .section-mutation .section-label  { color: #555555; }
    .section-output .section-label    { color: #555555; }

    /* ─── BOTTOM HINT BAR ─── */
    .hint-bar {
      height: 0;
    }

  </style>
</head>
<body>
<div class="plugin-shell" id="pluginShell">

  <!-- MUTATION FLASH OVERLAY -->
  <div class="mutation-flash" id="mutationFlash"></div>

  <!-- ─── HEADER ─── -->
  <div class="header">
    <div class="header-left">
      <div class="plugin-title">Chaosverb</div>
      <div class="plugin-tagline">impossible space reverb</div>
    </div>

    <div class="header-center">
      <button class="mutate-btn" id="mutateBtn">Mutate Now</button>
    </div>

    <div class="header-right">
      <div class="countdown-label">Next Mutation</div>
      <div class="countdown" id="countdown">00:30</div>
    </div>
  </div>

  <!-- ─── BODY ─── -->
  <div class="body">

    <!-- SPACE SECTION -->
    <div class="section-col section-space">
      <div class="section-label">Space</div>
      <div class="knob-grid-2x2">
        <div id="knob_topology"></div>
        <div id="knob_decay"></div>
        <div id="knob_pre_delay"></div>
        <div id="knob_density"></div>
      </div>
    </div>

    <!-- SPECTRAL SECTION -->
    <div class="section-col section-spectral">
      <div class="section-label">Spectral</div>
      <div class="knob-col">
        <div id="knob_spectral_tilt"></div>
        <div id="knob_resonance"></div>
      </div>
    </div>

    <!-- MOTION SECTION -->
    <div class="section-col section-motion">
      <div class="section-label">Motion</div>
      <div class="knob-col">
        <div id="knob_mod_rate"></div>
        <div id="knob_mod_depth"></div>
      </div>
    </div>

    <!-- MUTATION SECTION -->
    <div class="section-col section-mutation">
      <div class="section-label">Mutation</div>
      <div style="display:flex; flex-direction:column; gap:20px; margin-top:4px;">
        <div id="hslider_mutation_interval"></div>
        <div id="hslider_crossfade_speed"></div>
      </div>
    </div>

    <!-- OUTPUT SECTION -->
    <div class="section-col section-output">
      <div class="section-label">Output</div>
      <div class="output-knob-row">
        <div id="knob_width"></div>
        <div id="knob_mix"></div>
      </div>
    </div>

  </div>
</div>

<script>
"use strict";

// ─── MOCK JUCE BACKEND ────────────────────────────────────────────────────────
window.Juce = {
  getSliderState: (id) => ({
    normalisedValue: 0.5,
    valueChangedEvent: { addListener: (fn) => {} }
  }),
  getToggleState: (id) => ({
    value: false,
    valueChangedEvent: { addListener: (fn) => {} }
  }),
  getComboBoxState: (id) => ({
    selectedId: 0,
    valueChangedEvent: { addListener: (fn) => {} }
  })
};

// ─── DISABLE CONTEXT MENU ─────────────────────────────────────────────────────
document.addEventListener("contextmenu", (e) => {
  e.preventDefault();
  return false;
});

// ─── PARAMETER DEFINITIONS ───────────────────────────────────────────────────
const PARAMS = {
  topology:         { min: 0,    max: 100,  default: 50,  unit: "",    label: "Topology",  section: "space",     lockable: true },
  decay:            { min: 0.1,  max: 60,   default: 4,   unit: "s",   label: "Decay",     section: "space",     lockable: true },
  pre_delay:        { min: 0,    max: 250,  default: 10,  unit: "ms",  label: "Pre-Delay", section: "space",     lockable: true },
  density:          { min: 0,    max: 100,  default: 60,  unit: "%",   label: "Density",   section: "space",     lockable: true },
  spectral_tilt:    { min: -100, max: 100,  default: 0,   unit: "",    label: "Sp.Tilt",   section: "spectral",  lockable: true },
  resonance:        { min: 0,    max: 100,  default: 0,   unit: "%",   label: "Resonance", section: "spectral",  lockable: true },
  mod_rate:         { min: 0.01, max: 10,   default: 0.3, unit: "Hz",  label: "Mod Rate",  section: "motion",    lockable: true },
  mod_depth:        { min: 0,    max: 100,  default: 20,  unit: "%",   label: "Mod Depth", section: "motion",    lockable: true },
  width:            { min: 0,    max: 200,  default: 100, unit: "%",   label: "Width",     section: "output",    lockable: true },
  mix:              { min: 0,    max: 100,  default: 50,  unit: "%",   label: "Mix",       section: "output",    lockable: true },
};

const SECTION_COLORS = {
  space:    "#00d4ff",
  spectral: "#00d4ff",
  motion:   "#9b59b6",
  output:   "#888888",
};

// ─── STATE ───────────────────────────────────────────────────────────────────
const state = {
  values: {},
  locked: {},
  mutation_interval: 30,
  crossfade_speed: 100,
  countdownRemaining: 30,
};

// Initialize values
for (const [id, p] of Object.entries(PARAMS)) {
  state.values[id] = p.default;
  state.locked[id] = false;
}

// ─── KNOB RENDERING ──────────────────────────────────────────────────────────
const KNOB_SIZE = 56;
const KNOB_FACE_INSET = 8; // face starts at 8px from edge
const ARC_RADIUS = 24;     // arc drawn at radius 24 from center 28,28
const ARC_START = 135;     // degrees, 270deg arc
const ARC_END   = 405;     // = 135 + 270

function degToRad(d) { return d * Math.PI / 180; }

function drawKnob(canvas, normValue, accentColor, locked) {
  const ctx = canvas.getContext("2d");
  const dpr = window.devicePixelRatio || 1;
  const size = KNOB_SIZE;
  const cx = size / 2;
  const cy = size / 2;
  const r = ARC_RADIUS;

  ctx.clearRect(0, 0, canvas.width, canvas.height);

  if (locked) {
    // ── LOCKED: solid 360deg glowing ring ──
    // Outer glow
    const glowGrad = ctx.createRadialGradient(cx, cy, r - 6, cx, cy, r + 8);
    glowGrad.addColorStop(0, accentColor + "80");
    glowGrad.addColorStop(0.5, accentColor + "40");
    glowGrad.addColorStop(1, "transparent");
    ctx.beginPath();
    ctx.arc(cx, cy, r + 2, 0, Math.PI * 2);
    ctx.strokeStyle = glowGrad;
    ctx.lineWidth = 10;
    ctx.stroke();

    // Solid ring
    ctx.beginPath();
    ctx.arc(cx, cy, r, 0, Math.PI * 2);
    ctx.strokeStyle = accentColor;
    ctx.lineWidth = 3;
    ctx.stroke();
  } else {
    // ── UNLOCKED: 270deg arc track + filled portion ──
    const startRad = degToRad(ARC_START);
    const endRad   = degToRad(ARC_END);

    // Arc track (dim)
    ctx.beginPath();
    ctx.arc(cx, cy, r, startRad, endRad);
    ctx.strokeStyle = "#2a2a2a";
    ctx.lineWidth = 3;
    ctx.lineCap = "round";
    ctx.stroke();

    // Arc fill (accent, from start to current value)
    const fillEnd = degToRad(ARC_START + normValue * 270);
    if (normValue > 0.001) {
      // Glow pass
      ctx.beginPath();
      ctx.arc(cx, cy, r, startRad, fillEnd);
      ctx.strokeStyle = accentColor + "50";
      ctx.lineWidth = 6;
      ctx.lineCap = "round";
      ctx.stroke();

      // Sharp arc
      ctx.beginPath();
      ctx.arc(cx, cy, r, startRad, fillEnd);
      ctx.strokeStyle = accentColor;
      ctx.lineWidth = 3;
      ctx.lineCap = "round";
      ctx.stroke();
    }
  }
}

// ─── KNOB COMPONENT FACTORY ───────────────────────────────────────────────────
function buildKnob(containerId, paramId) {
  const p = PARAMS[paramId];
  const accentColor = SECTION_COLORS[p.section] || "#888888";

  const container = document.getElementById(containerId);
  if (!container) return;

  const wrap = document.createElement("div");
  wrap.className = "knob-wrap";
  wrap.setAttribute("data-param", paramId);

  const bodyEl = document.createElement("div");
  bodyEl.className = "knob-body";
  bodyEl.id = "knobBody_" + paramId;

  const canvas = document.createElement("canvas");
  canvas.width = KNOB_SIZE;
  canvas.height = KNOB_SIZE;
  canvas.style.width = KNOB_SIZE + "px";
  canvas.style.height = KNOB_SIZE + "px";
  canvas.style.position = "absolute";
  canvas.style.top = "0";
  canvas.style.left = "0";
  bodyEl.appendChild(canvas);

  const face = document.createElement("div");
  face.className = "knob-face";
  bodyEl.appendChild(face);

  const indicator = document.createElement("div");
  indicator.className = "knob-indicator";
  indicator.id = "knobInd_" + paramId;
  indicator.style.background = accentColor;
  face.appendChild(indicator);

  const labelEl = document.createElement("div");
  labelEl.className = "knob-label";
  labelEl.textContent = p.label;

  const valueEl = document.createElement("div");
  valueEl.className = "knob-value";
  valueEl.id = "knobVal_" + paramId;

  wrap.appendChild(bodyEl);
  wrap.appendChild(labelEl);
  wrap.appendChild(valueEl);
  container.appendChild(wrap);

  // Initial render
  refreshKnob(paramId);

  // ── DRAG INTERACTION ──
  let dragStartY = null;
  let dragStartVal = null;

  wrap.addEventListener("mousedown", (e) => {
    e.preventDefault();
    dragStartY = e.clientY;
    dragStartVal = state.values[paramId];
    document.body.style.cursor = "ns-resize";

    const onMove = (me) => {
      const delta = dragStartY - me.clientY; // up = positive
      const range = p.max - p.min;
      const sensitivity = 200; // px for full range
      const newVal = Math.min(p.max, Math.max(p.min, dragStartVal + (delta / sensitivity) * range));
      state.values[paramId] = newVal;
      refreshKnob(paramId);
      console.log(`${paramId}: ${formatValue(paramId)}`);
    };

    const onUp = () => {
      document.body.style.cursor = "default";
      document.removeEventListener("mousemove", onMove);
      document.removeEventListener("mouseup", onUp);
    };

    document.addEventListener("mousemove", onMove);
    document.addEventListener("mouseup", onUp);
  });

  // ── LOCK TOGGLE (right-click or double-click) ──
  wrap.addEventListener("dblclick", (e) => {
    e.preventDefault();
    if (!p.lockable) return;
    state.locked[paramId] = !state.locked[paramId];
    refreshKnob(paramId);
    const status = state.locked[paramId] ? "LOCKED" : "unlocked";
    console.log(`${paramId} ${status}`);
  });

  // Also right-click to toggle lock
  wrap.addEventListener("contextmenu", (e) => {
    e.preventDefault();
    if (!p.lockable) return;
    state.locked[paramId] = !state.locked[paramId];
    refreshKnob(paramId);
    const status = state.locked[paramId] ? "LOCKED" : "unlocked";
    console.log(`${paramId} ${status}`);
    return false;
  });
}

function formatValue(paramId) {
  const p = PARAMS[paramId];
  const v = state.values[paramId];
  if (p.unit === "s") return v.toFixed(1) + "s";
  if (p.unit === "ms") return Math.round(v) + "ms";
  if (p.unit === "Hz") {
    return v < 1 ? v.toFixed(2) + "Hz" : v.toFixed(1) + "Hz";
  }
  if (p.unit === "%") return Math.round(v) + "%";
  return Math.round(v).toString();
}

function normValue(paramId) {
  const p = PARAMS[paramId];
  return (state.values[paramId] - p.min) / (p.max - p.min);
}

function refreshKnob(paramId) {
  const p = PARAMS[paramId];
  const accentColor = SECTION_COLORS[p.section] || "#888888";
  const locked = state.locked[paramId];
  const norm = normValue(paramId);

  const bodyEl = document.getElementById("knobBody_" + paramId);
  const canvas = bodyEl ? bodyEl.querySelector("canvas") : null;
  const valEl  = document.getElementById("knobVal_" + paramId);
  const indEl  = document.getElementById("knobInd_" + paramId);

  if (canvas) drawKnob(canvas, norm, accentColor, locked);

  if (indEl) {
    // Indicator rotation: -135deg (start) to +135deg (end), covering 270deg
    const rot = -135 + norm * 270;
    indEl.style.transform = `rotate(${rot}deg)`;
    indEl.style.background = locked ? accentColor : accentColor;
    indEl.style.opacity = locked ? "0.5" : "1";
  }

  if (bodyEl) {
    if (locked) {
      bodyEl.classList.add("locked");
    } else {
      bodyEl.classList.remove("locked");
    }
  }

  if (valEl) {
    valEl.textContent = formatValue(paramId);
    valEl.style.color = locked ? accentColor + "cc" : "#666666";
  }
}

// ─── HORIZONTAL SLIDER FACTORY ────────────────────────────────────────────────
function buildHSlider(containerId, stateKey, label, min, max, defaultVal, unit, formatFn) {
  const container = document.getElementById(containerId);
  if (!container) return;

  const wrap = document.createElement("div");
  wrap.className = "hslider-wrap";

  const header = document.createElement("div");
  header.className = "hslider-header";

  const labelEl = document.createElement("span");
  labelEl.className = "hslider-label";
  labelEl.textContent = label;

  const valEl = document.createElement("span");
  valEl.className = "hslider-value";
  valEl.id = "hsliderVal_" + stateKey;

  header.appendChild(labelEl);
  header.appendChild(valEl);

  const track = document.createElement("div");
  track.className = "hslider-track";
  track.id = "hsliderTrack_" + stateKey;

  const fill = document.createElement("div");
  fill.className = "hslider-fill";
  fill.id = "hsliderFill_" + stateKey;

  const thumb = document.createElement("div");
  thumb.className = "hslider-thumb";
  thumb.id = "hsliderThumb_" + stateKey;

  track.appendChild(fill);
  track.appendChild(thumb);
  wrap.appendChild(header);
  wrap.appendChild(track);
  container.appendChild(wrap);

  function refreshSlider() {
    const val = state[stateKey];
    const norm = (val - min) / (max - min);
    const trackW = track.offsetWidth || 140;
    fill.style.width = (norm * 100) + "%";
    thumb.style.left = (norm * trackW) + "px";
    valEl.textContent = formatFn(val);
  }

  // Drag
  let dragging = false;
  let startX = null;
  let startVal = null;

  track.addEventListener("mousedown", (e) => {
    e.preventDefault();
    dragging = true;
    startX = e.clientX;
    startVal = state[stateKey];
    document.body.style.cursor = "ew-resize";

    const onMove = (me) => {
      if (!dragging) return;
      const trackW = track.offsetWidth || 140;
      const delta = me.clientX - startX;
      const norm  = Math.max(0, Math.min(1, (startVal - min) / (max - min) + delta / trackW));
      state[stateKey] = min + norm * (max - min);

      if (stateKey === "mutation_interval") {
        state.countdownRemaining = Math.round(state.mutation_interval);
        updateCountdownDisplay();
      }

      refreshSlider();
      console.log(`${stateKey}: ${formatFn(state[stateKey])}`);
    };

    const onUp = () => {
      dragging = false;
      document.body.style.cursor = "default";
      document.removeEventListener("mousemove", onMove);
      document.removeEventListener("mouseup", onUp);
    };

    document.addEventListener("mousemove", onMove);
    document.addEventListener("mouseup", onUp);
  });

  refreshSlider();

  // Expose refresh
  window["_refresh_hslider_" + stateKey] = refreshSlider;
}

// ─── COUNTDOWN TIMER ──────────────────────────────────────────────────────────
const countdownEl = document.getElementById("countdown");

function updateCountdownDisplay() {
  const secs = Math.ceil(state.countdownRemaining);
  const m = Math.floor(secs / 60);
  const s = secs % 60;
  countdownEl.textContent = String(m).padStart(2, "0") + ":" + String(s).padStart(2, "0");

  if (secs <= 5) {
    countdownEl.classList.add("warning");
  } else {
    countdownEl.classList.remove("warning");
  }
}

let lastTimestamp = null;

function tickCountdown(timestamp) {
  if (lastTimestamp !== null) {
    const delta = (timestamp - lastTimestamp) / 1000;
    state.countdownRemaining -= delta;

    if (state.countdownRemaining <= 0) {
      triggerMutation();
      state.countdownRemaining = state.mutation_interval;
    }

    updateCountdownDisplay();
  }
  lastTimestamp = timestamp;
  requestAnimationFrame(tickCountdown);
}

// ─── MUTATION LOGIC ───────────────────────────────────────────────────────────
function triggerMutation() {
  console.log("=== MUTATION EVENT ===");

  for (const [id, p] of Object.entries(PARAMS)) {
    if (!state.locked[id]) {
      // True chaos: any value anywhere in range
      state.values[id] = p.min + Math.random() * (p.max - p.min);
      refreshKnob(id);
      console.log(`  ${id} -> ${formatValue(id)}`);
    } else {
      console.log(`  ${id} LOCKED (skipped)`);
    }
  }

  // Flash overlay
  const flash = document.getElementById("mutationFlash");
  flash.classList.remove("active");
  void flash.offsetWidth; // force reflow
  flash.classList.add("active");

  // Flash mutate button
  const btn = document.getElementById("mutateBtn");
  btn.classList.add("firing");
  setTimeout(() => btn.classList.remove("firing"), 350);
}

// ─── BUILD ALL KNOBS ──────────────────────────────────────────────────────────
function buildAll() {
  // SPACE section (2x2 grid)
  buildKnob("knob_topology",   "topology");
  buildKnob("knob_decay",      "decay");
  buildKnob("knob_pre_delay",  "pre_delay");
  buildKnob("knob_density",    "density");

  // SPECTRAL section (vertical column)
  buildKnob("knob_spectral_tilt", "spectral_tilt");
  buildKnob("knob_resonance",     "resonance");

  // MOTION section (vertical column)
  buildKnob("knob_mod_rate",  "mod_rate");
  buildKnob("knob_mod_depth", "mod_depth");

  // MUTATION section (horizontal sliders)
  buildHSlider(
    "hslider_mutation_interval",
    "mutation_interval",
    "Interval",
    5, 600, 30, "s",
    (v) => {
      if (v >= 60) return Math.round(v / 60) + "m " + Math.round(v % 60) + "s";
      return Math.round(v) + "s";
    }
  );
  buildHSlider(
    "hslider_crossfade_speed",
    "crossfade_speed",
    "Crossfade",
    0, 500, 100, "ms",
    (v) => Math.round(v) + "ms"
  );

  // OUTPUT section (knob row)
  buildKnob("knob_width", "width");
  buildKnob("knob_mix",   "mix");
}

// ─── MUTATE NOW BUTTON ────────────────────────────────────────────────────────
document.getElementById("mutateBtn").addEventListener("click", () => {
  triggerMutation();
  state.countdownRemaining = state.mutation_interval;
  updateCountdownDisplay();
});

// ─── INIT ────────────────────────────────────────────────────────────────────
document.addEventListener("DOMContentLoaded", () => {
  buildAll();
  updateCountdownDisplay();
  requestAnimationFrame(tickCountdown);

  // Tooltip hint
  const hint = document.createElement("div");
  hint.style.cssText = [
    "position:fixed",
    "bottom:6px",
    "right:10px",
    "font-size:7px",
    "letter-spacing:0.08em",
    "color:#333333",
    "font-family:inherit",
    "pointer-events:none",
  ].join(";");
  hint.textContent = "drag knobs to adjust  |  right-click or double-click knob to lock/unlock";
  document.body.appendChild(hint);
});
</script>
</body>
</html>
