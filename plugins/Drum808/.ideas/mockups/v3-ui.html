<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Drum808</title>

  <style>
    /* CRITICAL: WebView constraints */
    html, body {
      height: 100%;  /* REQUIRED - replaces viewport units */
      margin: 0;
      padding: 0;
    }

    *, *::before, *::after {
      box-sizing: border-box;
    }

    body {
      /* Native application feel */
      user-select: none;
      -webkit-user-select: none;
      cursor: default;
      overflow: hidden;

      /* Styling from YAML */
      background: #b8b8b8;
      color: #ffffff;
      font-family: Arial, Helvetica, sans-serif;
      width: 1000px;
      height: 550px;
    }

    .container {
      width: 100%;
      height: 100%;
      position: relative;
    }

    /* Preset browser section */
    .preset-section {
      position: absolute;
      top: 15px;
      left: 0;
      right: 0;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      background: linear-gradient(180deg, #d0d0d0 0%, #b8b8b8 100%);
      border-bottom: 2px solid #8a8a8a;
    }

    .preset-button {
      background: #2a2a2a;
      color: #ffffff;
      border: 1px solid #4a4a4a;
      border-radius: 3px;
      padding: 6px 12px;
      font-size: 11px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.1s;
    }

    .preset-button:hover {
      background: #3a3a3a;
    }

    .preset-button:active {
      background: #1a1a1a;
    }

    .preset-name {
      flex: 1;
      text-align: center;
      font-size: 16px;
      font-weight: bold;
      color: #2a2a2a;
      margin: 0 20px;
    }

    /* Master meter section */
    .master-section {
      position: absolute;
      top: 80px;
      right: 20px;
      width: 30px;
      height: 400px;
    }

    .master-label {
      font-size: 11px;
      color: #2a2a2a;
      text-align: center;
      margin-bottom: 5px;
      font-weight: bold;
    }

    .master-meter {
      width: 20px;
      height: 400px;
      background: #1a1a1a;
      border: 1px solid #8a8a8a;
      position: relative;
      overflow: hidden;
    }

    .master-meter-fill {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 0%;
      background: linear-gradient(to top,
        #00ff00 0%,
        #88ff00 50%,
        #ffff00 70%,
        #ff8800 85%,
        #ff0000 100%
      );
      transition: height 0.05s ease-out;
    }

    /* Channel strip layout */
    .channels {
      position: absolute;
      top: 80px;
      left: 0;
      right: 60px;
      bottom: 20px;
      display: flex;
      justify-content: space-between;
      padding: 0 20px;
    }

    .channel {
      flex: 1;
      max-width: 150px;
      background: #c0c0c0;
      border: 2px solid #8a8a8a;
      border-radius: 4px;
      padding: 10px 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 0 2px;
    }

    .drum-name {
      font-size: 14px;
      font-weight: bold;
      color: #2a2a2a;
      margin-bottom: 8px;
      text-align: center;
    }

    .led-container {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 10px;
    }

    .led {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #2a2a2a;
      box-shadow: inset 0 1px 2px rgba(0,0,0,0.5);
      transition: background 0.05s;
    }

    .led.active {
      background: #ff4500;
      box-shadow: 0 0 8px #ff4500, inset 0 1px 2px rgba(255,255,255,0.3);
    }

    .routing-indicator {
      width: 10px;
      height: 10px;
      border-radius: 2px;
      background: #2a2a2a;
      border: 1px solid #4a4a4a;
      transition: background 0.1s;
    }

    .routing-indicator.active {
      background: #ffa500;
      box-shadow: 0 0 4px #ffa500;
    }

    .controls {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 12px;
      width: 100%;
    }

    .control {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }

    .knob-container {
      width: 60px;
      height: 60px;
      position: relative;
    }

    .knob-canvas {
      width: 100%;
      height: 100%;
    }

    .control-label {
      font-size: 11px;
      color: #ffffff;
      font-weight: bold;
      text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    }

    .control-value {
      font-size: 10px;
      color: #e0e0e0;
    }

    /* Input range (hidden, used for state) */
    input[type="range"] {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Preset Browser -->
    <div class="preset-section">
      <button class="preset-button" id="preset-previous">PREV</button>
      <div class="preset-name" id="preset-name">INIT PRESET</div>
      <button class="preset-button" id="preset-save">SAVE</button>
      <button class="preset-button" id="preset-next">NEXT</button>
    </div>

    <!-- Master Meter -->
    <div class="master-section">
      <div class="master-label">MASTER</div>
      <div class="master-meter">
        <div class="master-meter-fill" id="master-meter-fill"></div>
      </div>
    </div>

    <!-- Channel Strips -->
    <div class="channels">
      <!-- KICK -->
      <div class="channel">
        <div class="drum-name">KICK</div>
        <div class="led-container">
          <div class="led" id="kick-led"></div>
          <div class="routing-indicator active" id="kick-routing" title="Individual Output"></div>
        </div>
        <div class="controls">
          <div class="control">
            <div class="knob-container">
              <canvas class="knob-canvas" id="kick-level-knob" width="60" height="60"></canvas>
            </div>
            <div class="control-label">LEVEL</div>
            <div class="control-value" id="kick-level-value">80%</div>
          </div>
          <div class="control">
            <div class="knob-container">
              <canvas class="knob-canvas" id="kick-tone-knob" width="60" height="60"></canvas>
            </div>
            <div class="control-label">TONE</div>
            <div class="control-value" id="kick-tone-value">50%</div>
          </div>
          <div class="control">
            <div class="knob-container">
              <canvas class="knob-canvas" id="kick-decay-knob" width="60" height="60"></canvas>
            </div>
            <div class="control-label">DECAY</div>
            <div class="control-value" id="kick-decay-value">400ms</div>
          </div>
          <div class="control">
            <div class="knob-container">
              <canvas class="knob-canvas" id="kick-tuning-knob" width="60" height="60"></canvas>
            </div>
            <div class="control-label">TUNING</div>
            <div class="control-value" id="kick-tuning-value">0st</div>
          </div>
        </div>
      </div>

      <!-- LOW TOM -->
      <div class="channel">
        <div class="drum-name">LOW TOM</div>
        <div class="led-container">
          <div class="led" id="lowtom-led"></div>
          <div class="routing-indicator active" id="lowtom-routing" title="Individual Output"></div>
        </div>
        <div class="controls">
          <div class="control">
            <div class="knob-container">
              <canvas class="knob-canvas" id="lowtom-level-knob" width="60" height="60"></canvas>
            </div>
            <div class="control-label">LEVEL</div>
            <div class="control-value" id="lowtom-level-value">75%</div>
          </div>
          <div class="control">
            <div class="knob-container">
              <canvas class="knob-canvas" id="lowtom-tone-knob" width="60" height="60"></canvas>
            </div>
            <div class="control-label">TONE</div>
            <div class="control-value" id="lowtom-tone-value">50%</div>
          </div>
          <div class="control">
            <div class="knob-container">
              <canvas class="knob-canvas" id="lowtom-decay-knob" width="60" height="60"></canvas>
            </div>
            <div class="control-label">DECAY</div>
            <div class="control-value" id="lowtom-decay-value">300ms</div>
          </div>
          <div class="control">
            <div class="knob-container">
              <canvas class="knob-canvas" id="lowtom-tuning-knob" width="60" height="60"></canvas>
            </div>
            <div class="control-label">TUNING</div>
            <div class="control-value" id="lowtom-tuning-value">0st</div>
          </div>
        </div>
      </div>

      <!-- MID TOM -->
      <div class="channel">
        <div class="drum-name">MID TOM</div>
        <div class="led-container">
          <div class="led" id="midtom-led"></div>
          <div class="routing-indicator active" id="midtom-routing" title="Individual Output"></div>
        </div>
        <div class="controls">
          <div class="control">
            <div class="knob-container">
              <canvas class="knob-canvas" id="midtom-level-knob" width="60" height="60"></canvas>
            </div>
            <div class="control-label">LEVEL</div>
            <div class="control-value" id="midtom-level-value">75%</div>
          </div>
          <div class="control">
            <div class="knob-container">
              <canvas class="knob-canvas" id="midtom-tone-knob" width="60" height="60"></canvas>
            </div>
            <div class="control-label">TONE</div>
            <div class="control-value" id="midtom-tone-value">50%</div>
          </div>
          <div class="control">
            <div class="knob-container">
              <canvas class="knob-canvas" id="midtom-decay-knob" width="60" height="60"></canvas>
            </div>
            <div class="control-label">DECAY</div>
            <div class="control-value" id="midtom-decay-value">250ms</div>
          </div>
          <div class="control">
            <div class="knob-container">
              <canvas class="knob-canvas" id="midtom-tuning-knob" width="60" height="60"></canvas>
            </div>
            <div class="control-label">TUNING</div>
            <div class="control-value" id="midtom-tuning-value">+5st</div>
          </div>
        </div>
      </div>

      <!-- CLAP -->
      <div class="channel">
        <div class="drum-name">CLAP</div>
        <div class="led-container">
          <div class="led" id="clap-led"></div>
          <div class="routing-indicator active" id="clap-routing" title="Individual Output"></div>
        </div>
        <div class="controls">
          <div class="control">
            <div class="knob-container">
              <canvas class="knob-canvas" id="clap-level-knob" width="60" height="60"></canvas>
            </div>
            <div class="control-label">LEVEL</div>
            <div class="control-value" id="clap-level-value">70%</div>
          </div>
          <div class="control">
            <div class="knob-container">
              <canvas class="knob-canvas" id="clap-tone-knob" width="60" height="60"></canvas>
            </div>
            <div class="control-label">TONE</div>
            <div class="control-value" id="clap-tone-value">50%</div>
          </div>
          <div class="control">
            <div class="knob-container">
              <canvas class="knob-canvas" id="clap-snap-knob" width="60" height="60"></canvas>
            </div>
            <div class="control-label">SNAP</div>
            <div class="control-value" id="clap-snap-value">60%</div>
          </div>
          <div class="control">
            <div class="knob-container">
              <canvas class="knob-canvas" id="clap-tuning-knob" width="60" height="60"></canvas>
            </div>
            <div class="control-label">TUNING</div>
            <div class="control-value" id="clap-tuning-value">0st</div>
          </div>
        </div>
      </div>

      <!-- CLOSED HAT -->
      <div class="channel">
        <div class="drum-name">CLOSED HAT</div>
        <div class="led-container">
          <div class="led" id="closedhat-led"></div>
          <div class="routing-indicator active" id="closedhat-routing" title="Individual Output"></div>
        </div>
        <div class="controls">
          <div class="control">
            <div class="knob-container">
              <canvas class="knob-canvas" id="closedhat-level-knob" width="60" height="60"></canvas>
            </div>
            <div class="control-label">LEVEL</div>
            <div class="control-value" id="closedhat-level-value">65%</div>
          </div>
          <div class="control">
            <div class="knob-container">
              <canvas class="knob-canvas" id="closedhat-tone-knob" width="60" height="60"></canvas>
            </div>
            <div class="control-label">TONE</div>
            <div class="control-value" id="closedhat-tone-value">60%</div>
          </div>
          <div class="control">
            <div class="knob-container">
              <canvas class="knob-canvas" id="closedhat-decay-knob" width="60" height="60"></canvas>
            </div>
            <div class="control-label">DECAY</div>
            <div class="control-value" id="closedhat-decay-value">80ms</div>
          </div>
          <div class="control">
            <div class="knob-container">
              <canvas class="knob-canvas" id="closedhat-tuning-knob" width="60" height="60"></canvas>
            </div>
            <div class="control-label">TUNING</div>
            <div class="control-value" id="closedhat-tuning-value">0st</div>
          </div>
        </div>
      </div>

      <!-- OPEN HAT -->
      <div class="channel">
        <div class="drum-name">OPEN HAT</div>
        <div class="led-container">
          <div class="led" id="openhat-led"></div>
          <div class="routing-indicator active" id="openhat-routing" title="Individual Output"></div>
        </div>
        <div class="controls">
          <div class="control">
            <div class="knob-container">
              <canvas class="knob-canvas" id="openhat-level-knob" width="60" height="60"></canvas>
            </div>
            <div class="control-label">LEVEL</div>
            <div class="control-value" id="openhat-level-value">60%</div>
          </div>
          <div class="control">
            <div class="knob-container">
              <canvas class="knob-canvas" id="openhat-tone-knob" width="60" height="60"></canvas>
            </div>
            <div class="control-label">TONE</div>
            <div class="control-value" id="openhat-tone-value">60%</div>
          </div>
          <div class="control">
            <div class="knob-container">
              <canvas class="knob-canvas" id="openhat-decay-knob" width="60" height="60"></canvas>
            </div>
            <div class="control-label">DECAY</div>
            <div class="control-value" id="openhat-decay-value">500ms</div>
          </div>
          <div class="control">
            <div class="knob-container">
              <canvas class="knob-canvas" id="openhat-tuning-knob" width="60" height="60"></canvas>
            </div>
            <div class="control-label">TUNING</div>
            <div class="control-value" id="openhat-tuning-value">0st</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    // ====================================================================
    // JUCE FRONTEND LIBRARY IMPORT
    // ====================================================================

    import { getSliderState, getToggleState } from "./js/juce/index.js";

    // ====================================================================
    // NATIVE APPLICATION FEEL
    // ====================================================================

    // Disable right-click context menu (REQUIRED)
    document.addEventListener("contextmenu", (e) => {
      e.preventDefault();
      return false;
    });

    // Disable default drag behaviors
    document.addEventListener("dragstart", (e) => {
      e.preventDefault();
    });

    // ====================================================================
    // KNOB RENDERING
    // ====================================================================

    function drawKnob(canvas, value) {
      const ctx = canvas.getContext('2d');
      const centerX = canvas.width / 2;
      const centerY = canvas.height / 2;
      const radius = 26;

      // Clear canvas
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Draw knob body
      const gradient = ctx.createRadialGradient(centerX - 8, centerY - 8, 5, centerX, centerY, radius);
      gradient.addColorStop(0, '#3a3a3a');
      gradient.addColorStop(1, '#2a2a2a');
      ctx.fillStyle = gradient;
      ctx.beginPath();
      ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
      ctx.fill();

      // Draw outer ring
      ctx.strokeStyle = '#1a1a1a';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
      ctx.stroke();

      // Draw value arc
      const startAngle = Math.PI * 0.75;
      const endAngle = Math.PI * 0.25;
      const range = endAngle - startAngle + Math.PI * 2;
      const valueAngle = startAngle + (range * value);

      ctx.strokeStyle = '#4a9eff';
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.arc(centerX, centerY, radius - 4, startAngle, valueAngle);
      ctx.stroke();

      // Draw indicator line
      ctx.strokeStyle = '#ffffff';
      ctx.lineWidth = 2;
      ctx.beginPath();
      const indicatorLength = radius - 8;
      ctx.moveTo(centerX, centerY);
      ctx.lineTo(
        centerX + Math.cos(valueAngle - Math.PI / 2) * indicatorLength,
        centerY + Math.sin(valueAngle - Math.PI / 2) * indicatorLength
      );
      ctx.stroke();

      // Draw center dot
      ctx.fillStyle = '#ffffff';
      ctx.beginPath();
      ctx.arc(centerX, centerY, 3, 0, Math.PI * 2);
      ctx.fill();
    }

    // ====================================================================
    // PARAMETER BINDINGS
    // ====================================================================

    const parameters = [
      // Kick drum
      { id: 'kick_level', min: 0, max: 100, unit: '%', canvas: 'kick-level-knob', display: 'kick-level-value' },
      { id: 'kick_tone', min: 0, max: 100, unit: '%', canvas: 'kick-tone-knob', display: 'kick-tone-value' },
      { id: 'kick_decay', min: 50, max: 1000, unit: 'ms', canvas: 'kick-decay-knob', display: 'kick-decay-value' },
      { id: 'kick_tuning', min: -12, max: 12, unit: 'st', canvas: 'kick-tuning-knob', display: 'kick-tuning-value' },

      // Low tom
      { id: 'lowtom_level', min: 0, max: 100, unit: '%', canvas: 'lowtom-level-knob', display: 'lowtom-level-value' },
      { id: 'lowtom_tone', min: 0, max: 100, unit: '%', canvas: 'lowtom-tone-knob', display: 'lowtom-tone-value' },
      { id: 'lowtom_decay', min: 50, max: 1000, unit: 'ms', canvas: 'lowtom-decay-knob', display: 'lowtom-decay-value' },
      { id: 'lowtom_tuning', min: -12, max: 12, unit: 'st', canvas: 'lowtom-tuning-knob', display: 'lowtom-tuning-value' },

      // Mid tom
      { id: 'midtom_level', min: 0, max: 100, unit: '%', canvas: 'midtom-level-knob', display: 'midtom-level-value' },
      { id: 'midtom_tone', min: 0, max: 100, unit: '%', canvas: 'midtom-tone-knob', display: 'midtom-tone-value' },
      { id: 'midtom_decay', min: 50, max: 1000, unit: 'ms', canvas: 'midtom-decay-knob', display: 'midtom-decay-value' },
      { id: 'midtom_tuning', min: -12, max: 12, unit: 'st', canvas: 'midtom-tuning-knob', display: 'midtom-tuning-value' },

      // Clap
      { id: 'clap_level', min: 0, max: 100, unit: '%', canvas: 'clap-level-knob', display: 'clap-level-value' },
      { id: 'clap_tone', min: 0, max: 100, unit: '%', canvas: 'clap-tone-knob', display: 'clap-tone-value' },
      { id: 'clap_snap', min: 0, max: 100, unit: '%', canvas: 'clap-snap-knob', display: 'clap-snap-value' },
      { id: 'clap_tuning', min: -12, max: 12, unit: 'st', canvas: 'clap-tuning-knob', display: 'clap-tuning-value' },

      // Closed hat
      { id: 'closedhat_level', min: 0, max: 100, unit: '%', canvas: 'closedhat-level-knob', display: 'closedhat-level-value' },
      { id: 'closedhat_tone', min: 0, max: 100, unit: '%', canvas: 'closedhat-tone-knob', display: 'closedhat-tone-value' },
      { id: 'closedhat_decay', min: 20, max: 200, unit: 'ms', canvas: 'closedhat-decay-knob', display: 'closedhat-decay-value' },
      { id: 'closedhat_tuning', min: -12, max: 12, unit: 'st', canvas: 'closedhat-tuning-knob', display: 'closedhat-tuning-value' },

      // Open hat
      { id: 'openhat_level', min: 0, max: 100, unit: '%', canvas: 'openhat-level-knob', display: 'openhat-level-value' },
      { id: 'openhat_tone', min: 0, max: 100, unit: '%', canvas: 'openhat-tone-knob', display: 'openhat-tone-value' },
      { id: 'openhat_decay', min: 100, max: 1000, unit: 'ms', canvas: 'openhat-decay-knob', display: 'openhat-decay-value' },
      { id: 'openhat_tuning', min: -12, max: 12, unit: 'st', canvas: 'openhat-tuning-knob', display: 'openhat-tuning-value' }
    ];

    // Initialize parameter bindings
    document.addEventListener("DOMContentLoaded", () => {
      parameters.forEach(param => {
        const canvas = document.getElementById(param.canvas);
        const display = document.getElementById(param.display);
        const state = getSliderState(param.id);

        if (!canvas || !display || !state) return;

        // Update function
        const updateValue = (normalized) => {
          const value = param.min + (param.max - param.min) * normalized;
          let displayValue;

          if (param.unit === 'st') {
            displayValue = (value >= 0 ? '+' : '') + Math.round(value) + param.unit;
          } else {
            displayValue = Math.round(value) + param.unit;
          }

          display.textContent = displayValue;
          drawKnob(canvas, normalized);
        };

        // Initialize from current state
        updateValue(state.getNormalisedValue());

        // HTML → C++ (user drag interaction)
        let isDragging = false;
        let lastY = 0;

        canvas.addEventListener('mousedown', (e) => {
          isDragging = true;
          lastY = e.clientY;
          e.preventDefault();
        });

        document.addEventListener('mousemove', (e) => {
          if (!isDragging) return;

          const delta = (lastY - e.clientY) / 100;
          let newValue = state.getNormalisedValue() + delta;
          newValue = Math.max(0, Math.min(1, newValue));

          state.setNormalisedValue(newValue);
          updateValue(newValue);
          lastY = e.clientY;
        });

        document.addEventListener('mouseup', () => {
          isDragging = false;
        });

        // C++ → HTML (automation, preset recall)
        state.valueChangedEvent.addListener(() => {
          updateValue(state.getNormalisedValue());
        });
      });

      // Preset buttons
      const presetPreviousState = getToggleState('preset_previous');
      const presetNextState = getToggleState('preset_next');
      const presetSaveState = getToggleState('preset_save');

      document.getElementById('preset-previous').addEventListener('click', () => {
        presetPreviousState.setNormalisedValue(1.0);
      });

      document.getElementById('preset-next').addEventListener('click', () => {
        presetNextState.setNormalisedValue(1.0);
      });

      document.getElementById('preset-save').addEventListener('click', () => {
        presetSaveState.setNormalisedValue(1.0);
      });

      console.log("Drum808 UI initialized - 24 parameters bound");
    });
  </script>
</body>
</html>
