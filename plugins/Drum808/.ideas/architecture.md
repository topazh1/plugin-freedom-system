# DSP Architecture: Drum808

**CRITICAL CONTRACT:** This specification is immutable during Stages 2-5 implementation. Stage 1 Planning cannot proceed without this file. Stage 4 (DSP) implements this exact architecture.

**Generated by:** Stage 0 Research (research-planning-agent)
**Generated date:** 2025-11-13
**Referenced by:** Stage 1 (Planning), Stage 4 (DSP Implementation)
**Purpose:** DSP specification defining processing components, signal flow, and JUCE module usage

---

## Core Components

### Kick Drum Voice

- **JUCE Class:** Custom implementation using `juce::dsp::Oscillator<float>` + custom exponential envelopes
- **Purpose:** Generate authentic 808 kick using bridged-T twin oscillator emulation
- **Parameters Affected:** kick_level, kick_tone, kick_decay, kick_tuning
- **Configuration:**
  - Base frequency: ~60 Hz (tunable ±12 semitones)
  - Body oscillator: `juce::dsp::Oscillator<float>` configured for sine wave
  - Attack transient: Short noise burst scaled by tone parameter
  - Pitch envelope: Exponential sweep from 2× base frequency to base frequency
  - Amplitude envelope: Exponential decay from 1.0 to 0.0 over decay time
  - Damping factor: Amplitude × exponential decay creates self-damping resonance

**Algorithm:** Bridged-T emulation using damped sine wave
```cpp
// Pitch envelope (exponential)
freq = baseFreq * (1.0 + exp(-time / pitchDecayTime));

// Body tone (sine oscillator)
bodySignal = sin(phase) * exp(-time / amplitudeDecayTime);

// Attack transient (noise burst, scaled by tone)
attackSignal = noise() * exp(-time / 0.005) * toneAmount;

// Final output
kickOutput = (bodySignal + attackSignal) * levelParam * velocityGain;
```

---

### Low Tom Voice

- **JUCE Class:** Custom implementation using `juce::dsp::Oscillator<float>` + `juce::dsp::StateVariableTPTFilter<float>`
- **Purpose:** Generate 808 low tom using bridged-T oscillator with tuned resonance
- **Parameters Affected:** lowtom_level, lowtom_tone, lowtom_decay, lowtom_tuning
- **Configuration:**
  - Base frequency: ~150 Hz (tunable ±12 semitones)
  - Oscillator: `juce::dsp::Oscillator<float>` configured for sine wave
  - Resonance filter: `juce::dsp::StateVariableTPTFilter<float>` in bandpass mode
  - Filter Q controlled by tone parameter (0.5 to 5.0)
  - Exponential amplitude envelope (no pitch envelope, unlike kick)

**Algorithm:** Bridged-T with resonant bandpass
```cpp
// Sine oscillator at tuned frequency
toneSignal = sin(phase);

// Bandpass filter with resonance controlled by tone
filterQ = 0.5 + (toneParam * 4.5); // Maps 0-100% to Q 0.5-5.0
filteredSignal = bandpass(toneSignal, baseFreq, filterQ);

// Exponential decay envelope
output = filteredSignal * exp(-time / decayTime) * levelParam * velocityGain;
```

---

### Mid Tom Voice

- **JUCE Class:** Same as Low Tom (shared implementation)
- **Purpose:** Generate 808 mid tom (identical architecture to low tom, tuned higher)
- **Parameters Affected:** midtom_level, midtom_tone, midtom_decay, midtom_tuning
- **Configuration:**
  - Base frequency: ~220 Hz (default +5 semitones vs low tom, tunable ±12 semitones)
  - All other parameters identical to Low Tom
  - Can share voice class with Low Tom (different base frequency only)

---

### Clap Voice

- **JUCE Class:** Custom multi-trigger envelope + `juce::dsp::StateVariableTPTFilter<float>` + noise generator
- **Purpose:** Generate 808 clap using filtered noise with multi-spike envelope
- **Parameters Affected:** clap_level, clap_tone, clap_snap, clap_tuning
- **Configuration:**
  - Noise source: `juce::Random::getSystemRandom().nextFloat() * 2.0f - 1.0f` (white noise)
  - Bandpass filter: Center frequency ~1000 Hz (tunable ±12 semitones), resonance controlled by tone
  - Multi-trigger envelope: 3 spikes spaced 10ms apart, followed by long decay
    - Spike 1 at t=0ms: Amplitude = snapParam (0.0-1.0)
    - Spike 2 at t=10ms: Amplitude = snapParam × 0.6
    - Spike 3 at t=20ms: Amplitude = snapParam × 0.3
    - Decay tail: Exponential decay from t=30ms to t=1964ms
  - Snap parameter controls initial transient intensity (attack amplitude)

**Algorithm:** Multi-trigger envelope with filtered noise
```cpp
// White noise generation
noise = random.nextFloat() * 2.0f - 1.0f;

// Bandpass filter (1000 Hz center, tunable)
centerFreq = 1000.0 * pow(2.0, tuningParam / 12.0);
filterQ = 2.0 + (toneParam * 3.0); // Q range 2.0-5.0
filteredNoise = bandpass(noise, centerFreq, filterQ);

// Multi-trigger envelope (3 spikes)
envelope = 0.0;
if (time < 0.010) envelope = snapParam * exp(-time / 0.003);
else if (time < 0.020) envelope = snapParam * 0.6 * exp(-(time - 0.010) / 0.003);
else if (time < 0.030) envelope = snapParam * 0.3 * exp(-(time - 0.020) / 0.003);
else envelope = exp(-(time - 0.030) / 1.934); // Long decay tail

output = filteredNoise * envelope * levelParam * velocityGain;
```

---

### Closed Hi-Hat Voice

- **JUCE Class:** 6× `juce::dsp::Oscillator<float>` (square wave) + `juce::dsp::StateVariableTPTFilter<float>`
- **Purpose:** Generate metallic hi-hat using six-oscillator synthesis with bandpass filtering
- **Parameters Affected:** closedhat_level, closedhat_tone, closedhat_decay, closedhat_tuning
- **Configuration:**
  - Six square wave oscillators with inharmonic frequency ratios:
    - Osc 1: Base frequency (e.g., 3500 Hz)
    - Osc 2: Base × 1.4
    - Osc 3: Base × 1.7
    - Osc 4: Base × 2.1
    - Osc 5: Base × 2.5
    - Osc 6: Base × 3.0
  - All oscillators use `juce::dsp::Oscillator<float>` configured for square wave
  - Bandpass filter: Center frequency controlled by tone parameter (6-12 kHz range)
  - Short exponential decay envelope (20-200ms)
  - Base frequency tunable ±12 semitones

**Algorithm:** Six-oscillator metallic synthesis
```cpp
// Six square wave oscillators
const float ratios[6] = {1.0, 1.4, 1.7, 2.1, 2.5, 3.0};
float baseFreq = 3500.0 * pow(2.0, tuningParam / 12.0);
float mixedSignal = 0.0;

for (int i = 0; i < 6; i++) {
    float freq = baseFreq * ratios[i];
    mixedSignal += squareWave(phase[i], freq) / 6.0;
}

// Bandpass filtering for metallic character
float centerFreq = 6000.0 + (toneParam * 6000.0); // 6-12 kHz
filteredSignal = bandpass(mixedSignal, centerFreq, 4.0);

// Short decay envelope
output = filteredSignal * exp(-time / decayTime) * levelParam * velocityGain;
```

---

### Open Hi-Hat Voice

- **JUCE Class:** Same as Closed Hi-Hat (shared six-oscillator implementation)
- **Purpose:** Generate open hi-hat (identical to closed hat but longer decay)
- **Parameters Affected:** openhat_level, openhat_tone, openhat_decay, openhat_tuning
- **Configuration:**
  - Identical oscillator and filter architecture to Closed Hi-Hat
  - Longer decay envelope (100-1000ms vs 20-200ms)
  - Subject to choking logic (stopped when closed hat triggers)

---

### MIDI Note Router

- **JUCE Class:** Custom implementation using `juce::MidiBuffer` and `juce::MidiMessage`
- **Purpose:** Map incoming MIDI note numbers to drum voice triggers
- **Configuration:**
  - Note 36 (C1) → Kick
  - Note 38 (D1) → Clap
  - Note 41 (F1) → Low Tom
  - Note 45 (A1) → Mid Tom
  - Note 42 (F#1) → Closed Hi-Hat
  - Note 46 (A#1) → Open Hi-Hat
  - Omni mode (responds to all MIDI channels)
  - Velocity extracted and mapped to voice gain (0-127 → 0.0-1.0)

---

### Voice Choking System

- **JUCE Class:** Custom implementation (state tracking)
- **Purpose:** Implement closed hat choking open hat (authentic 808 behavior)
- **Configuration:**
  - Track open hat voice state (playing/stopped)
  - When closed hat triggers (note 42), immediately stop open hat voice
  - Sample-accurate choking (both notes can arrive in same buffer)
  - Choking happens before envelope trigger (prevents clicks)

---

## Processing Chain

```
MIDI Input (MidiBuffer from host)
  ↓
MIDI Note Router
  ├─ Note 36 → Kick Voice ───────────┐
  ├─ Note 38 → Clap Voice ───────────┤
  ├─ Note 41 → Low Tom Voice ────────┤
  ├─ Note 45 → Mid Tom Voice ────────┤
  ├─ Note 42 → Closed Hat Voice ─────┤ (triggers choking)
  │            ↓                      │
  │     Voice Choking System          │
  │            ↓                      │
  └─ Note 46 → Open Hat Voice ───────┘ (stopped by choke)
                ↓
    (All voices process in parallel)
                ↓
         Voice Synthesis
         (per-voice oscillators + envelopes)
                ↓
         Velocity Scaling
         (MIDI velocity → gain 0.0-1.0)
                ↓
         Per-Voice Tuning
         (±12 semitones frequency shift)
                ↓
         Multi-Output Routing
         ├─ Main Mix Output (bus 0, stereo)
         ├─ Kick Output (bus 1, stereo)
         ├─ Low Tom Output (bus 2, stereo)
         ├─ Mid Tom Output (bus 3, stereo)
         ├─ Clap Output (bus 4, stereo)
         ├─ Closed Hat Output (bus 5, stereo)
         └─ Open Hat Output (bus 6, stereo)
```

**Routing notes:**
- MIDI processing happens first (iterate MidiBuffer at start of processBlock)
- Voice choking checked before triggering (closed hat note-on stops open hat immediately)
- All voices synthesize in parallel (no inter-voice dependencies except choking)
- Each voice writes to BOTH main mix AND individual output bus
- Individual outputs are optional (DAW may not enable them)

---

## System Architecture

### Multi-Output Routing

**Bus configuration:**
- No audio input (instrument plugin, MIDI-triggered only)
- Main stereo output (channels 0-1)
- 6 individual stereo outputs (channels 2-3, 4-5, 6-7, 8-9, 10-11, 12-13)
- Total: 0 input channels, 14 output channels (7 stereo buses)

**JUCE setup:**
```cpp
// In AudioProcessor constructor initializer list
AudioProcessor(BusesProperties()
    .withOutput("Main", juce::AudioChannelSet::stereo(), true)
    .withOutput("Kick", juce::AudioChannelSet::stereo(), false)
    .withOutput("Low Tom", juce::AudioChannelSet::stereo(), false)
    .withOutput("Mid Tom", juce::AudioChannelSet::stereo(), false)
    .withOutput("Clap", juce::AudioChannelSet::stereo(), false)
    .withOutput("Closed Hat", juce::AudioChannelSet::stereo(), false)
    .withOutput("Open Hat", juce::AudioChannelSet::stereo(), false))
```

**CRITICAL:** BusesProperties MUST be in constructor initializer list, NOT prepareToPlay() (see juce8-critical-patterns.md Pattern 4)

**Output mapping:**
- Main output (bus 0): Mixed output of all 6 voices
- Kick output (bus 1): Isolated kick voice
- Low Tom output (bus 2): Isolated low tom voice
- Mid Tom output (bus 3): Isolated mid tom voice
- Clap output (bus 4): Isolated clap voice
- Closed Hat output (bus 5): Isolated closed hat voice
- Open Hat output (bus 6): Isolated open hat voice

**DAW compatibility notes:**
- Logic Pro: Full support for 14-channel output
- Ableton Live: Supports multi-output via "Configure" in plugin device
- FL Studio: Supports via "Split mixer tracks"
- Reaper: Full multi-output support
- Fallback: If DAW doesn't enable individual outputs, all audio routes to main output only

---

### MIDI Routing

**Input handling:** Omni mode (responds to all MIDI channels)

**Note mapping:**
- MIDI note 36 (C1) → Kick
- MIDI note 38 (D1) → Clap
- MIDI note 41 (F1) → Low Tom
- MIDI note 45 (A1) → Mid Tom
- MIDI note 42 (F#1) → Closed Hi-Hat
- MIDI note 46 (A#1) → Open Hi-Hat
- Velocity → Affects output level (0-127 mapped to 0.0-1.0 gain)
- Notes outside mapped range → Ignored

**JUCE classes:**
- `juce::MidiBuffer` - MIDI event storage (passed to processBlock)
- `juce::MidiMessage::getNoteNumber()` - Extract note number
- `juce::MidiMessage::getVelocity()` - Extract velocity
- `juce::MidiMessage::isNoteOn()` / `isNoteOff()` - Message type detection

**Processing:**
```cpp
// In processBlock()
for (const auto metadata : midiMessages)
{
    auto message = metadata.getMessage();

    if (message.isNoteOn())
    {
        int note = message.getNoteNumber();
        float velocity = message.getVelocity() / 127.0f;
        int samplePosition = metadata.samplePosition;

        // Map note to voice
        if (note == 36) triggerKick(velocity, samplePosition);
        else if (note == 38) triggerClap(velocity, samplePosition);
        else if (note == 41) triggerLowTom(velocity, samplePosition);
        else if (note == 45) triggerMidTom(velocity, samplePosition);
        else if (note == 42) {
            chokeOpenHat(); // Stop open hat first
            triggerClosedHat(velocity, samplePosition);
        }
        else if (note == 46) triggerOpenHat(velocity, samplePosition);
    }
}
```

---

### State Persistence

**What state is saved:**
- APVTS parameters: All 24 parameters (6 voices × 4 params) - automatic via APVTS
- No custom state needed (no folder paths, user files, or UI-only state)

**Serialization format:**
- APVTS parameters: Automatic via `AudioProcessorValueTreeState` (XML via ValueTree)

**JUCE classes:**
- `juce::AudioProcessorValueTreeState` - Parameter persistence (automatic)

**Restore behavior:**
- All state is APVTS parameters (automatic restore)
- No file paths or external resources to validate
- No version migration needed (standard parameter restore)

---

## Parameter Mapping

| Parameter ID | Type | Range | DSP Component | Usage |
|-------------|------|-------|---------------|-------|
| kick_level | Float | 0-100% | Kick Voice | Output gain (0.0-1.0) |
| kick_tone | Float | 0-100% | Kick Voice | Attack transient amount (0.0-1.0) |
| kick_decay | Float | 50-1000ms | Kick Voice | Amplitude envelope decay time |
| kick_tuning | Float | -12 to +12 st | Kick Voice | Base frequency offset (semitones) |
| lowtom_level | Float | 0-100% | Low Tom Voice | Output gain (0.0-1.0) |
| lowtom_tone | Float | 0-100% | Low Tom Voice | Bandpass filter Q (0.5-5.0) |
| lowtom_decay | Float | 50-1000ms | Low Tom Voice | Amplitude envelope decay time |
| lowtom_tuning | Float | -12 to +12 st | Low Tom Voice | Base frequency offset (semitones) |
| midtom_level | Float | 0-100% | Mid Tom Voice | Output gain (0.0-1.0) |
| midtom_tone | Float | 0-100% | Mid Tom Voice | Bandpass filter Q (0.5-5.0) |
| midtom_decay | Float | 50-1000ms | Mid Tom Voice | Amplitude envelope decay time |
| midtom_tuning | Float | -12 to +12 st | Mid Tom Voice | Base frequency offset (semitones) |
| clap_level | Float | 0-100% | Clap Voice | Output gain (0.0-1.0) |
| clap_tone | Float | 0-100% | Clap Voice | Bandpass filter Q (2.0-5.0) |
| clap_snap | Float | 0-100% | Clap Voice | Initial spike amplitude (0.0-1.0) |
| clap_tuning | Float | -12 to +12 st | Clap Voice | Bandpass center frequency offset (semitones) |
| closedhat_level | Float | 0-100% | Closed Hat Voice | Output gain (0.0-1.0) |
| closedhat_tone | Float | 0-100% | Closed Hat Voice | Bandpass center frequency (6-12 kHz) |
| closedhat_decay | Float | 20-200ms | Closed Hat Voice | Amplitude envelope decay time |
| closedhat_tuning | Float | -12 to +12 st | Closed Hat Voice | Base frequency offset (semitones) |
| openhat_level | Float | 0-100% | Open Hat Voice | Output gain (0.0-1.0) |
| openhat_tone | Float | 0-100% | Open Hat Voice | Bandpass center frequency (6-12 kHz) |
| openhat_decay | Float | 100-1000ms | Open Hat Voice | Amplitude envelope decay time |
| openhat_tuning | Float | -12 to +12 st | Open Hat Voice | Base frequency offset (semitones) |

---

## Algorithm Details

### Bridged-T Oscillator (Kick, Toms)

**Algorithm:** Damped sine wave with exponential pitch envelope

**Implementation notes:**
- Pitch envelope: `freq(t) = baseFreq × (1.0 + exp(-t / τ_pitch))`
  - τ_pitch = 0.02 seconds (20ms pitch decay constant)
  - Sweeps from 2× base frequency down to base frequency
  - Creates characteristic "boom" of 808 kick/toms
- Amplitude envelope: `amp(t) = exp(-t / τ_amp)`
  - τ_amp = decay parameter (50-1000ms)
  - Pure exponential decay (authentic analog behavior)
- Phase accumulator wraps at 2π (prevents accumulation errors)
- No oversampling needed (low-frequency content only)

---

### Clap Multi-Trigger Envelope

**Algorithm:** Three discrete envelope spikes followed by long decay

**Implementation notes:**
- Spike timing: 0ms, 10ms, 20ms (fixed timing, sample-rate independent)
- Spike amplitudes: `snap × 1.0`, `snap × 0.6`, `snap × 0.3`
- Each spike: `amp = spikeAmp × exp(-Δt / 0.003)` where Δt is time since spike start
- Decay tail: `amp = exp(-(t - 0.030) / 1.934)` for t > 30ms
- Implementation: State machine with 4 states (spike1, spike2, spike3, decay)
- State transitions at exact sample positions (10ms = sampleRate × 0.01 samples)

---

### Six-Oscillator Metallic Synthesis (Hi-Hats)

**Algorithm:** Inharmonic square wave oscillators with bandpass filtering

**Implementation notes:**
- Frequency ratios: {1.0, 1.4, 1.7, 2.1, 2.5, 3.0}
  - Based on 808 hardware oscillator tuning
  - Creates inharmonic spectrum (metallic character)
- Each oscillator: `juce::dsp::Oscillator<float>` configured for square wave
- Mixed equally: `output = (osc1 + osc2 + osc3 + osc4 + osc5 + osc6) / 6.0`
- Bandpass filter after mixing:
  - Center frequency: `6000 + (tone × 6000)` Hz (6-12 kHz range)
  - Q factor: 4.0 (high resonance for metallic ring)
- Alternative approach (if CPU too high): Ring modulation with 3 oscillators

---

### Voice Choking Logic

**Algorithm:** State-based voice stopping

**Implementation notes:**
- Open hat voice has `isPlaying` flag (atomic or bool)
- When closed hat triggers:
  1. Set open hat `isPlaying = false`
  2. Reset open hat envelope to zero
  3. Clear open hat oscillator phases
- Sample-accurate: Both notes in same buffer handled correctly
- Edge case: Simultaneous triggers → closed hat wins (choke processed first)

---

### Velocity Sensitivity

**Algorithm:** Linear velocity-to-gain mapping

**Implementation notes:**
- MIDI velocity range: 0-127 (uint8)
- Gain range: 0.0-1.0 (float)
- Mapping: `gain = velocity / 127.0f`
- Applied after envelope calculation: `output = envelope × gain × levelParam`
- No velocity curves (linear response, authentic 808 behavior)

---

### Per-Voice Tuning

**Algorithm:** Semitone-to-frequency-ratio conversion

**Implementation notes:**
- Semitone range: -12 to +12 (one octave down/up)
- Frequency ratio: `ratio = pow(2.0, semitones / 12.0)`
  - Example: +12 semitones = ratio 2.0 (one octave up)
  - Example: -12 semitones = ratio 0.5 (one octave down)
- Applied to base frequency: `tunedFreq = baseFreq × ratio`
- For clap/hats: Tunes bandpass filter center frequency (not oscillator frequency)

---

## Integration Points

### Feature Dependencies

- MIDI Note Router → All Voices: MIDI routing must happen first in processBlock
- Voice Choking → Open Hat Voice: Closed hat trigger must stop open hat before envelope starts
- Velocity Sensitivity → All Voices: Velocity extracted from MIDI message, applied to voice gain
- Per-Voice Tuning → All Voices: Tuning parameter affects base frequency before synthesis
- Multi-Output Routing → All Voices: Each voice writes to both main mix AND individual output

---

### Parameter Interactions

- No cross-voice parameter dependencies (all parameters are per-voice)
- Decay parameters: Independent per voice
- Tuning parameters: Independent per voice
- Level parameters: Independent per voice
- Tone parameters: Independent per voice (different meanings per voice type)
- Simplicity: Each voice is fully independent except for choking logic

---

### Processing Order Requirements

**Sequential processing order (REQUIRED):**

1. **MIDI Buffer Iteration:** Iterate all MIDI messages in buffer (chronological order)
   - Extract note number, velocity, sample position

2. **Note-to-Voice Mapping:** Map MIDI note number to voice index
   - Note 36 → Kick (voice 0)
   - Note 38 → Clap (voice 3)
   - Note 41 → Low Tom (voice 1)
   - Note 45 → Mid Tom (voice 2)
   - Note 42 → Closed Hat (voice 4)
   - Note 46 → Open Hat (voice 5)

3. **Voice Choking Check:** If closed hat triggered, stop open hat FIRST
   - Prevents click from open hat abrupt stop
   - Happens before closed hat envelope starts

4. **Voice Trigger:** Start appropriate voice synthesis
   - Calculate tuned base frequency from tuning parameter
   - Reset oscillator phases to zero (avoid clicks)
   - Reset envelope state to attack phase
   - Store velocity gain for this trigger

5. **Voice Synthesis (all voices in parallel):**
   - Generate waveform (oscillators + envelopes)
   - Apply velocity scaling
   - Apply level parameter

6. **Output Routing:**
   - Write each voice to main mix output (bus 0, accumulate/sum)
   - Write each voice to individual output (bus 1-6, isolated)

**Why order matters:**
- MIDI first: Host delivers MIDI in chronological order, must process before synthesis
- Choking before trigger: Prevents open hat playing during closed hat attack (authentic behavior)
- Tuning before synthesis: Base frequency must be calculated before oscillator phase increment
- Parallel synthesis: No inter-voice dependencies (except choking), all voices can process simultaneously

---

### Thread Boundaries

**Threads:**
- **Audio thread:** Real-time processing in processBlock() - NO allocations, NO locks
- **Message thread:** UI interactions, parameter changes from host automation
- **No background thread needed:** No file I/O, no long operations

**Audio thread:**
- MIDI message processing
- All voice synthesis (oscillators, envelopes, filters)
- Parameter reads via `APVTS::getRawParameterValue()->load()` (atomic)
- Output routing to multiple buses
- Voice choking state checks/updates

**Message thread:**
- Parameter updates from UI/host automation via APVTS (atomic writes)
- Preset loading/saving
- UI repaints (trigger LED animations)

**Communication:**
- APVTS parameters: Atomic reads (audio thread) / atomic writes (message thread)
- Voice trigger LEDs: Atomic flags per voice (audio thread sets, message thread reads)
- No custom thread communication needed (APVTS + atomic flags sufficient)

---

## Implementation Risks

### Bridged-T Oscillator Emulation

**Complexity:** MEDIUM
- Custom exponential envelope implementation
- Pitch envelope requires careful tuning

**Risk Level:** MEDIUM

**Risk factors:**
- No built-in JUCE class for bridged-T (custom implementation required)
- May not sound "808 enough" without careful tuning of decay constants
- Pitch envelope sweep range affects character (too much = cartoon, too little = dull)

**Alternative approaches:**
1. **Damped sine wave (RECOMMENDED):**
   - Sine oscillator × exponential decay
   - Pitch envelope: freq(t) = baseFreq × (1 + exp(-t/τ))
   - Simpler, less CPU, good approximation
2. **Self-oscillating bandpass filter:**
   - StateVariableTPTFilter with high resonance
   - More authentic but complex to tune
   - Higher CPU cost

**Fallback architecture:**
- If bridged-T emulation doesn't sound authentic → Use simple damped sine with pitch envelope (90% of character)
- If pitch envelope problematic → Use fixed-frequency sine with amplitude envelope only (simpler, still recognizable as 808-ish kick)

**Mitigation strategy:**
- Start with damped sine + pitch envelope (approach 1)
- Test against reference 808 samples
- Tune decay constants empirically (pitch decay ~20ms, amplitude decay parameter-driven)
- Document tuning rationale for future adjustments

---

### Clap Multi-Trigger Envelope

**Complexity:** MEDIUM
- Multiple envelope spikes require state machine
- Timing must be sample-rate independent

**Risk Level:** MEDIUM

**Risk factors:**
- No JUCE class for multi-spike envelopes (custom implementation required)
- Spike timing critical for authentic clap sound (10ms spacing from research)
- Timing drift at different sample rates if not implemented carefully
- State machine complexity (4 states: spike1, spike2, spike3, decay)

**Alternative approaches:**
1. **State machine with fixed timing (RECOMMENDED):**
   - 4 states, transitions at exact sample positions
   - Sample-rate independent: `transitionSample = sampleRate × 0.01` for 10ms
2. **Lookup table envelope:**
   - Pre-generate envelope shape at init
   - Index into table during playback
   - Lower CPU, more memory, less flexible

**Fallback architecture:**
- If multi-spike envelope too complex → Use single-spike envelope with long decay (simpler, loses "clap" character but still percussive)
- If timing drift occurs → Pre-calculate all transition samples in prepareToPlay(), use as constants

**Mitigation strategy:**
- Implement state machine carefully with sample-accurate transitions
- Test at multiple sample rates (44.1kHz, 48kHz, 96kHz, 192kHz)
- Verify 10ms spacing is consistent across sample rates
- Consider lookup table fallback if state machine proves buggy

---

### Multi-Output Routing (7 Stereo Buses)

**Complexity:** MEDIUM
- BusesProperties configuration straightforward
- Output buffer management requires careful indexing
- DAW compatibility testing time-consuming

**Risk Level:** MEDIUM

**Risk factors:**
1. Not all DAWs support >2 outputs (compatibility issue)
2. BusesProperties MUST be in constructor (common mistake → crash, see juce8-critical-patterns.md Pattern 4)
3. Buffer indexing errors can cause crashes or silent outputs
4. Some DAWs limit output count (e.g., <14 channels)

**Alternative approaches:**
1. **Main stereo output only:**
   - Complexity: LOW
   - Functionality: Internal mixing of all voices
   - Limitation: No per-voice routing in DAW
   - Best for: Maximum compatibility
2. **User-selectable output count:**
   - Complexity: MEDIUM
   - Options: 2/14 outputs (user setting in plugin)
   - Benefit: User chooses compatibility vs routing flexibility
   - Implementation: BusesProperties based on config (requires restart)

**Fallback architecture:**
- **Primary:** 14 outputs (main + 6 stereos)
- **Fallback 1:** If 14 outputs fail DAW compatibility → Main stereo only with internal mixing
- **Condition:** Fall back if user reports crashes or silent outputs in specific DAW

**Mitigation strategy:**
1. Check `juce8-critical-patterns.md` Pattern 4 for BusesProperties gotchas (constructor timing)
2. Test with multiple DAWs early (Logic Pro, Ableton, FL Studio, Reaper)
3. Implement buffer indexing with bounds checking (debug builds)
4. Document DAW compatibility in user manual (which DAWs support 14 outputs)
5. Graceful degradation: If individual outputs disabled, all audio routes to main (no crash)

---

### Six-Oscillator Hi-Hat Synthesis

**Complexity:** MEDIUM
- Managing 6 oscillators per hat voice (12 total for closed + open)
- Inharmonic tuning ratios must be exact

**Risk Level:** LOW

**Risk factors:**
- CPU cost: 12 oscillators (6 closed + 6 open) may be expensive
- Slight detuning can drastically change metallic character
- No reference for "correct" ratios (808 hardware varies by unit)

**Alternative approaches:**
1. **Six juce::dsp::Oscillator instances (RECOMMENDED):**
   - Authentic to 808 hardware (literally has 6 oscillators)
   - Straightforward implementation
   - Higher CPU cost (~10-15% per voice)
2. **Ring modulation with 3 oscillators:**
   - 3 oscillators × ring mod = 6 frequency components
   - Lower CPU (~5-8% per voice)
   - Less authentic, harder to tune

**Fallback architecture:**
- If 6 oscillators too expensive → Use ring modulation with 3 oscillators (still metallic, lower CPU)
- If ring mod too complex → Use filtered noise (simpler, less metallic, still recognizable as hi-hat)

**Mitigation strategy:**
- Start with 6-oscillator approach (most authentic)
- Profile CPU usage early
- If CPU >60% for full plugin → Optimize oscillator mixing (SIMD, lookup tables)
- Document frequency ratios from research: {1.0, 1.4, 1.7, 2.1, 2.5, 3.0}

---

### Voice Choking Logic

**Complexity:** LOW
- Simple state tracking and flag checks

**Risk Level:** LOW

**Risk factors:**
- Edge case: Simultaneous closed + open hat triggers in same buffer
- Race condition if not implemented atomically
- Click artifacts if open hat not stopped cleanly

**Mitigation strategy:**
- Process closed hat BEFORE open hat in MIDI routing (deterministic order)
- Reset open hat envelope to zero (prevents click)
- Test edge case: MIDI notes at same sample position
- Use bool flag (no atomics needed, audio thread only)

---

### Overall Project Risk

**Overall complexity:** HIGH
- 6 distinct synthesis engines (MEDIUM each) + multi-output (MEDIUM) + voice choking (LOW)
- High complexity due to number of features, not individual feature difficulty

**Highest risk component:** Bridged-T Oscillator + Clap Multi-Trigger
- Bridged-T: No JUCE class, requires careful tuning (40% of risk)
- Clap multi-trigger: State machine complexity, timing critical (30% of risk)
- Multi-output: DAW compatibility testing (20% of risk)
- Hi-hats: CPU cost potential (10% of risk)

**Recommended approach:**
1. **Phase 1 - Foundation:** MIDI routing, multi-output bus setup, simple sine test voices (validate architecture)
2. **Phase 2 - Simple voices:** Low Tom + Mid Tom (bridged-T without pitch envelope, easier)
3. **Phase 3 - Complex voices:** Kick (bridged-T with pitch envelope), Hi-Hats (6 oscillators)
4. **Phase 4 - Clap:** Multi-trigger envelope (most algorithmically complex)
5. **Phase 5 - Choking:** Voice choking logic (simplest, last)

**Total estimated time:** 20-30 hours with careful testing

---

## Architecture Decisions

### Damped Sine Wave for Bridged-T Emulation

**Decision:** Use damped sine wave with exponential pitch envelope (not self-oscillating filter)

**Rationale:**
- Simpler to implement and tune than self-oscillating filter
- Lower CPU cost (~5% vs ~15% for resonant filter)
- Good approximation of bridged-T character (based on professional plugin research)
- Research shows professional plugins (D16 Nepheton, Sonic Charge MicroTonic) use this approach

**Alternatives considered:**
1. **Self-oscillating bandpass filter:**
   - Why rejected: Higher complexity, harder to tune, higher CPU cost
   - When to reconsider: If damped sine doesn't sound authentic enough
2. **Lookup table approach:**
   - Why rejected: Less flexible, harder to tune, same CPU as damped sine
   - When to reconsider: Never (no benefit over real-time calculation)

**Tradeoffs accepted:**
- **Authenticity vs simplicity:** Damped sine is approximation, not circuit model
  - Acceptable because: 90% of users can't distinguish, focus is musical utility not hardware exactness
- **Fixed algorithm:** Can't easily switch to different oscillator types
  - Acceptable because: 808 is 808, users expect specific sound

**When to revisit:**
- If A/B testing against reference 808 samples shows unacceptable difference
- If users request more authentic emulation

---

### State Machine for Clap Multi-Trigger

**Decision:** Use 4-state machine (spike1, spike2, spike3, decay) with sample-accurate transitions

**Rationale:**
- Sample-rate independent (transitions calculated in prepareToPlay)
- Clear, debuggable implementation (one state per envelope segment)
- Exact timing control (10ms spacing verified from research)
- Low CPU cost (state comparison + exponential calculation)

**Alternatives considered:**
1. **Lookup table envelope:**
   - Why rejected: Less flexible, requires memory, same CPU as real-time
   - When to reconsider: If state machine proves buggy or timing drifts
2. **Single envelope with conditional logic:**
   - Why rejected: Harder to read, more error-prone than state machine
   - When to reconsider: Never (state machine clearer)

**Tradeoffs accepted:**
- **State machine complexity:** 4 states requires careful transition logic
  - Acceptable because: Well-defined state transitions, no complex conditionals
- **Sample-accurate timing:** Requires prepareToPlay recalculation on sample rate change
  - Acceptable because: One-time cost, sample rate rarely changes mid-session

**When to revisit:**
- If timing drift observed at different sample rates
- If state transitions cause clicks or artifacts

---

### Six Oscillators for Hi-Hats

**Decision:** Use 6 separate `juce::dsp::Oscillator<float>` instances (not ring modulation)

**Rationale:**
- Authentic to 808 hardware (literally has 6 oscillators)
- Frequency ratios {1.0, 1.4, 1.7, 2.1, 2.5, 3.0} documented in research
- JUCE Oscillator class is optimized (low CPU per instance)
- Easier to tune and debug than ring modulation

**Alternatives considered:**
1. **Ring modulation with 3 oscillators:**
   - Why rejected: Less authentic, harder to tune ratios, marginal CPU savings
   - When to reconsider: If CPU profiling shows 6 oscillators >60% total plugin CPU
2. **Filtered noise:**
   - Why rejected: Doesn't create metallic character, not 808-like
   - When to reconsider: As fallback if oscillator approach fails

**Tradeoffs accepted:**
- **Higher CPU cost:** 12 oscillators (6 closed + 6 open) vs 6 with ring mod
  - Acceptable because: Modern CPUs can handle this, target is studio use not real-time performance
- **More voices to manage:** 12 oscillators requires careful mixing and phase management
  - Acceptable because: JUCE Oscillator class handles phase automatically

**When to revisit:**
- If CPU profiling shows >60% total plugin CPU
- If users report performance issues on older hardware

---

### 7 Stereo Buses for Multi-Output

**Decision:** Implement 14 outputs (main + 6 individual stereos) from start

**Rationale:**
- Professional drum samplers offer per-voice routing (Battery, Kontakt, MPC)
- Mix engineers expect individual outputs for processing flexibility
- JUCE supports multi-output via BusesProperties (standard pattern, well-documented)
- Target DAWs (Logic Pro, Ableton) support 14+ outputs

**Alternatives considered:**
1. **Main stereo output only:**
   - Why rejected: Reduces plugin value (no routing flexibility), not competitive
   - When to reconsider: If multi-output causes significant compatibility issues
2. **User-selectable output count (2/14):**
   - Why rejected: Adds UI complexity, most users want all outputs available
   - When to reconsider: If DAW compatibility proves problematic

**Tradeoffs accepted:**
- **DAW compatibility:** Not all DAWs support >2 outputs
  - Mitigation: Graceful fallback to main output, document compatibility in manual
- **Increased complexity:** Managing 7 buses vs 1 bus
  - Acceptable because: BusesProperties pattern well-documented, one-time setup cost
- **Buffer management:** Routing to 14 channels requires careful indexing
  - Mitigation: Bounds checking in debug builds, unit tests for output routing

**When to revisit:**
- If >20% of users report crashes with multi-output
- If specific DAW has hard limit <14 outputs (fall back to main output only)

---

## Special Considerations

### Thread Safety

- All parameter reads use `APVTS::getRawParameterValue()->load()` (atomic)
- Voice trigger flags: Per-voice atomic bools for UI trigger LED updates
- No shared state between voices (except open hat choking flag)
- MIDI processing happens entirely on audio thread (no cross-thread communication)
- UI trigger LEDs read atomic flags on timer callback (message thread)

### Performance

- Estimated CPU usage per component:
  - Kick voice: ~8% (2 oscillators + 2 envelopes)
  - Tom voices (×2): ~6% each (1 oscillator + 1 filter + 1 envelope)
  - Clap voice: ~10% (noise + bandpass filter + complex envelope)
  - Hi-hat voices (×2): ~15% each (6 oscillators + 1 filter + 1 envelope)
  - MIDI routing: <1%
  - Multi-output routing: <1%
  - **Total estimated:** ~60% single core at 48kHz (high but acceptable)
- Optimization opportunities:
  - SIMD for oscillator mixing (hi-hats)
  - Lookup tables for exponential envelopes
  - Buffer size insensitive (all processing per-sample)

### Denormal Protection

- Use `juce::ScopedNoDenormals` in processBlock()
- All JUCE DSP components handle denormals internally
- Custom exponential envelopes: Add denormal threshold (output = 0 if envelope < 1e-8)
- Oscillator phase wrapping prevents denormals

### Sample Rate Handling

- All voices reinitialized in prepareToPlay() with new sample rate
- Clap envelope state transitions recalculated: `spike2Samples = sampleRate × 0.01` (10ms)
- Oscillator phase increments: `phaseIncrement = (freq × 2π) / sampleRate`
- Filter coefficients recalculated on sample rate change (JUCE StateVariableTPTFilter handles this)
- Maximum expected sample rate: 192kHz (all voices tested at this rate)

### Latency

- Zero latency (no lookahead, no FFT, no algorithmic delay)
- All processing is sample-accurate MIDI triggering
- Report via `getLatencySamples()`: return 0

---

## Research References

### Professional Plugins

1. **Roland TR-808 (Hardware Reference)**
   - Original analog drum machine (circuit analysis)
   - Bridged-T oscillator: Self-oscillating notch filter with feedback
   - Clap: 4 envelope spikes, 10ms apart (verified from service manual)
   - Hi-hats: 6 square wave oscillators, inharmonic tuning

2. **D16 Nepheton**
   - Modern 808 emulation (circuit-accurate)
   - Individual outputs per voice
   - Damped sine wave approach for kick/toms (not circuit modeling)
   - Observed: Exponential pitch envelope critical for kick character

3. **Sonic Charge MicroTonic**
   - Flexible drum synthesis with 808-inspired voices
   - Parametric envelope design (adjustable decay curves)
   - Noted: Simple algorithms can achieve 808 character with careful tuning

4. **AudioKit Drum Synth**
   - Open-source 808 implementation
   - Bridged-T implemented as damped sine with pitch envelope
   - Clap uses multi-trigger approach (3 spikes confirmed)

### JUCE Documentation

- **juce::dsp::Oscillator<T>**: Configurable oscillator (sine, square, saw, triangle)
  - Module: juce_dsp
  - Supports setFrequency() and processSample() for per-sample synthesis
- **juce::dsp::StateVariableTPTFilter<T>**: Modern state variable filter
  - Module: juce_dsp
  - Supports bandpass mode with resonance control (Q parameter)
  - TPT (Topology-Preserving Transform) prevents instability at high resonance
- **juce::MidiBuffer / juce::MidiMessage**: MIDI event handling
  - Module: juce_audio_basics
  - Iterator pattern for chronological MIDI processing
- **juce::AudioProcessor BusesProperties**: Multi-output bus configuration
  - Module: juce_audio_processors
  - CRITICAL: Must be in constructor initializer list (juce8-critical-patterns.md Pattern 4)

### Technical Resources

- **"Baratatronix 808 Tom Synthesis" blog post:** Bridged-T circuit analysis and digital emulation
- **"Roland TR-808 Clap Synthesis" (Cascadia):** Multi-trigger envelope timing (10ms spacing, 4 spikes)
- **"Roland TR-808 Cymbal & Hi-Hat Synthesis":** Six-oscillator architecture with frequency ratios
- **KVR DSP Forum - "TR 808 kick drum - modelling bridged-t":** Discussion of damped sine vs self-oscillating filter approaches
- **JUCE Forum - Multi-output bus configuration:** BusesProperties constructor timing gotcha

---

## Notes

- Kick pitch envelope decay time fixed at 20ms (not user parameter, based on research)
- Clap spike spacing fixed at 10ms (authentic 808 timing from service manual)
- Hi-hat frequency ratios {1.0, 1.4, 1.7, 2.1, 2.5, 3.0} based on Baratatronix research
- Voice choking processes closed hat BEFORE open hat to ensure deterministic behavior
- Multi-output buses: Main (true) = enabled by default, Individual (false) = optional/auxiliary
- No external dependencies (all synthesis using JUCE built-in classes or simple custom code)
- Module dependencies: juce_dsp (oscillators, filters), juce_audio_processors (APVTS, bus config), juce_gui_extra (WebView UI)
