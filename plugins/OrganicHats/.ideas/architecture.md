# DSP Architecture: OrganicHats

**CRITICAL CONTRACT:** This specification is immutable during Stages 2-5 implementation. Stage 1 Planning cannot proceed without this file. Stage 4 (DSP) implements this exact architecture.

**Generated by:** Stage 0 Research
**Referenced by:** Stage 1 (Planning), Stage 4 (DSP Implementation)
**Purpose:** DSP specification defining processing components, signal flow, and JUCE module usage

---

## Core Components

### Noise Generator
- **JUCE Class:** `juce::Random`
- **Purpose:** Generate white noise as the foundation for hi-hat synthesis
- **Parameters Affected:** None (always active when voice is triggered)
- **Configuration:**
  - Use instance-level Random object (NOT getSystemRandom() - thread safety)
  - Generate values via `nextFloat()` → range [0.0, 1.0]
  - Scale to bipolar: `(nextFloat() * 2.0f) - 1.0f` → range [-1.0, 1.0]
  - Static noise generation (no random seed variation per hit)

### Tone Filter (Brightness Control)
- **JUCE Class:** `juce::dsp::IIR::Filter<float>` (2nd order Butterworth)
- **Purpose:** Control brightness via high-pass/low-pass filtering
- **Parameters Affected:** CLOSED_TONE, OPEN_TONE
- **Configuration:**
  - Tone 0% → Low-pass at 3kHz (dark, closed sound)
  - Tone 50% → Band-pass at 8kHz (neutral brightness)
  - Tone 100% → High-pass at 15kHz (bright, crisp sound)
  - Exponential frequency mapping for musical response
  - Formula: `freq = 3000.0 * pow(5.0, toneValue)` where toneValue is 0.0-1.0
  - Q factor: 0.707 (Butterworth, no resonance)

### Noise Color Filter (Warmth Control)
- **JUCE Class:** `juce::dsp::IIR::Filter<float>` (2nd order Butterworth)
- **Purpose:** Shape noise character from warm to bright
- **Parameters Affected:** CLOSED_NOISE_COLOR, OPEN_NOISE_COLOR
- **Configuration:**
  - Noise Color 0% → Additional low-pass at 5kHz (warm, rounded)
  - Noise Color 50% → Flat response (bypass)
  - Noise Color 100% → Additional high-pass at 10kHz (bright, crisp)
  - Exponential frequency mapping
  - Formula: `freq = 5000.0 * pow(2.0, (noiseColorValue - 0.5) * 2.0)`
  - Q factor: 0.707 (Butterworth)

### Resonators (Body/Character)
- **JUCE Class:** `juce::dsp::IIR::Filter<float>` (2nd order resonant peak)
- **Purpose:** Add fixed resonance peaks for organic body and warmth
- **Parameters Affected:** None (fixed tuning)
- **Configuration:**
  - Three resonant peaks: 7kHz, 10kHz, 13kHz (hi-hat harmonics)
  - Q factor: 3.0-5.0 (moderate resonance for organic body)
  - Fixed gain: -6dB per peak (subtle enhancement)
  - Peaks tuned to create warm, non-metallic character

### Envelope Generator (Closed Hi-Hat)
- **JUCE Class:** `juce::ADSR`
- **Purpose:** Shape amplitude envelope for closed hi-hat
- **Parameters Affected:** CLOSED_DECAY
- **Configuration:**
  - Attack: 0.1ms (instant transient)
  - Decay: 20-200ms (mapped from CLOSED_DECAY parameter)
  - Sustain: 0.0 (no sustain - percussive envelope)
  - Release: 5ms (immediate stop on note-off)
  - Linear decay curve

### Envelope Generator (Open Hi-Hat)
- **JUCE Class:** `juce::ADSR`
- **Purpose:** Shape amplitude envelope for open hi-hat
- **Parameters Affected:** OPEN_RELEASE
- **Configuration:**
  - Attack: 0.1ms (instant transient)
  - Decay: 0ms (no decay - sustain immediately)
  - Sustain: 1.0 (hold at full level)
  - Release: 100-1000ms (mapped from OPEN_RELEASE parameter)
  - Linear release curve

### Velocity Processor
- **JUCE Class:** Custom implementation
- **Purpose:** Apply velocity sensitivity to volume and tone
- **Parameters Affected:** None (always enabled)
- **Configuration:**
  - Volume scaling: `velocityGain = velocity / 127.0` (linear)
  - Tone scaling: `velocityToneMod = (velocity / 127.0) * 0.3` (±30% filter cutoff shift)
  - Apply to both closed and open hi-hats
  - Velocity affects filter cutoff: brighter tone at higher velocity

### Choke Logic
- **JUCE Class:** Custom implementation
- **Purpose:** Instant cutoff of open hi-hat when closed hi-hat is triggered
- **Parameters Affected:** None (automatic behavior)
- **Configuration:**
  - Closed hi-hat note triggers choke mechanism
  - Open hi-hat voice envelope forced to release phase (<5ms cutoff)
  - Choke applies only when open voice is active
  - No choke if open voice is already silent

---

## Processing Chain

### Per-Voice Signal Flow

```
MIDI Note In (C1 = Closed, D1 = Open)
  ↓
Velocity Capture → velocityGain, velocityToneMod
  ↓
Noise Generator (juce::Random, static white noise)
  ↓
Tone Filter (Butterworth HP/LP) ← TONE parameter + velocity modulation
  ↓
Noise Color Filter (Butterworth HP/LP) ← NOISE_COLOR parameter
  ↓
Resonators (3x resonant peaks at 7kHz, 10kHz, 13kHz)
  ↓
Envelope Generator ← DECAY (closed) or RELEASE (open)
  ↓
Volume Scaling ← velocityGain
  ↓
Output (stereo summed with other active voices)
```

### Choke Routing

```
Closed Hi-Hat Trigger (MIDI Note C1)
  ↓
Check if Open Hi-Hat voice is active
  ↓ (yes)
Force Open Hi-Hat envelope to release phase (<5ms)
  ↓
Start Closed Hi-Hat voice normally
```

### MIDI Note Assignment
- C1 (MIDI note 36) → Closed Hi-Hat
- D1 (MIDI note 38) → Open Hi-Hat

**Routing notes:**
- Separate voice instances for closed and open hi-hats
- No shared state between voices (thread-safe)
- Choke logic operates on voice state, not signal path
- Maximum polyphony: 16 voices (8 closed + 8 open typical use)

---

## Parameter Mapping

| Parameter ID | Type | Range | DSP Component | Usage |
|-------------|------|-------|---------------|-------|
| CLOSED_TONE | Float | 0-100% | Tone Filter (Closed) | Maps to filter cutoff (3kHz-15kHz exponential) |
| CLOSED_DECAY | Float | 20-200ms | Envelope (Closed) | Maps to ADSR decay time (linear) |
| CLOSED_NOISE_COLOR | Float | 0-100% | Noise Color Filter (Closed) | Maps to filter cutoff (5kHz-10kHz exponential) |
| OPEN_TONE | Float | 0-100% | Tone Filter (Open) | Maps to filter cutoff (3kHz-15kHz exponential) |
| OPEN_RELEASE | Float | 100-1000ms | Envelope (Open) | Maps to ADSR release time (linear) |
| OPEN_NOISE_COLOR | Float | 0-100% | Noise Color Filter (Open) | Maps to filter cutoff (5kHz-10kHz exponential) |

---

## Algorithm Details

### Noise Generator

**Algorithm:** White noise generation using JUCE Random class

**Implementation notes:**
- Create instance-level `juce::Random noiseGenerator;` (per voice or global)
- Generate per-sample: `float sample = (noiseGenerator.nextFloat() * 2.0f) - 1.0f;`
- No random seed variation per hit (static, predictable output)
- Thread-safe: avoid `Random::getSystemRandom()` on audio thread

### Tone Filter (Brightness)

**Algorithm:** 2nd order Butterworth IIR filter (HP/LP)

**Implementation notes:**
- Exponential frequency mapping: `freq = 3000.0 * pow(5.0, toneValue)`
  - toneValue 0.0 → 3kHz LP (dark)
  - toneValue 0.5 → 8kHz BP (neutral)
  - toneValue 1.0 → 15kHz HP (bright)
- Coefficient calculation: `juce::dsp::IIR::Coefficients<float>::makeLowPass()` or `makeHighPass()`
- Update coefficients on parameter change (audio thread safe)
- Q = 0.707 (Butterworth response)

### Noise Color Filter (Warmth)

**Algorithm:** 2nd order Butterworth IIR filter (HP/LP)

**Implementation notes:**
- Exponential frequency mapping: `freq = 5000.0 * pow(2.0, (noiseColorValue - 0.5) * 2.0)`
  - noiseColorValue 0.0 → 5kHz LP (warm)
  - noiseColorValue 0.5 → Bypass (flat)
  - noiseColorValue 1.0 → 10kHz HP (bright)
- Bypass zone at 50% ±2% (0.48-0.52) to avoid clicking
- Coefficient update on parameter change
- Q = 0.707

### Resonators

**Algorithm:** Three parallel 2nd order resonant peak filters

**Implementation notes:**
- Peak frequencies: 7kHz, 10kHz, 13kHz (fixed, no parameter control)
- Q factor: 3.0-5.0 (moderate resonance)
- Gain: -6dB per peak (subtle enhancement)
- Coefficients: `juce::dsp::IIR::Coefficients<float>::makePeakFilter(sampleRate, freq, Q, gain)`
- Initialize in prepareToPlay(), no runtime updates

### Envelope Generators

**Algorithm:** ADSR envelope with linear segments

**Implementation notes:**
- Closed Hi-Hat:
  - `adsrClosed.setParameters({0.0001f, decayValue, 0.0f, 0.005f});`
  - Attack 0.1ms, Decay 20-200ms (parameter), Sustain 0.0, Release 5ms
- Open Hi-Hat:
  - `adsrOpen.setParameters({0.0001f, 0.0f, 1.0f, releaseValue});`
  - Attack 0.1ms, Decay 0ms, Sustain 1.0, Release 100-1000ms (parameter)
- Update parameters on parameter change (audio thread safe)
- Use `adsr.getNextSample()` per sample or `adsr.applyEnvelopeToBuffer()` per block

### Velocity Processor

**Algorithm:** Linear velocity scaling for volume and tone

**Implementation notes:**
- Volume scaling: `velocityGain = midiVelocity / 127.0f` (0.0-1.0)
- Tone modulation: `velocityToneMod = velocityGain * 0.3f` (0.0-0.3)
- Apply tone modulation: `finalCutoff = baseCutoff * (1.0f + velocityToneMod)`
- Brighter tone at higher velocity (up to +30% cutoff increase)
- Apply velocity gain after envelope in signal chain

### Choke Logic

**Algorithm:** State-based voice cutoff

**Implementation notes:**
- On closed hi-hat note-on: check if any open hi-hat voice is active
- If active: force open voice ADSR to release phase with 5ms release time
- Implementation: `adsrOpen.noteOff();` or set custom fast release
- Check voice state via `adsr.isActive()` or custom voice tracking
- No DSP processing required (state-only operation)

---

## Special Considerations

### Thread Safety
- All parameter reads use `getRawParameterValue()->load()` (atomic)
- Filter coefficient updates happen in audio thread (no allocations)
- ADSR parameters updated via atomic setParameters() call
- Per-voice Random instance (no shared state between voices)
- Choke logic operates on voice state (no mutex required)

### Performance
- Noise generation: ~1% CPU (lightweight)
- 2x Tone filters (HP/LP): ~5% CPU per voice
- 2x Noise Color filters: ~5% CPU per voice
- 3x Resonators: ~8% CPU per voice (parallel IIR filters)
- 2x ADSR envelopes: ~2% CPU per voice
- Total estimated: ~25% single core per voice at 48kHz
- Typical usage: 2-4 active voices → ~50-100% single core

### Denormal Protection
- Use `juce::ScopedNoDenormals` in processBlock()
- All JUCE DSP components handle denormals internally
- ADSR class handles denormals via internal clamping
- Random noise generation never produces denormals

### Sample Rate Handling
- All IIR filters recalculated in prepareToPlay() with new sample rate
- ADSR envelopes adapt to sample rate automatically via setSampleRate()
- Resonator peak frequencies scale with sample rate (coefficients recalculated)
- Envelope times (ms) remain constant across sample rates

### Latency
- Zero-latency processing (real-time synthesis)
- No lookahead or delay buffers required
- Report via getLatencySamples(): return 0

---

## Research References

### Professional Plugins

1. **XLN Audio Addictive Drums 2**
   - Hi-hat MIDI implementation: separate notes for closed/open
   - Velocity sensitivity: affects both volume and tone brightness
   - Observed: Industry standard uses CC for hi-hat openness (0-127)
   - Note: OrganicHats uses discrete notes (simpler MIDI model)

2. **Native Instruments Battery 4**
   - Hi-hat choke groups for realistic playback
   - Observed: <5ms choke time for instant cutoff
   - Velocity curves: linear to exponential scaling options

3. **Sonic Academy ANA 2 (for synthesis approach)**
   - Noise-based synthesis with multiple filter stages
   - Resonant filters for body and character
   - Observed: Fixed resonance peaks create organic warmth

4. **CR-78/808 Drum Machines (hardware reference)**
   - Classic hi-hat architecture: 6 detuned square waves → filters
   - OrganicHats simplifies to noise → dual filters → resonators
   - Observed: Metallic character requires inharmonic oscillators
   - Decision: Use noise + resonators for warm, non-metallic sound

### JUCE Documentation

- **juce::Random**: White noise generation with thread-safe instance-level usage
  - Key finding: Never use `Random::getSystemRandom()` on audio thread
  - Formula: `(nextFloat() * 2.0f) - 1.0f` for bipolar [-1.0, 1.0] range

- **juce::dsp::IIR::Filter**: Biquad filter with coefficient helpers
  - Butterworth: `makeLowPass()`, `makeHighPass()`, Q = 0.707
  - Resonant peak: `makePeakFilter(sampleRate, freq, Q, gain)`
  - Coefficients updated in audio thread (no allocations)

- **juce::ADSR**: Envelope generator with linear segments
  - Key finding: `setSampleRate()` required in prepareToPlay()
  - `setParameters()` safe to call from audio thread
  - `getNextSample()` or `applyEnvelopeToBuffer()` for rendering

- **juce::Synthesiser / SynthesiserVoice**: Polyphonic voice management
  - Built-in MIDI note routing and voice allocation
  - Velocity passed to startNote() as 0.0-1.0 float
  - Key finding: Per-voice state isolation (thread-safe)

### Technical Resources

- **"Synthesizing Hi-Hats with Web Audio" (joesul.li/van/synthesizing-hi-hats/)**
  - Hi-hat synthesis: white noise → resonant highpass → envelope
  - Resonance adds "ping" character
  - OrganicHats extends with dual filter stages + fixed resonators

- **"808 Hi-Hat Synthesis" (baratatronix.com)**
  - CR-78/808 architecture: 6 square waves (200-800Hz) → bandpass filters (10-18kHz)
  - Key finding: High-frequency filtering (10kHz+) for hi-hat character
  - OrganicHats uses 3kHz-15kHz range for warmer, less metallic sound

- **KVR Audio Forum: "Creating hi-hats with white noise"**
  - Community recommendation: bandpass filter + no attack + high sustain
  - OrganicHats adapts: dual filter stages (Tone + Noise Color) for flexibility

---

## Notes

- **Simplified 808 approach**: OrganicHats uses noise instead of 6 detuned oscillators for CPU efficiency and warmth
- **Dual filter stages**: Tone (brightness) + Noise Color (warmth) provide independent control over character
- **Fixed resonators**: Three resonant peaks (7kHz, 10kHz, 13kHz) tuned for organic body without harshness
- **Velocity-to-tone mapping**: Higher velocity → brighter tone (+30% cutoff max) for expressive playing
- **Choke implementation**: State-based (no signal processing) for <5ms cutoff latency
- **No global parameters**: Velocity sensitivity always enabled (creative brief decision)
- **Static noise**: No random seed variation per hit ensures consistent, predictable sound
- **Bypass zone**: Noise Color filter bypasses at 50% ±2% to avoid clicking when sweeping
